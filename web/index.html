<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Ficha de Associa√ß√£o - SESCON</title>
    
    <link rel="stylesheet" href="style.css" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Ficha de Associa√ß√£o</h1>
        <p style="color:red; font-weight:bold;">ATEN√á√ÉO: Este formul√°rio n√£o est√° salvo. Utilize a fun√ß√£o "Gerar PDF" ao finalizar.</p>

        <form id="fichaForm">
            <label>CNPJ</label>
            <input type="text" name="cnpj" placeholder="Somente n√∫meros" maxlength="14" required>

            <label>Raz√£o Social</label>
            <input type="text" name="razao" required readonly>

            <label>Endere√ßo Completo (Rua, N√∫mero, Complemento, Bairro, Cidade/UF, CEP)</label>
            <input type="text" name="endereco" readonly> 

            <label>E-mail</label>
            <input type="email" name="email" placeholder="contato@empresa.com" required>

            <label>Telefone/WhatsApp Principal</label>
            <input type="text" name="telefone" placeholder="(11) 9XXXX-XXXX" required>
            
            <label>Forma de Contato Preferencial</label>
            <select name="contato_preferencial" required>
                <option value="">Selecione</option>
                <option value="WhatsApp">WhatsApp (Telefone Principal)</option>
                <option value="Email">E-mail</option>
            </select>

            <label>Ramo de Atividade/Categoria Representada</label>
            <select name="segmento" required>
                <option value="">Selecione a Categoria</option>
            </select>

            <label>Plano Sugerido (Preenchimento Autom√°tico)</label>
            <input type="text" name="plano" required readonly> 
            <p id="plano-info" style="font-size: 0.9em;"></p>

            <label>Servi√ßos de Interesse (Selecione todos que se aplicam)</label>
            <div id="servicos-interesse-container" class="checkbox-group">
                </div>

            
            <label>S√≥cio/Respons√°vel Legal</label>
            <select id="socios-select" name="nome_socio" required>
                <option value="">Selecione o s√≥cio respons√°vel</option>
            </select>

            <label>
                <input type="checkbox" id="sou_socio_checkbox" checked> 
                Eu sou o s√≥cio/respons√°vel legal listado acima.
            </label>

            <div id="preenchedor_container" style="display:none; border: 1px solid #ddd; padding: 15px; margin-top: 15px;">
                <h4>Dados de quem est√° preenchendo</h4>
                <p style="font-size: 0.8em; color: gray;">
                    Ao enviar, voc√™ declara que o s√≥cio/respons√°vel legal listado acima concorda com os termos de associa√ß√£o.
                </p>
                <label>Nome Completo do Preenchedor</label>
                <input type="text" name="nome_preenchedor"> 
                <label>CPF do Preenchedor</label>
                <input type="text" name="cpf_preenchedor" placeholder="Somente 11 d√≠gitos">
            </div>

            <label>CPF do S√≥cio</label>
            <input type="text" name="cpf_socio" placeholder="Somente 11 d√≠gitos" required>

            <label>O s√≥cio possui registro ativo no CRC?</label>
            <select id="crc_socio_select" name="crc_socio" required>
                <option value="">Selecione</option>
                <option value="Sim">Sim</option>
                <option value="N√£o">N√£o</option>
            </select>
            <div id="crc_socio_container" style="display:none; margin-top: 10px;">
                <label>N√∫mero(s) de Registro do CRC do S√≥cio</label>
                <input type="text" name="crc_socio_numero" placeholder="Ex: SP-012345/O-0 (opcional se 'Sim')">
            </div>


            <label>Forma de Pagamento</label>
            <select name="forma_pagamento">
                <option value="Parcelado">Parcelado</option>
                <option value="√Ä vista">√Ä vista</option>
            </select>

            <label>
                <input type="checkbox" name="termo_aceite" value="1" required> 
                Declaro estar ciente e de acordo com os termos de associa√ß√£o. (Link para Termos pendente)
            </label>
            
            <p style="font-size: 0.8em; color: gray;">
                OBSERVA√á√ÉO DE RESPONSABILIDADE: Declaro que todas as informa√ß√µes prestadas s√£o de responsabilidade do associado/s√≥cio respons√°vel legal, nos termos do estatuto.
            </p>

            <h3>Assinatura (use mouse ou touch)</h3>
            <canvas id="signature-pad" width=600 height=200 style="border:1px solid #ccc;"></canvas>
            <div class="sig-buttons">
                <button type="button" id="clearBtn">Limpar Assinatura</button>
            </div>

            <button type="submit" id="sendBtn" disabled>Gerar PDF</button>
        </form>

        <div id="result" style="margin-top:20px;"></div>
        <a id="downloadLink" style="display:none">üì• Baixar PDF</a>
    </div>

<script>
    window.jsPDF = window.jspdf.jsPDF;

    // Dados da imagem do logo em Base64
    const SESCON_LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUsAAABjCAYAAAB2b44XAAAAAXNSR0IArs4c6QAAAK9JREFUeJzt3EEKgDAQRcGrw3Y8vP+5hE2Q2zS6+oD715x/nL9o8Wz9FwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAt+V878E4Jz3nOcfF551mX7XqW93uT/k4Jz9K+Xv92AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIC35Zz1pZ73pXy6L3e7v5Tf8vB/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIBf9vP9h1L5U8qfUt73UfI7zvsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAID3/R16vQMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsG936w5vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADg26f6OwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAd3/vXwMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgt1t5+wMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIB3/fXvAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHC3W3n7AwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP+E1/8HAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC4W3z+EwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAd4l/17sAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADA1/y/Q27xPw/Y7QkAAAAASUVORK5CYII=';

    // Armazenar o CNPJ formatado (com pontos) para uso no PDF
    let cnpjFormatadoGlobal = ''; 

    // --------------------------------------------------------------------------------
    // 1. LISTA DE SERVI√áOS E SEGMENTOS (ATUALIZADA)
    // --------------------------------------------------------------------------------
    const listaServicos = [
        { id: '343', nome: 'CENTRAL DE SERVI√áOS' },
        { id: '155', nome: 'CERTIFICA√á√ÉO DIGITAL' },
        { id: '347', nome: 'CERTIFICADO DIGITAL GRATUITO' },
        { id: '150', nome: 'BOLSA DE TALENTOS' },
        { id: '156', nome: 'CONT√ÅBIL STORE' },
        { id: '348', nome: 'CONTRIBUI√á√ÉO REPRESENTATIVA' },
        { id: '153', nome: 'CONSULTORIA JUR√çDICA - IOB TELEFONE' },
        { id: '358', nome: 'CONSULTORIA JUR√çDICA - IOB EXPLICA' },
        { id: '151', nome: 'CONVEN√á√ÉO COLETIVA' },
        { id: '166', nome: 'COWORKING' },
        { id: '152', nome: 'CURSOS UNISESCON' },
        { id: '165', nome: 'ENDERE√áO FISCAL' },
        { id: '154', nome: 'ER JUCESP - FATURADO' },
        { id: '161', nome: 'EVENTOS' },
        { id: '149', nome: 'INSTITUCIONAL' },
        { id: '306', nome: 'LOCA√á√ÉO DE AUDIT√ìRIO' },
        { id: '317', nome: 'PARCERIAS' },
        { id: '157', nome: 'PESQUISAS' },
        { id: '160', nome: 'PQEC' },
        { id: '159', nome: 'PROJETO LGPD' },
        { id: '342', nome: 'RECEITA FEDERAL' },
        { id: '158', nome: 'SOCIET√ÅRIO E LEGAL' },
    ];

    // Lista de Segmentos ATUALIZADA - 56 Categorias Representadas
    const listaSegmentos = [
        'Atividade de apoio √† produ√ß√£o florestal',
        'Servi√ßos de reboque de ve√≠culos',
        'Outras atividades auxiliares dos transportes terrestres n√£o especificadas anteriormente',
        'Opera√ß√£o dos aeroportos e campos de aterrissagem',
        'Organiza√ß√£o log√≠stica do transporte de carga',
        'Operador de transporte multimodal ‚Äì OTM',
        'Holdings de institui√ß√µes financeiras',
        'Holdings de institui√ß√µes n√£o-financeiras',
        'Outras sociedades de participa√ß√£o, exceto holdings',
        'Bolsa de valores',
        'Bolsa de mercadorias',
        'Bolsa de mercadorias e futuros',
        'Administra√ß√£o de mercados de balc√£o organizados',
        'Agentes de investimentos em aplica√ß√µes financeiras',
        'Administra√ß√£o de cart√µes de cr√©dito',
        'Correspond√™ntes de institui√ß√µes financeiras',
        'Representa√ß√£o de bancos estrangeiros',
        'Outras atividades auxiliares dos servi√ßos financeiros n√£o especificadas anteriormente',
        'Peritos e avaliadores de seguros',
        'Auditoria e consultoria atuarial',
        'Atividades auxiliares dos seguros, da previd√™ncia complementar e dos planos de sa√∫de n√£o especificadas anteriormente',
        'Atividades de administra√ß√£o de fundos por contrato ou comiss√£o',
        'Atividades auxiliares da justi√ßa: arbitragem, media√ß√£o, avalia√ß√µes per√≠cia.',
        'Agente de propriedade industrial',
        'Atividades de contabilidade',
        'Atividades de consultoria e auditoria cont√°bil e tribut√°ria',
        'Atividades de consultoria em gest√£o empresarial, exceto consultoria t√©cnica espec√≠fica',
        'Servi√ßos de cartografia, topografia e geod√©sia',
        'Atividades de estudos geol√≥gicos (prospec√ß√£o geol√≥gica)',
        'Servi√ßos de desenho t√©cnico relacionados √† arquitetura e engenharia',
        'Servi√ßos de per√≠cia t√©cnica relacionados √† seguran√ßa do trabalho',
        'Testes e an√°lises t√©cnicas ( ensaios de materiais e produtos , an√°lise de qualidade )',
        'Pesquisa e desenvolvimento experimental em ci√™ncias f√≠sicas e naturais',
        'Pesquisa e desenvolvimento experimental em ci√™ncias sociais e humanas',
        'Promo√ß√£o de Vendas',
        'Consultoria em publicidade',
        'Pesquisa de mercado e de opini√£o p√∫blica',
        'Atividades de produ√ß√£o de fotografias a√©reas e submarinas',
        'Servi√ßos de microfilmagem',
        'Servi√ßos de Tradu√ß√£o, Interpreta√ß√£o e Similares',
        'Servi√ßos de agronomia e de consultoria e de atividades agr√≠colas e pecu√°rias',
        'Atividades de intermedia√ß√£o e agenciamento de servi√ßos e neg√≥cios em geral, exceto imobili√°rios',
        'Agenciamento de profissionais para atividades esportivas, culturais e art√≠sticas',
        'Outras atividades profissionais, cient√≠ficas e t√©cnicas n√£o especificadas anteriormente',
        'Atividades de monitoramento de sistemas de seguran√ßa',
        'Servi√ßos combinados de escrit√≥rio e apoio administrativo',
        'Prepara√ß√£o de documentos e servi√ßos especializados de apoio administrativo n√£o especificados anteriormente.',
        'Outras atividades de servi√ßos prestados principalmente √†s empresas n√£o especificadas anteriormente',
        'Atividades de apoio √† educa√ß√£o, exceto caixas escolares',
        'Treinamento em desenvolvimento profissional e gerencial',
        'Atividades de apoio a gest√£o de sa√∫de (exceto servi√ßos privativos de m√©dicos)',
        'Atividades de organiza√ß√µes associativas patronais e empresariais',
        'Atividades de organiza√ß√µes associativas profissionais',
        'Atividades de associa√ß√µes de defesa de direitos sociais',
        'Atividades de organiza√ß√µes religiosas',
        'Atividades associativas n√£o especificadas anteriormente'
    ];
    
    function renderizarServicos() {
        const container = document.getElementById('servicos-interesse-container');
        let htmlContent = '';
        
        listaServicos.forEach(servico => {
            // O valor (value) do checkbox √© o nome do servi√ßo
            const value = servico.nome;
            
            htmlContent += `<label style="display:block; margin-bottom: 5px;">
                                <input type="checkbox" name="servicos_interesse" value="${value.toUpperCase()}"> 
                                ${servico.nome}
                            </label>`;
        });

        container.innerHTML = htmlContent;
    }

    function renderizarSegmentos() {
        const select = document.querySelector('select[name="segmento"]');
        listaSegmentos.forEach(segmento => {
            const option = document.createElement('option');
            option.value = segmento;
            option.textContent = segmento;
            select.appendChild(option);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderizarServicos();
        renderizarSegmentos();
        // Garante que a l√≥gica condicional √© executada no carregamento
        // para configurar corretamente os campos do preenchedor
        updatePreenchedorFields(document.getElementById('sou_socio_checkbox').checked);
        checkFormValidity();
    });


    // Vari√°veis para guardar dados do CNPJ para uso no PDF (evita re-busca no submit)
    let cnaeGlobal = '';
    let municipioGlobal = '';
    let ufGlobal = '';

    // --------------------------------------------------------------------------------
    // 2. L√ìGICA DE NEG√ìCIO E UTILIT√ÅRIOS
    // --------------------------------------------------------------------------------

    function formatCnpj(cnpj) {
        if (!cnpj) return '';
        // 00.000.000/0000-00
        return cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
    }

    function sanitizeCity(city) {
        if (!city) return "";
        return city
            .toLowerCase() 
            .normalize("NFD") 
            .replace(/[\u0300-\u036f]/g, "") 
            .replace(/[^a-z0-9\s]/g, "") 
            .trim(); 
    }
    // ... (restante da l√≥gica de CNAEs, Cidades e Segmenta√ß√£o - INALTERADA) ...
    const cnaes_ouro = new Set(["6920601", "6920602"]);
    const cnaes_prata = new Set([
        "0230600", "5229002", "5229099", "5240101", "5250804", "5250805", "6461100", "6462000", "6463800",
        "6611801", "6611802", "6611803", "6611804", "6612605", "6613400", "6619302", "6619303", "6619399",
        "6621501", "6621502", "6629100", "6630400", "6911702", "6911703", "7020400", "7119701", "7119702",
        "7119703", "7119704", "7120100", "7210000", "7220700", "7319004", "7319002", "7420002", "7420005",
        "7490101", "7490103", "7490104", "7490105", "7490199", "8020000", "8211300", "8219999", "8550302",
        "8599604", "8660700", "9411100", "9412000", "9430800", "9491000", "9499500" ,"8299799","7320300"
    ]);
    const cidades_tupa = new Set(["tupa", "arcoiris", "bastao", "herculandia", "ikanji", "marilia", "pompeia", "queiroz"]);
    const cidades_campinas = new Set(["campinas", "hortolandia", "sumare", "valinhos", "vinhedo", "jaguariuna", "paulinia", "itatiba", "indaiatuba", "amparo", "pedreira", "socorro", "aguas de lindoia", "monte alegre do sul", "serra negra", "holambra", "mogimirim", "mogiguacu", "artur nogueira", "nova odessa", "santa barbara doeste", "americana", "piracicaba", "limeira", "rio claro", "araras", "lemes"]);
    const cidades_santos = new Set(["santos", "sao vicente", "praia grande", "guaruja", "cubatao", "bertioga", "mongagua", "itanhaem", "peruibe", "cananeia", "ilhabela", "caraguatatuba", "ubatuba", "sao sebastiao"]);
    const prata_pricing = { 1: { total: 720.00, parcelas: 12, valor_parcela: 60.00, a_vista: 660.00 }, 2: { total: 660.00, parcelas: 11, valor_parcela: 60.00, a_vista: 607.00 }, 3: { total: 600.00, parcelas: 10, valor_parcela: 60.00, a_vista: 552.00 }, 4: { total: 540.00, parcelas: 9, valor_parcela: 60.00, a_vista: 497.00 }, 5: { total: 480.00, parcelas: 8, valor_parcela: 60.00, a_vista: 442.00 }, 6: { total: 420.00, parcelas: 7, valor_parcela: 60.00, a_vista: 386.00 }, 7: { total: 360.00, parcelas: 6, valor_parcela: 60.00, a_vista: 331.00 }, 8: { total: 300.00, parcelas: 5, valor_parcela: 60.00, a_vista: 276.00 }, 9: { total: 240.00, parcelas: 4, valor_parcela: 60.00, a_vista: 221.00 }, 10: { total: 180.00, parcelas: 3, valor_parcela: 60.00, a_vista: 166.00 }, 11: { total: 120.00, parcelas: 2, valor_parcela: 60.00, a_vista: 110.00 }, 12: { total: 60.00, parcelas: 1, valor_parcela: 60.00, a_vista: 60.00 } };
    const ouro_premium_pricing = { 1: { total: 1140.00, parcelas: 12, valor_parcela: 95.00, a_vista: 1046.00 }, 2: { total: 1045.00, parcelas: 11, valor_parcela: 95.00, a_vista: 961.00 }, 3: { total: 950.00, parcelas: 10, valor_parcela: 95.00, a_vista: 874.00 }, 4: { total: 855.00, parcelas: 9, valor_parcela: 95.00, a_vista: 787.00 }, 5: { total: 760.00, parcelas: 8, valor_parcela: 95.00, a_vista: 700.00 }, 6: { total: 665.00, parcelas: 7, valor_parcela: 95.00, a_vista: 611.00 }, 7: { total: 570.00, parcelas: 6, valor_parcela: 95.00, a_vista: 524.00 }, 8: { total: 475.00, parcelas: 5, valor_parcela: 95.00, a_vista: 437.00 }, 9: { total: 380.00, parcelas: 4, valor_parcela: 95.00, a_vista: 350.00 }, 10: { total: 285.00, parcelas: 3, valor_parcela: 95.00, a_vista: 263.00 }, 11: { total: 190.00, parcelas: 2, valor_parcela: 95.00, a_vista: 175.00 }, 12: { total: 95.00, parcelas: 1, valor_parcela: 95.00, a_vista: 95.00 } };
    const prata_aescon_pricing = { 1: { total: 420.00, parcelas: 12, valor_parcela: 35.00, a_vista: 386.00 }, 2: { total: 385.00, parcelas: 11, valor_parcela: 35.00, a_vista: 354.00 }, 3: { total: 350.00, parcelas: 10, valor_parcela: 35.00, a_vista: 322.00 }, 4: { total: 315.00, parcelas: 9, valor_parcela: 35.00, a_vista: 290.00 }, 5: { total: 280.00, parcelas: 8, valor_parcela: 35.00, a_vista: 258.00 }, 6: { total: 245.00, parcelas: 7, valor_parcela: 35.00, a_vista: 225.00 }, 7: { total: 210.00, parcelas: 6, valor_parcela: 35.00, a_vista: 193.00 }, 8: { total: 175.00, parcelas: 5, valor_parcela: 35.00, a_vista: 161.00 }, 9: { total: 140.00, parcelas: 4, valor_parcela: 35.00, a_vista: 129.00 }, 10: { total: 105.00, parcelas: 3, valor_parcela: 35.00, a_vista: 97.00 }, 11: { total: 70.00, parcelas: 2, valor_parcela: 35.00, a_vista: 65.00 }, 12: { total: 35.00, parcelas: 1, valor_parcela: 35.00, a_vista: 35.00 } };
    function segmentar(cnae, cidade, uf) {
        const cnae_str = String(cnae || '').trim();
        const cidade_limpa = sanitizeCity(cidade); 
        if (uf.toUpperCase() !== "SP") {
            return "Fora de SP ‚Äì N√£o podemos associar.";
        }
        let planoBase = null;
        if (cnaes_ouro.has(cnae_str)) { 
            planoBase = "Plano Ouro Premium";
        } else if (cnaes_prata.has(cnae_str)) { 
            planoBase = "Plano Prata";
        } else {
            return "CNAE fora do escopo. Contate Fecom√©rcio: (11) 3254-1700";
        }
        if (planoBase === "Plano Ouro Premium" && (cidades_tupa.has(cidade_limpa) || cidades_campinas.has(cidade_limpa) || cidades_santos.has(cidade_limpa))) {
            return "Prata Aescon";
        }
        if (cidades_tupa.has(cidade_limpa)) {
            return "Fora da regi√£o (Tup√£). E-mail: sescontupan@unisite.com.br";
        }
        if (cidades_campinas.has(cidade_limpa)) {
            return "Fora da regi√£o (Campinas). E-mail: sesconcampinas@sesconcampinas.org.br";
        }
        if (cidades_santos.has(cidade_limpa)) {
            return "Fora da regi√£o (Santos). E-mail: sheron@sesconbs.org.br";
        }
        return planoBase;
    }

    function getPlanoInfo(plano) {
        // CORRE√á√ÉO PARA ERRO DE PDF: Garante que 'plano' √© uma string para evitar 'Cannot read properties of undefined'
        const planoStr = plano || ''; 
        
        const mesAtual = new Date().getMonth() + 1;
        let tabela = {};
        
        if (planoStr.includes("Prata")) { 
            tabela = (planoStr === "Prata Aescon") ? prata_aescon_pricing : prata_pricing;
        } else if (planoStr.includes("Ouro")) {
            tabela = ouro_premium_pricing;
        } else {
            return { valor_a_vista: "N/A", valor_parcelado: "N/A", total: "N/A", valor_parcela: "N/A", parcelas: "N/A" };
        }

        const valores = tabela[mesAtual] || {};
        
        const aVista = valores.a_vista ? `R$ ${valores.a_vista.toFixed(2).replace('.', ',')}` : "N/A";
        const valorParcela = valores.valor_parcela ? `R$ ${valores.valor_parcela.toFixed(2).replace('.', ',')}` : "N/A";
        const valorTotalParcelado = valores.total ? `R$ ${valores.total.toFixed(2).replace('.', ',')}` : "N/A";
        const parcelas = valores.parcelas;

        const valorParceladoDisplay = parcelas && valorParcela ? `${parcelas}x de ${valorParcela} (Total: ${valorTotalParcelado})` : "N/A";

        return {
            valor_a_vista: aVista,
            valor_parcelado: valorParceladoDisplay,
            total: valorTotalParcelado, 
            valor_parcela: valorParcela,
            parcelas: parcelas
        };
    }
    
    // Fun√ß√£o para identificar o primeiro campo inv√°lido
    function getFirstInvalidField() {
        const requiredElements = form.querySelectorAll('[required]');
        for (const element of requiredElements) {
            // Verifica se o elemento est√° vis√≠vel e inv√°lido (excluindo os que est√£o hidden, mesmo que por CSS)
            if (element.required && !element.checkValidity()) {
                // Tenta pegar o texto do label ou retorna o nome do campo
                return element.labels && element.labels.length > 0 ? element.labels[0].textContent.trim() : element.name;
            }
        }
        return null;
    }


    // --------------------------------------------------------------------------------
    // 3. EVENTOS (CNPJ, Condicionais e Assinatura)
    // --------------------------------------------------------------------------------

    // Elementos do DOM
    const cnpjInput = document.querySelector('input[name="cnpj"]');
    const razaoInput = document.querySelector('input[name="razao"]');
    const enderecoInput = document.querySelector('input[name="endereco"]');
    const planoInput = document.querySelector('input[name="plano"]');
    const planoInfo = document.getElementById("plano-info");
    const sociosSelect = document.getElementById("socios-select");
    const sendBtn = document.getElementById("sendBtn");
    const resultDiv = document.getElementById("result");
    const form = document.getElementById("fichaForm");
    const canvas = document.getElementById("signature-pad");
    const ctx = canvas.getContext("2d");
    let drawing = false;
    let lastX = 0, lastY = 0;
    let hasSigned = false; // Flag para a assinatura
    const nomePreenchedor = document.querySelector('input[name="nome_preenchedor"]');
    const cpfPreenchedor = document.querySelector('input[name="cpf_preenchedor"]');
    const preenchedorContainer = document.getElementById('preenchedor_container');

    // OTIMIZA√á√ÉO: Novo nome para a fun√ß√£o de valida√ß√£o
    function checkFormValidity() {
        const planoSugerido = planoInput.value;
        // O form.checkValidity() agora √© seguro porque os campos do preenchedor
        // t√™m o atributo 'required' removido quando est√£o escondidos.
        const isFormValid = form.checkValidity(); 
        const isSigned = hasSigned; 
        
        // 1. Verifica a elegibilidade do Plano (CNPJ e Regi√£o)
        if (!planoSugerido || planoSugerido.includes('Fora') || planoSugerido.includes('CNAE fora')) {
            if (cnpjInput.value.length === 14 && razaoInput.value === '') {
                 planoInfo.innerHTML = '';
                 sendBtn.disabled = true;
                 resultDiv.textContent = '‚ùå CNPJ n√£o encontrado ou inv√°lido. Corrija o CNPJ.';
                 return;
            } else if (cnpjInput.value.length === 14) {
                 planoInfo.innerHTML = `<span style="color:red;font-weight:bold;">${planoSugerido || 'N/A'}</span>`;
                 sendBtn.disabled = true;
                 resultDiv.textContent = '‚ùå CNPJ n√£o eleg√≠vel ou fora da regi√£o. Verifique o campo "Plano Sugerido".';
                 return; 
            }
            planoInfo.innerHTML = '';
            sendBtn.disabled = true; 
            resultDiv.textContent = 'Digite 14 d√≠gitos do CNPJ para buscar os dados.';
            return;
        } 
        
        // Se o plano for v√°lido, mostra os valores
        const planoInfoData = getPlanoInfo(planoSugerido);
        planoInfo.textContent = `√Ä vista: ${planoInfoData.valor_a_vista}. Parcelado: ${planoInfoData.valor_parcelado}.`;

        // 2. Verifica a validade do Formul√°rio (todos os campos 'required') e Assinatura
        sendBtn.disabled = !(isFormValid && isSigned);

        // 3. Atualiza o Feedback para o usu√°rio
        if (sendBtn.disabled) {
            // Prioriza o feedback da assinatura se o form estiver OK
            if (isFormValid && !isSigned) {
                resultDiv.innerHTML = '‚ö†Ô∏è Por favor, fa√ßa a **Assinatura** no quadro acima para liberar o bot√£o.';
            } else if (!isFormValid) {
                // Caso contr√°rio, busca o primeiro campo faltando
                const firstMissing = getFirstInvalidField();
                if (firstMissing) {
                    // OTIMIZA√á√ÉO: Usa `reportValidity()` para marcar o campo no navegador
                    form.reportValidity(); 
                    resultDiv.innerHTML = `‚ö†Ô∏è Preencha o campo obrigat√≥rio: **"${firstMissing}"** para habilitar o PDF.`;
                } else {
                    resultDiv.textContent = `‚ö†Ô∏è Verifique todos os campos obrigat√≥rios (marcados com *).`;
                }
            }
        } else {
            resultDiv.textContent = '‚úÖ Todos os campos obrigat√≥rios preenchidos! Clique em "Gerar PDF" para finalizar.';
        }
    }


    // L√≥gica de Assinatura
    function drawLine(x1, y1, x2, y2) {
        ctx.beginPath();
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.lineJoin = 'round';
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
        ctx.closePath();
    }
    
    // Eventos de Assinatura
    canvas.addEventListener("mousedown", (e) => {
        drawing = true;
        hasSigned = true; // Marca que o usu√°rio come√ßou a desenhar
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    });
    canvas.addEventListener("mousemove", (e) => {
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        drawLine(lastX, lastY, x, y);
        lastX = x;
        lastY = y;
    });
    canvas.addEventListener("mouseup", () => {
        drawing = false;
        checkFormValidity(); // Revalida ap√≥s soltar o mouse (fim da assinatura)
    });
    canvas.addEventListener("mouseout", () => drawing = false);
    
    // Touch events
    canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        drawing = true;
        hasSigned = true; // Marca que o usu√°rio come√ßou a desenhar
        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];
        lastX = t.clientX - rect.left;
        lastY = t.clientY - rect.top;
    }, { passive: false });
    canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];
        const x = t.clientX - rect.left;
        const y = t.clientY - rect.top;
        drawLine(lastX, lastY, x, y);
        lastX = x;
        lastY = y;
    }, { passive: false });
    canvas.addEventListener("touchend", () => {
        drawing = false;
        checkFormValidity(); // Revalida ap√≥s o toque terminar
    });
    
    document.getElementById("clearBtn").addEventListener("click", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        hasSigned = false; // Reseta a flag
        checkFormValidity(); // Revalida ap√≥s limpar
    });


    // Evento de CNPJ
    cnpjInput.addEventListener('input', async () => {
        const cnpj = cnpjInput.value.replace(/\D/g, '');
        if (cnpj.length === 14) {
            resultDiv.textContent = 'Buscando dados do CNPJ...';
            sendBtn.disabled = true; 
            
            planoInput.value = '';
            planoInfo.textContent = '';
            sociosSelect.innerHTML = '<option value="">Selecione o s√≥cio respons√°vel</option>';
            razaoInput.value = '';
            enderecoInput.value = '';

            // Limpa dados globais
            cnaeGlobal = '';
            municipioGlobal = '';
            ufGlobal = '';
            cnpjFormatadoGlobal = formatCnpj(cnpj); // Armazena CNPJ formatado

            try {
                // Tenta usar a API do SESCON para dados cadastrais se for um endpoint exclusivo, 
                // mas a BrasilAPI (Receita Federal) √© mais confi√°vel para dados p√∫blicos
                const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
                const data = await response.json();
                
                if (response.ok) {
                    razaoInput.value = data.razao_social || '';
                    const complemento = data.complemento ? ` (${data.complemento})` : '';
                    enderecoInput.value = `${data.logradouro || ''}, ${data.numero || ''}${complemento}, ${data.bairro || ''} - ${data.municipio || ''}/${data.uf || ''} - CEP: ${data.cep || ''}`;
                    
                    // Armazena dados globais
                    cnaeGlobal = data.cnae_fiscal;
                    municipioGlobal = data.municipio;
                    ufGlobal = data.uf;

                    const municipioSanitizado = sanitizeCity(municipioGlobal);
                    
                    const planoSugerido = segmentar(cnaeGlobal, municipioSanitizado, ufGlobal);
                    planoInput.value = planoSugerido || '';
                    
                    checkFormValidity();

                    // Carrega os s√≥cios
                    if (data.qsa && data.qsa.length > 0) {
                        data.qsa.forEach(socio => {
                            const option = document.createElement('option');
                            option.value = socio.nome_socio;
                            option.textContent = socio.nome_socio;
                            sociosSelect.appendChild(option);
                        });
                    }
                    resultDiv.textContent = 'Dados carregados com sucesso.';
                } else {
                    resultDiv.textContent = `‚ùå Erro: CNPJ n√£o encontrado ou inv√°lido.`;
                    sendBtn.disabled = true;
                    razaoInput.value = '';
                    enderecoInput.value = '';
                    cnpjFormatadoGlobal = '';
                    checkFormValidity(); // Revalida com o erro
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå Erro na requisi√ß√£o: ${error.message}. Verifique sua conex√£o.`;
                sendBtn.disabled = true;
                checkFormValidity(); // Revalida com o erro
            }
        } else {
            resultDiv.textContent = 'Digite 14 d√≠gitos do CNPJ para buscar os dados.';
            sendBtn.disabled = true;
            cnpjFormatadoGlobal = '';
            checkFormValidity(); // Revalida
        }
    });
    
    // L√≥gica condicional para CRC do S√≥cio
    document.getElementById('crc_socio_select').addEventListener('change', function() {
        const container = document.getElementById('crc_socio_container');
        if (this.value === 'Sim') {
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
            // Limpa o valor para n√£o ir para o PDF se for 'N√£o'
            document.querySelector('input[name="crc_socio_numero"]').value = '';
        }
        // For√ßa a revalida√ß√£o do formul√°rio
        checkFormValidity();
    });

    // Fun√ß√£o para atualizar o estado dos campos do preenchedor
    function updatePreenchedorFields(isSocio) {
        if (!isSocio) {
            preenchedorContainer.style.display = 'block';
            nomePreenchedor.setAttribute('required', 'required'); // Adiciona required
            cpfPreenchedor.setAttribute('required', 'required'); // Adiciona required
        } else {
            preenchedorContainer.style.display = 'none';
            nomePreenchedor.removeAttribute('required'); // Remove required
            cpfPreenchedor.removeAttribute('required'); // Remove required
            // Limpa os valores para n√£o serem enviados e n√£o causarem falha de valida√ß√£o oculta
            nomePreenchedor.value = '';
            cpfPreenchedor.value = '';
        }
    }
    
    // L√≥gica condicional para Preenchedor (N√£o S√≥cio)
    document.getElementById('sou_socio_checkbox').addEventListener('change', function() {
        // CORRE√á√ÉO: Chama a fun√ß√£o dedicada
        updatePreenchedorFields(this.checked);
        // For√ßa a revalida√ß√£o do formul√°rio
        checkFormValidity();
    });

    // Garante que o bot√£o s√≥ habilita se o formul√°rio for v√°lido (para mudan√ßas manuais nos campos)
    form.addEventListener('change', checkFormValidity);


    // --------------------------------------------------------------------------------
    // 4. GERA√á√ÉO DO PDF 
    // --------------------------------------------------------------------------------

    form.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        resultDiv.textContent = 'Gerando PDF...';

        // Revalida√ß√£o final antes de gerar o PDF
        if (sendBtn.disabled || !form.checkValidity() || !hasSigned) {
            resultDiv.innerHTML = '‚ùå Preencha todos os campos obrigat√≥rios, assine e verifique a elegibilidade do CNPJ.';
            return;
        }

        const dados = {};
        const formData = new FormData(form);
        // Filtra apenas os checkboxes marcados para 'servicos_interesse'
        dados.servicos_interesse = [];
        for (let [key, value] of formData.entries()) {
            if (key === 'servicos_interesse') {
                dados.servicos_interesse.push(value);
            } else {
                dados[key] = value;
            }
        }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        let y = 20;
        const padding = 10;
        
        // Obter dados de pre√ßo e plano formatados
        const planoInfoData = getPlanoInfo(dados.plano);
        let valorAnuidade;
        let detalhesPagamento;

        if (dados.forma_pagamento === "√Ä vista") {
            valorAnuidade = planoInfoData.valor_a_vista;
            detalhesPagamento = `Modalidade: √Ä VISTA`;
        } else {
            valorAnuidade = planoInfoData.total;
            detalhesPagamento = `Modalidade: PARCELADO em ${planoInfoData.parcelas}x de ${planoInfoData.valor_parcela}`;
        }

        const associacao = dados.plano && dados.plano.toUpperCase().includes("AESCON") ? "AESCON-SP" : "SESCON-SP";
        const contribuicao = dados.plano === "Plano Ouro Premium" ? "(Inclui Contribui√ß√£o Representativa)" : "";

        // T√çTULO DO PDF (SEGMENTADO)
        const tituloPDF = `FICHA DE INSCRI√á√ÉO - ASSOCIA√á√ÉO ${associacao}`;


        // =========================================================================
        // CABE√áALHO E LOGO
        // =========================================================================
        try {
            pdf.addImage(SESCON_LOGO_BASE64, 'PNG', 150, 10, 50, 15);
            y = 30;
        } catch (e) { y = 20; }

        pdf.setFontSize(14);
        pdf.text(tituloPDF, padding, y); // T√≠tulo Din√¢mico
        y += 15;
        
        // =========================================================================
        // DADOS DA EMPRESA
        // =========================================================================
        pdf.setFontSize(12);
        pdf.setFont('helvetica', 'bold'); 
        pdf.text("DADOS DA EMPRESA", padding, y);
        pdf.setFont('helvetica', 'normal'); 
        y += 8;
        
        pdf.setFontSize(10);
        pdf.text(`RAZ√ÉO SOCIAL: ${dados.razao ? dados.razao.toUpperCase() : ''}`, padding, y); y += 5;
        // CNPJ com formata√ß√£o original
        pdf.text(`CNPJ: ${cnpjFormatadoGlobal || dados.cnpj || ''}`, padding, y); y += 5; 
        pdf.text(`ENDERE√áO COMPLETO: ${dados.endereco ? dados.endereco.toUpperCase() : ''}`, padding, y); y += 5;
        pdf.text(`E-MAIL: ${dados.email ? dados.email.toUpperCase() : ''}`, padding, y); y += 5;
        pdf.text(`TELEFONE/WHATSAPP PRINCIPAL: ${dados.telefone || ''}`, padding, y); y += 5;
        pdf.text(`CONTATO PREFERENCIAL: ${dados.contato_preferencial.toUpperCase()}`, padding, y); y += 5;
        // Segmento de Atua√ß√£o (Select)
        pdf.text(`RAMO DE ATIVIDADE/CATEGORIA REPRESENTADA: ${dados.segmento.toUpperCase()}`, padding, y); y += 5; 
        pdf.text(`CNAE PRINCIPAL (Receita Federal): ${cnaeGlobal || 'N/A'}`, padding, y); y += 8;
        
        // =========================================================================
        // PLANO SUGERIDO E PAGAMENTO - DESTAQUE
        // =========================================================================
        pdf.setFontSize(12);
        pdf.setFont('helvetica', 'bold'); 
        pdf.text("PLANO E VALORES (ANUIDADE PROPORCIONAL)", padding, y);
        pdf.setFont('helvetica', 'normal'); 
        y += 8;
        
        pdf.setFontSize(10);
        pdf.text(`PLANO: ${dados.plano ? dados.plano.toUpperCase() : ''} ${contribuicao}`, padding, y); y += 5;
        pdf.text(`ASSOCIA√á√ÉO: ${associacao}`, padding, y); y += 5;
        pdf.text(`VALOR TOTAL (ANUIDADE PROPORCIONAL): ${valorAnuidade}`, padding, y); y += 5;
        pdf.text(`CONDI√á√ÉO DE PAGAMENTO: ${detalhesPagamento}`, padding, y); y += 8;

        // OBSERVA√á√ïES DE ANUIDADE
        pdf.setFontSize(8);
        pdf.text("A anuidade informada refere-se ao valor PROPORCIONAL aos meses restantes do ano corrente.", padding, y); y += 4;
        pdf.text("No pr√≥ximo ciclo de renova√ß√£o, o valor ser√° referente √† anuidade integral.", padding, y); y += 10;
        
        // =========================================================================
        // SERVI√áOS DE INTERESSE
        // =========================================================================
        pdf.setFontSize(12);
        pdf.setFont('helvetica', 'bold'); 
        pdf.text("SERVI√áOS DE INTERESSE SELECIONADOS:", padding, y);
        pdf.setFont('helvetica', 'normal'); 
        y += 5;
        pdf.setFontSize(10);
        // Lista os servi√ßos selecionados
        const servicosSelecionados = (dados.servicos_interesse || []).join(', ');
        const splitText = pdf.splitTextToSize(servicosSelecionados || 'NENHUM SERVI√áO SELECIONADO', 180); 
        pdf.text(splitText, padding + 5, y); 
        y += splitText.length * 5 + 5; 

        
        // =========================================================================
        // DADOS DO S√ìCIO/RODAP√â
        // =========================================================================
        pdf.setFontSize(12);
        pdf.setFont('helvetica', 'bold'); 
        pdf.text("DADOS DO S√ìCIO/RESPONS√ÅVEL LEGAL", padding, y);
        pdf.setFont('helvetica', 'normal'); 
        y += 8;
        
        pdf.setFontSize(10);
        pdf.text(`NOME COMPLETO DO S√ìCIO: ${dados.nome_socio ? dados.nome_socio.toUpperCase() : ''}`, padding, y); y += 5;
        pdf.text(`CPF DO S√ìCIO: ${dados.cpf_socio || ''}`, padding, y); y += 5;
        
        let crcSocioTexto = `S√ìCIO POSSUI REGISTRO NO CRC? ${dados.crc_socio.toUpperCase()}`;
        if (dados.crc_socio === 'Sim' && dados.crc_socio_numero) {
            crcSocioTexto += ` (N√∫mero(s): ${dados.crc_socio_numero.toUpperCase()})`;
        }
        pdf.text(crcSocioTexto, padding, y); y += 5;

        // Dados de quem preencheu (se for diferente)
        if (dados.nome_preenchedor && dados.nome_preenchedor.trim() !== "") {
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'bold'); 
            pdf.text("DADOS DE QUEM PREENCHEU ESTE FORMUL√ÅRIO", padding, y);
            pdf.setFont('helvetica', 'normal'); 
            y += 8;
            pdf.setFontSize(10);
            pdf.text(`NOME DO PREENCHEDOR: ${dados.nome_preenchedor.toUpperCase()}`, padding, y); y += 5;
            pdf.text(`CPF DO PREENCHEDOR: ${dados.cpf_preenchedor || ''}`, padding, y); y += 5;
            // OBS: O s√≥cio est√° ciente, conforme checkbox e texto acima.
        }

        // Rodap√© de Dados
        pdf.text(`EMPRESA: ${dados.razao ? dados.razao.toUpperCase() : ''}`, padding, y); y += 4;
        const dataHora = new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        pdf.text(`DATA DO PREENCHIMENTO: ${dataHora}`, padding, y); y += 6;
        
        // OBSERVA√á√ÉO DE RESPONSABILIDADE
        pdf.setFontSize(8);
        pdf.text(`OBSERVA√á√ÉO DE RESPONSABILIDADE: Declaro que todas as informa√ß√µes prestadas s√£o de responsabilidade do associado/s√≥cio respons√°vel legal, nos termos do estatuto.`, padding, y); 
        y += 10;

        // ASSINATURA
        const signatureImage = canvas.toDataURL("image/png");
        if (signatureImage && signatureImage.length > "data:,".length) {
            pdf.addImage(signatureImage, 'PNG', padding, y + 5, 100, 30);
        }
        y += 45;
        pdf.text("________________________________", padding, y); y += 6;
        pdf.text("ASSINATURA DO S√ìCIO/RESPONS√ÅVEL LEGAL DA EMPRESA", padding, y);

        // Gera√ß√£o do arquivo
        const nomeArquivo = `Ficha_Inscricao_${(dados.razao || '').replace(/[^a-zA-Z0-9]/g, '_')}_${(dados.cnpj || '').replace(/\D/g, '')}.pdf`;
        const blob = new Blob([pdf.output('arraybuffer')], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const link = document.getElementById("downloadLink");
        link.href = url;
        link.download = nomeArquivo;
        link.style.display = "inline-block";
        
        // Mensagem de sucesso atualizada
        resultDiv.innerHTML = `
            <h3>‚úÖ PDF Gerado com Sucesso!</h3>
            <p>Obrigado por sua inscri√ß√£o. Emita o PDF e, em breve, voc√™ receber√° um e-mail ou WhatsApp com o boleto para pagamento e as credenciais de acesso.</p>
        `;
        link.textContent = `üì• Baixar PDF: ${nomeArquivo}`; 
    });

</script>
</body>
</html>
