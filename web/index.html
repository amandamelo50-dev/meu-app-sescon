<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Ficha de Associa√ß√£o - SESCON-SP</title>
  <style>
    /* CSS SIMPLIFICADO E FUNCIONAL */
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%);
        color: #333;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
    }

    .container { 
        max-width: 900px;
        margin: 30px auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        position: relative;
    }

    .container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, #8B0000, #FFD700, #8B0000);
    }

    h1 {
        text-align: center;
        color: #8B0000;
        font-size: 2.2em;
        margin-bottom: 10px;
    }

    h2 {
        color: #8B0000;
        font-size: 1.4em;
        border-left: 4px solid #8B0000;
        padding-left: 10px;
        margin-top: 25px;
    }

    label { 
        display: block;
        margin-top: 15px;
        font-weight: 600;
        color: #555;
    }

    input, select, textarea { 
        width: 100%;
        padding: 12px;
        margin-top: 8px;
        box-sizing: border-box;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
    }

    input:focus, select:focus {
        border-color: #8B0000;
        outline: none;
    }

    button { 
        margin-top: 20px;
        padding: 14px 25px;
        background: linear-gradient(135deg, #8B0000, #A52A2A);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        width: 100%;
    }

    button:hover {
        background: linear-gradient(135deg, #A52A2A, #8B0000);
    }

    #signature-pad {
        border: 2px dashed #8B0000;
        border-radius: 8px;
        background: #f8f9fa;
        cursor: crosshair;
        width: 100%;
    }

    #downloadLink { 
        display: block;
        margin-top: 20px;
        padding: 15px;
        background: #28a745;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
    }

    #result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
    }

    .lgpd-footer {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #8B0000;
        font-size: 12px;
        color: #666;
        line-height: 1.5;
    }

    .sig-buttons {
        margin-top: 10px;
        text-align: center;
    }

    .sig-buttons button {
        width: auto;
        background: #6c757d;
    }
  </style>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>
  <div class="container">
    <h1>Ficha de Associa√ß√£o - SESCON-SP</h1>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">
      Preencha os dados abaixo para gerar sua ficha de associa√ß√£o
    </p>

    <form id="fichaForm">
      <h2>Dados da Empresa</h2>
      
      <label>CNPJ *</label>
      <input type="text" name="cnpj" placeholder="Somente n√∫meros" required maxlength="14">

      <label>Raz√£o Social *</label>
      <input type="text" name="razao" placeholder="Nome completo da empresa" required>

      <label>E-mail *</label>
      <input type="email" name="email" placeholder="contato@empresa.com" required>

      <label>Telefone *</label>
      <input type="text" name="telefone" placeholder="(11) 9XXXX-XXXX" required>

      <label>Endere√ßo Completo</label>
      <input type="text" name="endereco" placeholder="Rua, n√∫mero, complemento, cidade">

      <h2>Dados do S√≥cio</h2>

      <label>Nome do S√≥cio *</label>
      <input type="text" name="nome_socio" placeholder="Nome completo do s√≥cio" required>

      <label>CPF do S√≥cio *</label>
      <input type="text" name="cpf_socio" placeholder="Somente n√∫meros" required maxlength="11">

      <h2>Plano e Pagamento</h2>

      <label>Plano Sugerido</label>
      <select name="plano">
        <option value="Plano Prata">Plano Prata</option>
        <option value="Plano Ouro Premium">Plano Ouro Premium</option>
        <option value="Prata Aescon">Prata Aescon</option>
      </select>

      <label>Forma de Pagamento</label>
      <select name="forma_pagamento">
        <option value="Parcelado">Parcelado</option>
        <option value="√Ä vista">√Ä vista</option>
      </select>

      <h2>Assinatura</h2>
      
      <label>Assinatura do S√≥cio (use mouse ou toque)</label>
      <canvas id="signature-pad" width="600" height="200"></canvas>
      <div class="sig-buttons">
        <button type="button" id="clearBtn">Limpar Assinatura</button>
      </div>

      <label style="margin-top: 20px;">
        <input type="checkbox" name="termo_aceite" value="1" required> 
        Declaro estar ciente e de acordo com os termos de associa√ß√£o. *
      </label>

      <button type="submit" id="sendBtn">Gerar PDF da Ficha</button>
    </form>

    <div id="result"></div>
    <a id="downloadLink" style="display:none">üì• Baixar PDF Gerado</a>

    <!-- FOOTER LGPD -->
    <div class="lgpd-footer">
      <strong>O Sescon-SP informa que, em respeito aos preceitos elencados no art. 6¬∫ da LGPD e, em especial, ao Princ√≠pio da Finalidade, a coleta dos dados pessoais dispostos neste formul√°rio, ser√° pautada na hip√≥tese de tratamento prevista no inciso IX do Art. 7¬∫ da Lei n¬∫ 13.709/18.</strong><br><br>
      Saiba mais: <a href="https://sescon.org.br/wp-content/uploads/2025/05/POLITICA-DE-PRIVACIDADE-E-COOKIES-1.pdf" target="_blank">Pol√≠tica de Privacidade e Cookies</a>
    </div>
  </div>

  <script>
    // ========== CONFIGURA√á√ÉO DA ASSINATURA ==========
    const canvas = document.getElementById("signature-pad");
    const ctx = canvas.getContext("2d");
    let drawing = false;
    let lastX = 0, lastY = 0;

    // Configurar estilo da assinatura
    ctx.strokeStyle = "#8B0000";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";

    function drawLine(x1, y1, x2, y2) {
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
    }

    // Eventos do mouse
    canvas.addEventListener("mousedown", (e) => {
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    });

    canvas.addEventListener("mousemove", (e) => {
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        drawLine(lastX, lastY, x, y);
        lastX = x;
        lastY = y;
    });

    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mouseout", () => drawing = false);

    // Limpar assinatura
    document.getElementById("clearBtn").addEventListener("click", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // ========== CONSULTA AUTOM√ÅTICA DE CNPJ ==========
    async function consultarCNPJ(cnpj) {
        console.log(`Consultando CNPJ: ${cnpj}`);
        
        try {
            const response = await fetch(`https://meu-app-sescon.onrender.com/consultar-cnpj/${cnpj}`);
            
            if (response.ok) {
                const dados = await response.json();
                console.log('Dados recebidos:', dados);
                
                // Preencher campos automaticamente
                if (dados.razao_social) {
                    document.querySelector('input[name="razao"]').value = dados.razao_social;
                }
                if (dados.endereco) {
                    document.querySelector('input[name="endereco"]').value = dados.endereco;
                }
                
                mostrarMensagem('‚úÖ Dados preenchidos automaticamente!', 'success');
                
                // Agora sugerir o plano
                await sugerirPlano(cnpj);
                
            } else if (response.status === 404) {
                mostrarMensagem('‚ö†Ô∏è CNPJ n√£o encontrado. Preencha manualmente.', 'warning');
            } else {
                mostrarMensagem('‚ùå Erro na consulta. Tente novamente.', 'error');
            }
        } catch (error) {
            console.error('Erro na consulta:', error);
            mostrarMensagem('‚ùå Erro de conex√£o. Verifique a internet.', 'error');
        }
    }

    // ========== SUGERIR PLANO ==========
    async function sugerirPlano(cnpj) {
        try {
            const response = await fetch(`https://meu-app-sescon.onrender.com/sugerir-plano/${cnpj}`);
            
            if (response.ok) {
                const dados = await response.json();
                console.log('Plano sugerido:', dados);
                
                if (dados.plano && !dados.error) {
                    // Encontrar a op√ß√£o correspondente no select
                    const selectPlano = document.querySelector('select[name="plano"]');
                    const opcoes = Array.from(selectPlano.options);
                    const opcaoEncontrada = opcoes.find(opcao => 
                        opcao.text.includes(dados.plano) || 
                        dados.plano.includes(opcao.text)
                    );
                    
                    if (opcaoEncontrada) {
                        selectPlano.value = opcaoEncontrada.value;
                        mostrarMensagem(`üìä Plano sugerido: ${dados.plano}`, 'info');
                        
                        // Calcular valores do plano
                        await calcularValores(opcaoEncontrada.value);
                    }
                }
            }
        } catch (error) {
            console.error('Erro ao sugerir plano:', error);
        }
    }

    // ========== CALCULAR VALORES ==========
    async function calcularValores(plano) {
        try {
            const response = await fetch(`https://meu-app-sescon.onrender.com/calcular-valores/${plano}`);
            
            if (response.ok) {
                const valores = await response.json();
                console.log('Valores calculados:', valores);
                
                // Criar ou atualizar se√ß√£o de valores
                exibirValores(valores, plano);
                
            }
        } catch (error) {
            console.error('Erro ao calcular valores:', error);
        }
    }

    // ========== EXIBIR VALORES NA TELA ==========
    function exibirValores(valores, plano) {
        let valoresSection = document.getElementById('valores-section');
        
        if (!valoresSection) {
            valoresSection = document.createElement('div');
            valoresSection.id = 'valores-section';
            valoresSection.style.cssText = `
                background: #f8f9fa; 
                padding: 15px; 
                border-radius: 8px; 
                margin: 15px 0;
                border-left: 4px solid #8B0000;
            `;
            
            // Inserir ap√≥s o select de plano
            const planoSelect = document.querySelector('select[name="plano"]');
            planoSelect.closest('div').appendChild(valoresSection);
        }
        
        valoresSection.innerHTML = `
            <h3 style="margin-top: 0; color: #8B0000;">üí≥ Valores do ${plano}</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <strong>√Ä Vista:</strong><br>
                    <span style="font-size: 1.2em; color: #28a745; font-weight: bold;">${valores.a_vista}</span>
                </div>
                <div>
                    <strong>Parcelado:</strong><br>
                    <span style="font-size: 1.1em; color: #007bff;">${valores.parcelado}</span>
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                üí° Valores proporcionais referentes ao m√™s atual
            </div>
        `;
    }

    // ========== FUN√á√ÉO PARA MENSAGENS ==========
    function mostrarMensagem(mensagem, tipo = 'info') {
        // Remover mensagem anterior
        const mensagemAnterior = document.getElementById('mensagem-flutuante');
        if (mensagemAnterior) {
            mensagemAnterior.remove();
        }
        
        const cores = {
            'success': '#28a745',
            'warning': '#ffc107', 
            'error': '#dc3545',
            'info': '#17a2b8'
        };
        
        const mensagemDiv = document.createElement('div');
        mensagemDiv.id = 'mensagem-flutuante';
        mensagemDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${cores[tipo]};
            color: white;
            padding: 12px 18px;
            border-radius: 5px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-weight: 600;
        `;
        
        mensagemDiv.textContent = mensagem;
        document.body.appendChild(mensagemDiv);
        
        setTimeout(() => {
            if (mensagemDiv.parentNode) {
                mensagemDiv.remove();
            }
        }, 4000);
    }

    // ========== EVENTOS PRINCIPAIS ==========
    
    // Consulta autom√°tica ao sair do campo CNPJ
    document.querySelector('input[name="cnpj"]').addEventListener('blur', function() {
        const cnpj = this.value.replace(/\D/g, '');
        if (cnpj.length === 14) {
            consultarCNPJ(cnpj);
        }
    });

    // Calcular valores quando mudar o plano manualmente
    document.querySelector('select[name="plano"]').addEventListener('change', function() {
        calcularValores(this.value);
    });

    // Valida√ß√£o de CNPJ em tempo real
    document.querySelector('input[name="cnpj"]').addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '');
    });

    // Valida√ß√£o de CPF em tempo real
    document.querySelector('input[name="cpf_socio"]').addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '');
    });

    // ========== ENVIO DO FORMUL√ÅRIO ==========
    document.getElementById("fichaForm").addEventListener("submit", async (ev) => {
        ev.preventDefault();
        const form = ev.target;
        const sendBtn = document.getElementById("sendBtn");
        const resultDiv = document.getElementById("result");

        // Validar campos obrigat√≥rios
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.style.borderColor = 'red';
                isValid = false;
            } else {
                field.style.borderColor = '';
            }
        });

        if (!isValid) {
            resultDiv.textContent = "‚ùå Preencha todos os campos obrigat√≥rios (*)";
            resultDiv.style.color = "red";
            resultDiv.style.backgroundColor = "#ffe6e6";
            return;
        }

        // Mostrar loading
        sendBtn.textContent = "Gerando PDF...";
        sendBtn.disabled = true;
        resultDiv.textContent = "‚è≥ Gerando sua ficha...";

        const formData = new FormData(form);
        const json = {};
        formData.forEach((v, k) => {
            if (k === "termo_aceite") json[k] = true;
            else json[k] = v;
        });

        // Adicionar assinatura
        json.signature = canvas.toDataURL();

        try {
            const resp = await fetch("https://meu-app-sescon.onrender.com/gerar-pdf", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(json)
            });

            if (resp.ok) {
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const link = document.getElementById("downloadLink");
                link.href = url;
                link.download = "ficha_associacao_sescon.pdf";
                link.style.display = "block";
                
                resultDiv.textContent = "‚úÖ PDF gerado com sucesso!";
                resultDiv.style.color = "green";
                resultDiv.style.backgroundColor = "#e6ffe6";
                mostrarMensagem('‚úÖ Ficha gerada com sucesso!', 'success');
            } else {
                const errorText = await resp.text();
                resultDiv.textContent = "‚ùå Erro ao gerar PDF";
                resultDiv.style.color = "red";
                resultDiv.style.backgroundColor = "#ffe6e6";
                mostrarMensagem('‚ùå Erro ao gerar PDF', 'error');
            }
        } catch (error) {
            resultDiv.textContent = "‚ùå Erro de conex√£o";
            resultDiv.style.color = "red";
            resultDiv.style.backgroundColor = "#ffe6e6";
            mostrarMensagem('‚ùå Erro de conex√£o', 'error');
        } finally {
            sendBtn.textContent = "Gerar PDF da Ficha";
            sendBtn.disabled = false;
        }
    });
</script>
</body>
</html>
