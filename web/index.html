<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Ficha de Associa√ß√£o - SESCON</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Ficha de Associa√ß√£o - SESCON</h1>

    <form id="fichaForm">
      <label>CNPJ</label>
      <input type="text" name="cnpj" placeholder="Somente n√∫meros" maxlength="14">

      <label>Raz√£o Social</label>
      <input type="text" name="razao" required disabled>

      <label>Endere√ßo</label>
      <input type="text" name="endereco" disabled>

      <label>E-mail</label>
      <input type="email" name="email" placeholder="contato@empresa.com">

      <label>Telefone</label>
      <input type="text" name="telefone" placeholder="(11) 9XXXX-XXXX">

      <label>Servi√ßos de Interesse</label>
      <div id="servicos-interesse-container">
          <label><input type="checkbox" name="servicos_interesse" value="149SERVICO DE INTERESSE - INSTITUCIONAL"> Institucional</label>
          <label><input type="checkbox" name="servicos_interesse" value="150SERVICO DE INTERESSE - BOLSA DE TALENTOS"> Bolsa de Talentos</label>
          <label><input type="checkbox" name="servicos_interesse" value="151SERVICO DE INTERESSE - CONVENCAO COLETIVA"> Conven√ß√£o Coletiva</label>
          <label><input type="checkbox" name="servicos_interesse" value="152SERVICO DE INTERESSE - CURSOS UNISESCON"> Cursos UNISESCON</label>
          <label><input type="checkbox" name="servicos_interesse" value="153SERVICO DE INTERESSE - CONSULTORIAS JURIDICA - IOB TELEFONE"> Consultoria Jur√≠dica - IOB Telefone</label>
          <label><input type="checkbox" name="servicos_interesse" value="358SERVICO DE INTERESSE - CONSULTORIAS JURIDICA - IOB EXPLICA"> Consultoria Jur√≠dica - IOB Explica</label>
          <label><input type="checkbox" name="servicos_interesse" value="154SERVICO DE INTERESSE - ER JUCESP - FATURADO"> ER JUCESP - Faturado</label>
          <label><input type="checkbox" name="servicos_interesse" value="155SERVICO DE INTERESSE - CERTIFICACAO DIGITAL"> Certifica√ß√£o Digital</label>
          <label><input type="checkbox" name="servicos_interesse" value="156SERVICO DE INTERESSE - CONTABIL STORE"> Cont√°bil Store</label>
          <label><input type="checkbox" name="servicos_interesse" value="157SERVICO DE INTERESSE - PESQUISAS"> Pesquisas</label>
          <label><input type="checkbox" name="servicos_interesse" value="158SERVICO DE INTERESSE - SOCIETARIO E LEGAL"> Societ√°rio e Legal</label>
          <label><input type="checkbox" name="servicos_interesse" value="159SERVICO DE INTERESSE - PROJETO LGPD"> Projeto LGPD</label>
          <label><input type="checkbox" name="servicos_interesse" value="160SERVICO DE INTERESSE - PQEC"> PQEC</label>
          <label><input type="checkbox" name="servicos_interesse" value="161SERVICO DE INTERESSE - EVENTOS"> Eventos</label>
          <label><input type="checkbox" name="servicos_interesse" value="165SERVICO DE INTERESSE - ENDERECO FISCAL"> Endere√ßo Fiscal</label>
          <label><input type="checkbox" name="servicos_interesse" value="166SERVICO DE INTERESSE - COWORKING"> Coworking</label>
          <label><input type="checkbox" name="servicos_interesse" value="306SERVICO DE INTERESSE - LOCACAO DE AUDITORIO"> Loca√ß√£o de Audit√≥rio</label>
          <label><input type="checkbox" name="servicos_interesse" value="315SERVICO DE INTERESSE - NAO INFORMADO AINDA"> N√£o Informado Ainda</label>
          <label><input type="checkbox" name="servicos_interesse" value="317SERVICO DE INTERESSE - PARCERIAS"> Parcerias</label>
          <label><input type="checkbox" name="servicos_interesse" value="342SERVICO DE INTERESSE - RECEITA FEDERAL"> Receita Federal</label>
          <label><input type="checkbox" name="servicos_interesse" value="343SERVICO DE INTERESSE - CENTRAL DE SERVI√áOS"> Central de Servi√ßos</label>
          <label><input type="checkbox" name="servicos_interesse" value="344SERVICO DE INTERESSE - CCT"> CCT</label>
          <label><input type="checkbox" name="servicos_interesse" value="347SERVI√áO DE INTERESSE - CERTIFICADO DIGITAL GRATUITO"> Certificado Digital Gratuito</label>
          <label><input type="checkbox" name="servicos_interesse" value="348SERVICO DE INTERESSE - CONTRIBUI√á√ÉO REPRESENTATIVA"> Contribui√ß√£o Representativa</label>
      </div>

      <label>Plano Sugerido</label>
      <input type="text" name="plano" disabled>
      <p id="plano-info"></p>

      <label>S√≥cio/Respons√°vel</label>
      <select id="socios-select" name="nome_socio" required>
        <option value="">Selecione o s√≥cio respons√°vel</option>
      </select>

      <label>CPF do S√≥cio</label>
      <input type="text" name="cpf_socio" placeholder="Opcional.">

      <label>Forma de Pagamento</label>
      <select name="forma_pagamento">
        <option value="Parcelado">Parcelado</option>
        <option value="√Ä vista">√Ä vista</option>
      </select>

      <label><input type="checkbox" name="termo_aceite" value="1"> Declaro estar ciente e de acordo com os termos de associa√ß√£o.</label>

      <h3>Assinatura (use mouse ou touch)</h3>
      <canvas id="signature-pad" width=600 height=200 style="border:1px solid #ccc;"></canvas>
      <div class="sig-buttons">
        <button type="button" id="clearBtn">Limpar Assinatura</button>
      </div>

      <button type="submit" id="sendBtn" disabled>Gerar PDF</button>
    </form>

    <div id="result" style="margin-top:20px;"></div>
    <a id="downloadLink" style="display:none">üì• Baixar PDF</a>
  </div>

<script>
  window.jsPDF = window.jspdf.jsPDF;

  // CNAE e Cidades
  const cnaes_ouro = new Set(["6920601", "6920602"]);
  const cnaes_prata = new Set([
      "0230600", "5229002", "5229099", "5240101", "5250804", "5250805", "6461100", "6462000", "6463800",
      "6611801", "6611802", "6611803", "6611804", "6612605", "6613400", "6619302", "6619303", "6619399",
      "6621501", "6621502", "6629100", "6630400", "6911702", "6911703", "7020400", "7119701", "7119702",
      "7119703", "7119704", "7120100", "7120100", "7210000", "7220700", "7319004", "7319002", "7420002", "7420005",
      "7490101", "7490103", "7490104", "7490105", "7490199", "8020000", "8211300", "8219999", "8550302",
      "8599604", "8660700", "9411100", "9412000", "9430800", "9491000", "9499500" ,"8299799","7320300"
  ]);

  const cidades_tupa = new Set(["tup√£", "arco-√≠ris", "bast√£o", "hercul√¢ndia", "ikanji", "mar√≠lia", "pomp√©ia", "queiroz"]);
  const cidades_campinas = new Set(["campinas", "hortol√¢ndia", "sumar√©", "valinhos", "vinhedo", "jaguari√∫na", "paul√≠nia", "itatiba", "indaiatuba", "amparo", "pedreira", "socorro", "√°guas de lind√≥ia", "monte alegre do sul", "serra negra", "holambra", "mogimirim", "mogigua√ßu", "artur nogueira", "nova odessa", "santa b√°rbara d'oeste", "americana", "piracicaba", "limeira", "rio claro", "araras", "lemes"]);
  const cidades_santos = new Set(["santos", "s√£o vicente", "praia grande", "guaruj√°", "cubat√£o", "bertioga", "mongagu√°", "itanha√©m", "peru√≠be", "canan√©ia", "ilhabela", "caraguatatuba", "ubatuba", "s√£o sebasti√£o"]);


  // Pre√ßos
  const prata_pricing = { 1: { total: 720.00, parcelas: 12, valor_parcela: 60.00, a_vista: 660.00 }, 2: { total: 660.00, parcelas: 11, valor_parcela: 60.00, a_vista: 607.00 }, 3: { total: 600.00, parcelas: 10, valor_parcela: 60.00, a_vista: 552.00 }, 4: { total: 540.00, parcelas: 9, valor_parcela: 60.00, a_vista: 497.00 }, 5: { total: 480.00, parcelas: 8, valor_parcela: 60.00, a_vista: 442.00 }, 6: { total: 420.00, parcelas: 7, valor_parcela: 60.00, a_vista: 386.00 }, 7: { total: 360.00, parcelas: 6, valor_parcela: 60.00, a_vista: 331.00 }, 8: { total: 300.00, parcelas: 5, valor_parcela: 60.00, a_vista: 276.00 }, 9: { total: 240.00, parcelas: 4, valor_parcela: 60.00, a_vista: 221.00 }, 10: { total: 180.00, parcelas: 3, valor_parcela: 60.00, a_vista: 166.00 }, 11: { total: 120.00, parcelas: 2, valor_parcela: 60.00, a_vista: 110.00 }, 12: { total: 60.00, parcelas: 1, valor_parcela: 60.00, a_vista: 60.00 } };
  const ouro_premium_pricing = { 1: { total: 1140.00, parcelas: 12, valor_parcela: 95.00, a_vista: 1046.00 }, 2: { total: 1045.00, parcelas: 11, valor_parcela: 95.00, a_vista: 961.00 }, 3: { total: 950.00, parcelas: 10, valor_parcela: 95.00, a_vista: 874.00 }, 4: { total: 855.00, parcelas: 9, valor_parcela: 95.00, a_vista: 787.00 }, 5: { total: 760.00, parcelas: 8, valor_parcela: 95.00, a_vista: 700.00 }, 6: { total: 665.00, parcelas: 7, valor_parcela: 95.00, a_vista: 611.00 }, 7: { total: 570.00, parcelas: 6, valor_parcela: 95.00, a_vista: 524.00 }, 8: { total: 475.00, parcelas: 5, valor_parcela: 95.00, a_vista: 437.00 }, 9: { total: 380.00, parcelas: 4, valor_parcela: 95.00, a_vista: 350.00 }, 10: { total: 285.00, parcelas: 3, valor_parcela: 95.00, a_vista: 263.00 }, 11: { total: 190.00, parcelas: 2, valor_parcela: 95.00, a_vista: 175.00 }, 12: { total: 95.00, parcelas: 1, valor_parcela: 95.00, a_vista: 95.00 } };
  const prata_aescon_pricing = { 1: { total: 420.00, parcelas: 12, valor_parcela: 35.00, a_vista: 386.00 }, 2: { total: 385.00, parcelas: 11, valor_parcela: 35.00, a_vista: 354.00 }, 3: { total: 350.00, parcelas: 10, valor_parcela: 35.00, a_vista: 322.00 }, 4: { total: 315.00, parcelas: 9, valor_parcela: 35.00, a_vista: 290.00 }, 5: { total: 280.00, parcelas: 8, valor_parcela: 35.00, a_vista: 258.00 }, 6: { total: 245.00, parcelas: 7, valor_parcela: 35.00, a_vista: 225.00 }, 7: { total: 210.00, parcelas: 6, valor_parcela: 35.00, a_vista: 193.00 }, 8: { total: 175.00, parcelas: 5, valor_parcela: 35.00, a_vista: 161.00 }, 9: { total: 140.00, parcelas: 4, valor_parcela: 35.00, a_vista: 129.00 }, 10: { total: 105.00, parcelas: 3, valor_parcela: 35.00, a_vista: 97.00 }, 11: { total: 70.00, parcelas: 2, valor_parcela: 35.00, a_vista: 65.00 }, 12: { total: 35.00, parcelas: 1, valor_parcela: 35.00, a_vista: 35.00 } };

  // Fun√ß√µes
  function segmentar(cnae, cidade, uf) {
      // Regra 0: Fora do Estado de SP
      if (uf.toUpperCase() !== "SP") {
          return "Fora de SP ‚Äì N√£o podemos associar.";
      }
      cidade = cidade.toLowerCase();

      // 1. VERIFICA√á√ÉO PRINCIPAL DE CNAE (Ouro, Prata ou Fora de Escopo)
      let planoBase = null;
      if (cnaes_ouro.has(cnae)) {
          planoBase = "Plano Ouro Premium";
      } else if (cnaes_prata.has(cnae)) {
          planoBase = "Plano Prata";
      } else {
          // Se o CNAE n√£o estiver em NENHUMA lista, ele √© fora de escopo.
          return "CNAE fora do escopo. Contate Fecom√©rcio: (11) 3254-1700";
      }

      // 2. EXCE√á√ÉO: CNAE Ouro em cidades regionais vira Prata Aescon
      if (planoBase === "Plano Ouro Premium" && (cidades_tupa.has(cidade) || cidades_campinas.has(cidade) || cidades_santos.has(cidade))) {
          return "Prata Aescon";
      }
      
      // 3. EXCLUS√ÉO REGIONAL: Se a empresa √© eleg√≠vel (Ouro/Prata), mas est√° em uma cidade com conv√™nio local, retorna o contato.
      if (cidades_tupa.has(cidade)) {
          return "Fora da regi√£o (Tup√£). E-mail: sescontupan@unisite.com.br";
      }
      if (cidades_campinas.has(cidade)) {
          return "Fora da regi√£o (Campinas). E-mail: sesconcampinas@sesconcampinas.org.br";
      }
      if (cidades_santos.has(cidade)) {
          return "Fora da regi√£o (Santos). E-mail: sheron@sesconbs.org.br";
      }

      // 4. RESULTADO FINAL: Se passou por tudo, retorna o plano base.
      return planoBase;
  }

  function getPlanoInfo(plano) {
    const mesAtual = new Date().getMonth() + 1;
    let tabela = {};
    if (plano === "Plano Prata") {
        tabela = prata_pricing;
    } else if (plano === "Plano Ouro Premium") {
        tabela = ouro_premium_pricing;
    } else if (plano === "Prata Aescon") {
        tabela = prata_aescon_pricing;
    } else {
        return { valor_a_vista: "N/A", valor_parcelado: "N/A" };
    }
    const valores = tabela[mesAtual] || {};
    const aVista = valores.a_vista ? `R$ ${valores.a_vista.toFixed(2).replace('.', ',')}` : "N/A";
    const parcelas = valores.parcelas;
    const valorParcela = valores.valor_parcela ? `R$ ${valores.valor_parcela.toFixed(2).replace('.', ',')}` : "N/A";
    const valorParcelado = parcelas && valorParcela ? `R$ ${valores.total.toFixed(2).replace('.', ',')} em ${parcelas}x de ${valorParcela}` : "N/A";

    return {
        valor_a_vista: aVista,
        valor_parcelado: valorParcelado,
    };
  }

  // Elementos do DOM
  const cnpjInput = document.querySelector('input[name="cnpj"]');
  const razaoInput = document.querySelector('input[name="razao"]');
  const enderecoInput = document.querySelector('input[name="endereco"]');
  const planoInput = document.querySelector('input[name="plano"]');
  const planoInfo = document.getElementById("plano-info");
  const sociosSelect = document.getElementById("socios-select");
  const sendBtn = document.getElementById("sendBtn");
  const resultDiv = document.getElementById("result");
  const form = document.getElementById("fichaForm");

  // Assinatura
  const canvas = document.getElementById("signature-pad");
  const ctx = canvas.getContext("2d");
  let drawing = false;
  let lastX = 0, lastY = 0;

  function drawLine(x1, y1, x2, y2) {
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    ctx.closePath();
  }
  canvas.addEventListener("mousedown", (e) => {
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = e.clientX - rect.left;
    lastY = e.clientY - rect.top;
  });
  canvas.addEventListener("mousemove", (e) => {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    drawLine(lastX, lastY, x, y);
    lastX = x;
    lastY = y;
  });
  canvas.addEventListener("mouseup", () => drawing = false);
  canvas.addEventListener("mouseout", () => drawing = false);
  canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    const t = e.touches[0];
    lastX = t.clientX - rect.left;
    lastY = t.clientY - rect.top;
  }, { passive: false });
  canvas.addEventListener("touchmove", (e) => {
    e.preventDefault();
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const t = e.touches[0];
    const x = t.clientX - rect.left;
    const y = t.clientY - rect.top;
    drawLine(lastX, lastY, x, y);
    lastX = x;
    lastY = y;
  }, { passive: false });
  canvas.addEventListener("touchend", () => drawing = false);
  document.getElementById("clearBtn").addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  // Evento de CNPJ
  cnpjInput.addEventListener('input', async () => {
    const cnpj = cnpjInput.value.replace(/\D/g, '');
    if (cnpj.length === 14) {
      resultDiv.textContent = 'Buscando dados do CNPJ...';
      sendBtn.disabled = true;
      try {
        const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
        const data = await response.json();
        
        if (response.ok) {
          razaoInput.value = data.razao_social || '';
          enderecoInput.value = `${data.logradouro || ''}, ${data.numero || ''}, ${data.bairro || ''} - ${data.municipio || ''}/${data.uf || ''}`;
          
          const planoSugerido = segmentar(data.cnae_fiscal, data.municipio, data.uf);
          planoInput.value = planoSugerido || '';
          
          if (planoSugerido && (planoSugerido.includes('Fora') || planoSugerido.includes('CNAE fora'))) {
            planoInfo.innerHTML = `<span style="color:red;font-weight:bold;">${planoSugerido}</span>`;
            sendBtn.disabled = true;
          } else {
            const planoInfoData = getPlanoInfo(planoSugerido);
            planoInfo.textContent = `√Ä vista: ${planoInfoData.valor_a_vista}. Parcelado: ${planoInfoData.valor_parcelado}.`;
            sendBtn.disabled = false;
          }

          sociosSelect.innerHTML = '<option value="">Selecione o s√≥cio respons√°vel</option>';
          if (data.qsa && data.qsa.length > 0) {
            data.qsa.forEach(socio => {
              const option = document.createElement('option');
              option.value = socio.nome_socio;
              option.textContent = socio.nome_socio;
              sociosSelect.appendChild(option);
            });
          }
          resultDiv.textContent = 'Dados carregados com sucesso.';
        } else {
          resultDiv.textContent = `‚ùå Erro: CNPJ n√£o encontrado ou inv√°lido.`;
          sendBtn.disabled = true;
          razaoInput.value = '';
          enderecoInput.value = '';
          planoInput.value = '';
          planoInfo.textContent = '';
          sociosSelect.innerHTML = '<option value="">Selecione o s√≥cio respons√°vel</option>';
        }
      } catch (error) {
        resultDiv.textContent = `‚ùå Erro na requisi√ß√£o: ${error.message}. Verifique sua conex√£o.`;
        sendBtn.disabled = true;
      }
    } else {
      resultDiv.textContent = 'Digite 14 d√≠gitos do CNPJ para buscar os dados.';
      sendBtn.disabled = true;
    }
  });

  // Gera√ß√£o do PDF
  form.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    resultDiv.textContent = 'Gerando PDF...';

    const dados = {};
    const formData = new FormData(form);
    for (let [key, value] of formData.entries()) {
        if (key === 'servicos_interesse') {
            if (!dados[key]) dados[key] = [];
            dados[key].push(value);
        } else {
            dados[key] = value;
        }
    }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    let y = 20;

    // Cabe√ßalho
    pdf.setFontSize(16);
    pdf.text("Ficha de Inscri√ß√£o - Associa√ß√£o SESCON-SP / AESCON-SP", 10, y);
    y += 15;

    // Dados da Empresa
    pdf.setFontSize(12);
    pdf.text("DADOS DA EMPRESA", 10, y);
    y += 10;
    pdf.setFontSize(10);
    pdf.text(`Raz√£o Social: ${dados.razao || ''}`, 10, y); y += 6;
    pdf.text(`CNPJ: ${dados.cnpj || ''}`, 10, y); y += 6;
    pdf.text(`Endere√ßo: ${dados.endereco || ''}`, 10, y); y += 6;
    pdf.text(`E-mail: ${dados.email || ''}`, 10, y); y += 6;
    pdf.text(`Telefone: ${dados.telefone || ''}`, 10, y); y += 6;
    pdf.text(`Servi√ßos de Interesse: ${(dados.servicos_interesse || []).join(', ') || ''}`, 10, y); y += 10;

    // Dados do S√≥cio
    pdf.setFontSize(12);
    pdf.text("DADOS DO S√ìCIO/RESPONS√ÅVEL PELO PREENCHIMENTO", 10, y);
    y += 10;
    pdf.setFontSize(10);
    pdf.text(`Nome Completo: ${dados.nome_socio || ''}`, 10, y); y += 6;
    pdf.text(`CPF do S√≥cio: ${dados.cpf_socio || ''}`, 10, y); y += 10;

    // Plano Sugerido
    pdf.setFontSize(12);
    pdf.text("PLANO SUGERIDO", 10, y);
    y += 10;
    pdf.setFontSize(10);
    pdf.text(`Plano Sugerido: ${dados.plano || ''}`, 10, y); y += 6;
    const planoInfoData = getPlanoInfo(dados.plano);
    pdf.text(`Valor √Ä Vista: ${planoInfoData.valor_a_vista}`, 10, y); y += 6;
    pdf.text(`Valor Parcelado: ${planoInfoData.valor_parcelado}`, 10, y); y += 10;

    // Assinatura
    const signatureImage = canvas.toDataURL("image/png");
    if (signatureImage && signatureImage.length > "data:,".length) {
        pdf.addImage(signatureImage, 'PNG', 10, y, 100, 30);
    }
    y += 40;
    pdf.text("________________________________", 10, y); y += 6;
    pdf.text("Assinatura do S√≥cio da Empresa", 10, y);

    const blob = new Blob([pdf.output('arraybuffer')], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const link = document.getElementById("downloadLink");
    link.href = url;
    link.download = "ficha_associacao.pdf";
    link.style.display = "inline-block";
    link.textContent = "üì• Baixar PDF gerado";
    resultDiv.textContent = "‚úÖ PDF gerado com sucesso.";
  });

</script>
</body>
</html>
