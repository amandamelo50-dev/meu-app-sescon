<!DOCTYPE html>
<html lang="pt-BR">
<head>
ย <meta charset="utf-8" />
ย <title>Ficha de Associaรงรฃo - SESCON</title>
ยย
ย <link rel="icon" type="image/png" href="sescon_sp_logo.png.png">

ย <link rel="stylesheet" href="style.css" />
ย <meta name="viewport" content="width=device-width,initial-scale=1" />
ย <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
ย <div class="container">
ย ย <h1>Ficha de Associaรงรฃo - SESCON</h1>
ย ย <p style="color:red; font-weight:bold;">ATENรรO: Este formulรกrio nรฃo estรก salvo. Utilize a funรงรฃo "Gerar PDF" ao finalizar.</p>

ย ย <form id="fichaForm">
ย ย ย <label>CNPJ</label>
ย ย ย <input type="text" name="cnpj" placeholder="Somente nรบmeros" maxlength="14" required>

ย ย ย <label>Razรฃo Social</label>
ย ย ย <input type="text" name="razao" required readonly>

ย ย ย <label>Endereรงo Completo</label>
ย ย ย <input type="text" name="endereco" readonly>

ย ย ย <label>E-mail</label>
ย ย ย <input type="email" name="email" placeholder="contato@empresa.com" required>

ย ย ย <label>Telefone/WhatsApp Principal</label>
ย ย ย <input type="text" name="telefone" placeholder="(11) 9XXXX-XXXX" required>
ย ย ย 
ย ย ย ย ย ย <label>Forma de Contato Preferencial</label>
ย ย ย <select name="contato_preferencial" required>
ย ย ย ย <option value="">Selecione</option>
ย ย ย ย <option value="WhatsApp">WhatsApp (Telefone Principal)</option>
ย ย ย ย <option value="Email">E-mail</option>
ย ย ย </select>

ย ย ย ย ย ย <label>Segmento de Atuaรงรฃo da Empresa (Ex: Serviรงos Contรกbeis, Jurรญdicos, etc.)</label>
ย ย ย <input type="text" name="segmento" placeholder="Ex: Serviรงos Contรกbeis" required>

ย ย ย <label>Plano Sugerido</label>
ย ย ย ย ย ย <input type="text" name="plano" required>
ย ย ย <p id="plano-info" style="font-size: 0.9em;"></p>

ย ย ย ย ย ย <label>A empresa possui registro ativo no CRC?</label>
ย ย ย <select name="crc_empresa" required>
ย ย ย ย <option value="">Selecione</option>
ย ย ย ย <option value="Sim">Sim</option>
ย ย ย ย <option value="Nรฃo">Nรฃo</option>
ย ย ย </select>


ย ย ย <label>Lista de Serviรงos (Prioridade)</label>
ย ย ย <p style="font-size: 0.8em; margin-bottom: 5px;">Digite a prioridade de interesse (1 - 3, por exemplo) para os serviรงos abaixo, separando por vรญrgula. Pelo menos um รฉ obrigatรณrio.</p>
ย ย ย <textarea id="servicos-interesse-lista" name="servicos_interesse_lista" rows="4" placeholder="Exemplo: 1 - CERTIFICAรรO DIGITAL, 2 - CURSOS UNISESCON, 3 - PQEC" required></textarea>
ย ย ย <div id="servicos-interesse-container" style="font-size: 0.8em; border: 1px solid #ccc; padding: 10px; max-height: 150px; overflow-y: scroll;">
ย ย ย ย ย ย ย </div>

ย ย ย <label>Sรณcio/Responsรกvel</label>
ย ย ย <select id="socios-select" name="nome_socio" required>
ย ย ย ย <option value="">Selecione o sรณcio responsรกvel</option>
ย ย ย </select>

ย ย ย <label>CPF do Sรณcio</label>
ย ย ย ย ย ย <input type="text" name="cpf_socio" placeholder="Somente 11 dรญgitos" required>

ย ย ย ย ย ย <label>O sรณcio possui registro ativo no CRC?</label>
ย ย ย <select name="crc_socio" required>
ย ย ย ย <option value="">Selecione</option>
ย ย ย ย <option value="Sim">Sim</option>
ย ย ย ย <option value="Nรฃo">Nรฃo</option>
ย ย ย </select>

ย ย ย <label>Forma de Pagamento</label>
ย ย ย <select name="forma_pagamento">
ย ย ย ย <option value="Parcelado">Parcelado</option>
ย ย ย ย <option value="ร vista">ร vista</option>
ย ย ย </select>

ย ย ย <label>
ย ย ย ย <input type="checkbox" name="termo_aceite" value="1" required> 
ย ย ย ย Declaro estar ciente e de acordo com os termos de associaรงรฃo. (Link para Termos pendente) 
ย ย ย </label>
ย ย ย 
ย ย ย <p style="font-size: 0.8em; color: gray;">
ย ย ย ย OBSERVAรรO DE RESPONSABILIDADE: Declaro que todas as informaรงรตes prestadas sรฃo de responsabilidade do associado/sรณcio responsรกvel pelo preenchimento, nos termos do estatuto. [cite: 37]
ย ย ย </p>

ย ย ย <h3>Assinatura (use mouse ou touch)</h3>
ย ย ย <canvas id="signature-pad" width=600 height=200 style="border:1px solid #ccc;"></canvas>
ย ย ย <div class="sig-buttons">
ย ย ย ย <button type="button" id="clearBtn">Limpar Assinatura</button>
ย ย ย </div>

ย ย ย <button type="submit" id="sendBtn" disabled>Gerar PDF</button>
ย ย </form>

ย ย <div id="result" style="margin-top:20px;"></div>
ย ย <a id="downloadLink" style="display:none">๐ฅ Baixar PDF</a>
ย </div>

<script>
ย window.jsPDF = window.jspdf.jsPDF;

ย // Dados da imagem do logo em Base64
ย const SESCON_LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUsAAABjCAYAAAB2b44XAAAAAXNSR0IArs4c6QAAAK9JREFUeJzt3EEKgDAQRcGrw3Y8vP+5hE2Q2zS6+oD715x/nL9o8Wz9FwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAt+V878E4Jz3nOcfF551mX7XqW93uT/k4Jz9K+dM+Xv92AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIC35Zz1pZ73pXy6L3e7v5Tf8vB/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIBf9vP9h1L5U8qfUt73UfI7zvsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAID3/R16vQMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsG936w5vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADg26f6OwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAd3/vXwMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgt1t5+wMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIB3/fXvAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHC3W3n7AwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgHf99e8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcLdbefsDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP+E1/8HAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC4W3z+EwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAd4l/17sAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADA1/y/Q27xPw/Y7QkAAAAASUVORK5CYII=';

ย // --------------------------------------------------------------------------------
ย // 1. LISTA DE SERVIรOS (Ordenada Alfabeticamente, sem "NรO INFORMADO AINDA" )
ย // --------------------------------------------------------------------------------
ย const listaServicos = [
ย ย { id: '343', nome: 'CENTRAL DE SERVIรOS' },
ย ย { id: '155', nome: 'CERTIFICAรรO DIGITAL' },
ย ย { id: '347', nome: 'CERTIFICADO DIGITAL GRATUITO' },
ย ย { id: '150', nome: 'BOLSA DE TALENTOS' },
ย ย { id: '156', nome: 'CONTรBIL STORE' },
ย ย { id: '348', nome: 'CONTRIBUIรรO REPRESENTATIVA' },
ย ย { id: '153', nome: 'CONSULTORIA JURรDICA - IOB TELEFONE' },
ย ย { id: '358', nome: 'CONSULTORIA JURรDICA - IOB EXPLICA' },
ย ย { id: '151', nome: 'CONVENรรO COLETIVA' },
ย ย { id: '166', nome: 'COWORKING' },
ย ย { id: '152', nome: 'CURSOS UNISESCON' },
ย ย { id: '165', nome: 'ENDEREรO FISCAL' },
ย ย { id: '154', nome: 'ER JUCESP - FATURADO' },
ย ย { id: '161', nome: 'EVENTOS' },
ย ย { id: '149', nome: 'INSTITUCIONAL' },
ย ย { id: '306', nome: 'LOCAรรO DE AUDITรRIO' },
ย ย { id: '317', nome: 'PARCERIAS' },
ย ย { id: '157', nome: 'PESQUISAS' },
ย ย { id: '160', nome: 'PQEC' },
ย ย { id: '159', nome: 'PROJETO LGPD' },
ย ย { id: '342', nome: 'RECEITA FEDERAL' },
ย ย { id: '158', nome: 'SOCIETรRIO E LEGAL' },
ย ];
ยย
ย function renderizarServicosParaReferencia() {
ย ย const container = document.getElementById('servicos-interesse-container');
ย ย let htmlContent = '<strong>Lista de Serviรงos Disponรญveis (para referรชncia e priorizaรงรฃo):</strong><br>';
ย ยย
ย ย listaServicos.forEach((servico, index) => {
ย ย ย htmlContent += `${index + 1}. ${servico.nome}<br>`;
ย ย });

ย ย container.innerHTML = htmlContent;
ย }
ย document.addEventListener('DOMContentLoaded', renderizarServicosParaReferencia);


ย // Variรกveis para guardar dados do CNPJ para uso no PDF (evita re-busca no submit)
ย let cnaeGlobal = '';
ย let municipioGlobal = '';
ย let ufGlobal = '';


ย // --------------------------------------------------------------------------------
ย // 2. LรGICA DE NEGรCIO (CNAEs, Cidades e Segmentaรงรฃo)
ย // --------------------------------------------------------------------------------

ย function sanitizeCity(city) {
ย ย ย if (!city) return "";
ย ย ย return city
ย ย ย ย ย .toLowerCase()ย
ย ย ย ย ย .normalize("NFD")ย
ย ย ย ย ย .replace(/[\u0300-\u036f]/g, "")ย
ย ย ย ย ย .replace(/[^a-z0-9\s]/g, "")ย
ย ย ย ย ย .trim();ย
ย }

ย // Listas de CNAEs Elegรญveis (Ouro e Prata)
ย const cnaes_ouro = new Set(["6920601", "6920602"]);
ย const cnaes_prata = new Set([
ย ย ย "0230600", "5229002", "5229099", "5240101", "5250804", "5250805", "6461100", "6462000", "6463800",
ย ย ย "6611801", "6611802", "6611803", "6611804", "6612605", "6613400", "6619302", "6619303", "6619399",
ย ย ย "6621501", "6621502", "6629100", "6630400", "6911702", "6911703", "7020400", "7119701", "7119702",
ย ย ย "7119703", "7119704", "7120100", "7210000", "7220700", "7319004", "7319002", "7420002", "7420005",
ย ย ย "7490101", "7490103", "7490104", "7490105", "7490199", "8020000", "8211300", "8219999", "8550302",
ย ย ย "8599604", "8660700", "9411100", "9412000", "9430800", "9491000", "9499500" ,"8299799","7320300"
ย ]);

ย // Listas de Cidades com Exclusรฃo/Encaminhamento Regional (TODAS SEM ACENTOS)
ย const cidades_tupa = new Set(["tupa", "arcoiris", "bastao", "herculandia", "ikanji", "marilia", "pompeia", "queiroz"]);
ย const cidades_campinas = new Set(["campinas", "hortolandia", "sumare", "valinhos", "vinhedo", "jaguariuna", "paulinia", "itatiba", "indaiatuba", "amparo", "pedreira", "socorro", "aguas de lindoia", "monte alegre do sul", "serra negra", "holambra", "mogimirim", "mogiguacu", "artur nogueira", "nova odessa", "santa barbara doeste", "americana", "piracicaba", "limeira", "rio claro", "araras", "lemes"]);
ย const cidades_santos = new Set(["santos", "sao vicente", "praia grande", "guaruja", "cubatao", "bertioga", "mongagua", "itanhaem", "peruibe", "cananeia", "ilhabela", "caraguatatuba", "ubatuba", "sao sebastiao"]);

ย // Preรงos (tabelas de valores)
ย const prata_pricing = { 1: { total: 720.00, parcelas: 12, valor_parcela: 60.00, a_vista: 660.00 }, 2: { total: 660.00, parcelas: 11, valor_parcela: 60.00, a_vista: 607.00 }, 3: { total: 600.00, parcelas: 10, valor_parcela: 60.00, a_vista: 552.00 }, 4: { total: 540.00, parcelas: 9, valor_parcela: 60.00, a_vista: 497.00 }, 5: { total: 480.00, parcelas: 8, valor_parcela: 60.00, a_vista: 442.00 }, 6: { total: 420.00, parcelas: 7, valor_parcela: 60.00, a_vista: 386.00 }, 7: { total: 360.00, parcelas: 6, valor_parcela: 60.00, a_vista: 331.00 }, 8: { total: 300.00, parcelas: 5, valor_parcela: 60.00, a_vista: 276.00 }, 9: { total: 240.00, parcelas: 4, valor_parcela: 60.00, a_vista: 221.00 }, 10: { total: 180.00, parcelas: 3, valor_parcela: 60.00, a_vista: 166.00 }, 11: { total: 120.00, parcelas: 2, valor_parcela: 60.00, a_vista: 110.00 }, 12: { total: 60.00, parcelas: 1, valor_parcela: 60.00, a_vista: 60.00 } };
ย const ouro_premium_pricing = { 1: { total: 1140.00, parcelas: 12, valor_parcela: 95.00, a_vista: 1046.00 }, 2: { total: 1045.00, parcelas: 11, valor_parcela: 95.00, a_vista: 961.00 }, 3: { total: 950.00, parcelas: 10, valor_parcela: 95.00, a_vista: 874.00 }, 4: { total: 855.00, parcelas: 9, valor_parcela: 95.00, a_vista: 787.00 }, 5: { total: 760.00, parcelas: 8, valor_parcela: 95.00, a_vista: 700.00 }, 6: { total: 665.00, parcelas: 7, valor_parcela: 95.00, a_vista: 611.00 }, 7: { total: 570.00, parcelas: 6, valor_parcela: 95.00, a_vista: 524.00 }, 8: { total: 475.00, parcelas: 5, valor_parcela: 95.00, a_vista: 437.00 }, 9: { total: 380.00, parcelas: 4, valor_parcela: 95.00, a_vista: 350.00 }, 10: { total: 285.00, parcelas: 3, valor_parcela: 95.00, a_vista: 263.00 }, 11: { total: 190.00, parcelas: 2, valor_parcela: 95.00, a_vista: 175.00 }, 12: { total: 95.00, parcelas: 1, valor_parcela: 95.00, a_vista: 95.00 } };
ย const prata_aescon_pricing = { 1: { total: 420.00, parcelas: 12, valor_parcela: 35.00, a_vista: 386.00 }, 2: { total: 385.00, parcelas: 11, valor_parcela: 35.00, a_vista: 354.00 }, 3: { total: 350.00, parcelas: 10, valor_parcela: 35.00, a_vista: 322.00 }, 4: { total: 315.00, parcelas: 9, valor_parcela: 35.00, a_vista: 290.00 }, 5: { total: 280.00, parcelas: 8, valor_parcela: 35.00, a_vista: 258.00 }, 6: { total: 245.00, parcelas: 7, valor_parcela: 35.00, a_vista: 225.00 }, 7: { total: 210.00, parcelas: 6, valor_parcela: 35.00, a_vista: 193.00 }, 8: { total: 175.00, parcelas: 5, valor_parcela: 35.00, a_vista: 161.00 }, 9: { total: 140.00, parcelas: 4, valor_parcela: 35.00, a_vista: 129.00 }, 10: { total: 105.00, parcelas: 3, valor_parcela: 35.00, a_vista: 97.00 }, 11: { total: 70.00, parcelas: 2, valor_parcela: 35.00, a_vista: 65.00 }, 12: { total: 35.00, parcelas: 1, valor_parcela: 35.00, a_vista: 35.00 } };

ย // Funรงรตes de Segmentaรงรฃo
ย function segmentar(cnae, cidade, uf) {
ย ย ย const cnae_str = String(cnae || '').trim();
ย ย ย const cidade_limpa = sanitizeCity(cidade); 
ย ย ยย
ย ย ย if (uf.toUpperCase() !== "SP") {
ย ย ย ย ย return "Fora de SP โ Nรฃo podemos associar.";
ย ย ย }
ย ย ยย
ย ย ย let planoBase = null;
ย ย ย if (cnaes_ouro.has(cnae_str)) {ย
ย ย ย ย ย planoBase = "Plano Ouro Premium";
ย ย ย } else if (cnaes_prata.has(cnae_str)) {ย
ย ย ย ย ย planoBase = "Plano Prata";
ย ย ย } else {
ย ย ย ย ย return "CNAE fora do escopo. Contate Fecomรฉrcio: (11) 3254-1700";
ย ย ย }

ย ย ย if (planoBase === "Plano Ouro Premium" && (cidades_tupa.has(cidade_limpa) || cidades_campinas.has(cidade_limpa) || cidades_santos.has(cidade_limpa))) {
ย ย ย ย ย return "Prata Aescon";
ย ย ย }
ย ย ยย
ย ย ย if (cidades_tupa.has(cidade_limpa)) {
ย ย ย ย ย return "Fora da regiรฃo (Tupรฃ). E-mail: sescontupan@unisite.com.br";
ย ย ย }
ย ย ย if (cidades_campinas.has(cidade_limpa)) {
ย ย ย ย ย return "Fora da regiรฃo (Campinas). E-mail: sesconcampinas@sesconcampinas.org.br";
ย ย ย }
ย ย ย if (cidades_santos.has(cidade_limpa)) {
ย ย ย ย ย return "Fora da regiรฃo (Santos). E-mail: sheron@sesconbs.org.br";
ย ย ย }
ย ย ยย
ย ย ย return planoBase;
ย }

ย function getPlanoInfo(plano) {
ย ย const mesAtual = new Date().getMonth() + 1;
ย ย let tabela = {};
ย ย if (plano.includes("Prata")) { // Usa includes para pegar "Plano Prata" e "Prata Aescon"
ย ย ย ย tabela = (plano === "Prata Aescon") ? prata_aescon_pricing : prata_pricing;
ย ย } else if (plano.includes("Ouro")) {
ย ย ย ย tabela = ouro_premium_pricing;
ย ย } else {
ย ย ย ย return { valor_a_vista: "N/A", valor_parcelado: "N/A", total: "N/A", valor_parcela: "N/A", parcelas: "N/A" };
ย ย }

ย ย const valores = tabela[mesAtual] || {};
ย ย 
ย ย // Formata para exibiรงรฃo
ย ย const aVista = valores.a_vista ? `R$ ${valores.a_vista.toFixed(2).replace('.', ',')}` : "N/A";
ย ย const valorParcela = valores.valor_parcela ? `R$ ${valores.valor_parcela.toFixed(2).replace('.', ',')}` : "N/A";
ย ย const valorTotalParcelado = valores.total ? `R$ ${valores.total.toFixed(2).replace('.', ',')}` : "N/A";
ย ย const parcelas = valores.parcelas;

ย ย const valorParceladoDisplay = parcelas && valorParcela ? `${parcelas}x de ${valorParcela} (Total: ${valorTotalParcelado})` : "N/A";

ย ย return {
ย ย ย ย valor_a_vista: aVista,
ย ย ย ย valor_parcelado: valorParceladoDisplay,
ย ย ย ย total: valorTotalParcelado, 
ย ย ย ย valor_parcela: valorParcela,
ย ย ย ย parcelas: parcelas
ย ย };
ย }

ย // --------------------------------------------------------------------------------
ย // 3. EVENTOS (CNPJ e Assinatura)
ย // --------------------------------------------------------------------------------

ย // Elementos do DOM
ย const cnpjInput = document.querySelector('input[name="cnpj"]');
ย const razaoInput = document.querySelector('input[name="razao"]');
ย const enderecoInput = document.querySelector('input[name="endereco"]');
ย const planoInput = document.querySelector('input[name="plano"]');
ย const planoInfo = document.getElementById("plano-info");
ย const sociosSelect = document.getElementById("socios-select");
ย const sendBtn = document.getElementById("sendBtn");
ย const resultDiv = document.getElementById("result");
ย const form = document.getElementById("fichaForm");
ย const canvas = document.getElementById("signature-pad");
ย const ctx = canvas.getContext("2d");
ย let drawing = false;
ย let lastX = 0, lastY = 0;

ย // Lรณgica da Assinatura
ย function drawLine(x1, y1, x2, y2) {
ย ย ctx.strokeStyle = "#000";
ย ย ctx.lineWidth = 2;
ย ย ctx.lineCap = "round";
ย ย ctx.beginPath();
ย ย ctx.moveTo(x1, y1);
ย ย ctx.lineTo(x2, y2);
ย ย ctx.stroke();
ย ย ctx.closePath();
ย }
ย canvas.addEventListener("mousedown", (e) => {
ย ย drawing = true;
ย ย const rect = canvas.getBoundingClientRect();
ย ย lastX = e.clientX - rect.left;
ย ย lastY = e.clientY - rect.top;
ย });
ย canvas.addEventListener("mousemove", (e) => {
ย ย if (!drawing) return;
ย ย const rect = canvas.getBoundingClientRect();
ย ย const x = e.clientX - rect.left;
ย ย const y = e.clientY - rect.top;
ย ย drawLine(lastX, lastY, x, y);
ย ย lastX = x;
ย ย lastY = y;
ย });
ย canvas.addEventListener("mouseup", () => drawing = false);
ย canvas.addEventListener("mouseout", () => drawing = false);
ย canvas.addEventListener("touchstart", (e) => {
ย ย e.preventDefault();
ย ย drawing = true;
ย ย const rect = canvas.getBoundingClientRect();
ย ย const t = e.touches[0];
ย ย lastX = t.clientX - rect.left;
ย ย lastY = t.clientY - rect.top;
ย }, { passive: false });
ย canvas.addEventListener("touchmove", (e) => {
ย ย e.preventDefault();
ย ย if (!drawing) return;
ย ย const rect = canvas.getBoundingClientRect();
ย ย const t = e.touches[0];
ย ย const x = t.clientX - rect.left;
ย ย const y = t.clientY - rect.top;
ย ย drawLine(lastX, lastY, x, y);
ย ย lastX = x;
ย ย lastY = y;
ย }, { passive: false });
ย canvas.addEventListener("touchend", () => drawing = false);
ย document.getElementById("clearBtn").addEventListener("click", () => {
ย ย ctx.clearRect(0, 0, canvas.width, canvas.height);
ย });

ย // Funรงรฃo auxiliar para atualizar a info do plano
ย function atualizarPlanoInfo() {
ย ย const planoSugerido = planoInput.value;
ย ย if (!planoSugerido || planoSugerido.includes('Fora') || planoSugerido.includes('CNAE fora')) {
ย ย ย planoInfo.innerHTML = `<span style="color:red;font-weight:bold;">${planoSugerido || 'N/A'}</span>`;
ย ย ย sendBtn.disabled = true;
ย ย } else {
ย ย ย const planoInfoData = getPlanoInfo(planoSugerido);
ย ย ย planoInfo.textContent = `ร vista: ${planoInfoData.valor_a_vista}. Parcelado: ${planoInfoData.valor_parcelado}.`;
ย ย ย sendBtn.disabled = !form.checkValidity(); // Habilita se o resto do formulรกrio for vรกlido
ย ย }
ย }

ย // Monitora alteraรงรตes no campo do Plano (agora editรกvel)
ย planoInput.addEventListener('input', atualizarPlanoInfo);

ย // Evento de CNPJ
ย cnpjInput.addEventListener('input', async () => {
ย ย const cnpj = cnpjInput.value.replace(/\D/g, '');
ย ย if (cnpj.length === 14) {
ย ย ย resultDiv.textContent = 'Buscando dados do CNPJ...';
ย ย ย sendBtn.disabled = true;ย
ย ย ยย
ย ย ย planoInput.value = '';
ย ย ย planoInfo.textContent = '';
ย ย ย sociosSelect.innerHTML = '<option value="">Selecione o sรณcio responsรกvel</option>';

ย ย ย // Limpa dados globais
ย ย ย cnaeGlobal = '';
ย ย ย municipioGlobal = '';
ย ย ย ufGlobal = '';

ย ย ย try {
ย ย ย ย const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
ย ย ย ย const data = await response.json();
ย ย ย ยย
ย ย ย ย if (response.ok) {
ย ย ย ย ย razaoInput.value = data.razao_social || '';
ย ย ย ย ย // Inclui o complemento no endereรงo 
ย ย ย ย ย const complemento = data.complemento ? ` (${data.complemento})` : '';
ย ย ย ย ย enderecoInput.value = `${data.logradouro || ''}, ${data.numero || ''}${complemento}, ${data.bairro || ''} - ${data.municipio || ''}/${data.uf || ''} - CEP: ${data.cep || ''}`;
ย ย ย ย ยย
ย ย ย ย ย // Armazena dados globais
ย ย ย ย ย cnaeGlobal = data.cnae_fiscal;
ย ย ย ย ย municipioGlobal = data.municipio;
ย ย ย ย ย ufGlobal = data.uf;

ย ย ย ย ย const municipioSanitizado = sanitizeCity(municipioGlobal);
ย ย ย ย ยย
ย ย ย ย ย const planoSugerido = segmentar(cnaeGlobal, municipioSanitizado, ufGlobal);
ย ย ย ย ย planoInput.value = planoSugerido || '';
ย ย ย ย ยย
ย ย ย ย ย atualizarPlanoInfo();

ย ย ย ย ย // Carrega os sรณcios
ย ย ย ย ย if (data.qsa && data.qsa.length > 0) {
ย ย ย ย ย ย data.qsa.forEach(socio => {
ย ย ย ย ย ย ย const option = document.createElement('option');
ย ย ย ย ย ย ย option.value = socio.nome_socio;
ย ย ย ย ย ย ย option.textContent = socio.nome_socio;
ย ย ย ย ย ย ย sociosSelect.appendChild(option);
ย ย ย ย ย ย });
ย ย ย ย ย }
ย ย ย ย ย resultDiv.textContent = 'Dados carregados com sucesso.';
ย ย ย ย } else {
ย ย ย ย ย resultDiv.textContent = `โ Erro: CNPJ nรฃo encontrado ou invรกlido.`;
ย ย ย ย ย sendBtn.disabled = true;
ย ย ย ย ย razaoInput.value = '';
ย ย ย ย ย enderecoInput.value = '';
ย ย ย ย }
ย ย ย } catch (error) {
ย ย ย ย resultDiv.textContent = `โ Erro na requisiรงรฃo: ${error.message}. Verifique sua conexรฃo.`;
ย ย ย ย sendBtn.disabled = true;
ย ย ย }
ย ย } else {
ย ย ย resultDiv.textContent = 'Digite 14 dรญgitos do CNPJ para buscar os dados.';
ย ย ย sendBtn.disabled = true;
ย ย }
ย });
ย 
ย // Garante que o botรฃo sรณ habilita se o formulรกrio for vรกlido (incluindo o plano)
ย form.addEventListener('change', () => {
ย ย if (form.checkValidity() && !planoInput.value.includes('Fora') && !planoInput.value.includes('CNAE fora')) {
ย ย ย sendBtn.disabled = false;
ย ย } else {
ย ย ย sendBtn.disabled = true;
ย ย }
ย });


ย // --------------------------------------------------------------------------------
ย // 4. GERAรรO DO PDF (COMPLETO E ORGANIZADO)
ย // --------------------------------------------------------------------------------

ย form.addEventListener("submit", async (ev) => {
ย ย ev.preventDefault();
ย ย resultDiv.textContent = 'Gerando PDF...';

ย ย if (sendBtn.disabled || !form.checkValidity()) {
ย ย ย ย resultDiv.textContent = 'โ Preencha todos os campos obrigatรณrios corretamente e verifique a elegibilidade do CNPJ.';
ย ย ย ย return;
ย ย }

ย ย const dados = {};
ย ย const formData = new FormData(form);
ย ย for (let [key, value] of formData.entries()) {
ย ย ย ย dados[key] = value;
ย ย }

ย ย // Usa os dados globais obtidos na busca do CNPJ
ย ย const cnae_fiscal = cnaeGlobal;
ย ยย
ย ย const { jsPDF } = window.jspdf;
ย ย const pdf = new jsPDF();
ย ย let y = 20;
ย ย const padding = 10;
ย ยย
ย ย // Obter dados de preรงo e plano formatados
ย ย const planoInfoData = getPlanoInfo(dados.plano);

ย ย let valorAnuidade;
ย ย let detalhesPagamento;

ย ย if (dados.forma_pagamento === "ร vista") {
ย ย ย ย valorAnuidade = planoInfoData.valor_a_vista;
ย ย ย ย detalhesPagamento = `Modalidade: ร VISTA`;
ย ย } else {
ย ย ย ย valorAnuidade = planoInfoData.total;
ย ย ย ย detalhesPagamento = `Modalidade: PARCELADO em ${planoInfoData.parcelas}x de ${planoInfoData.valor_parcela}`;
ย ย }

ย ย const associacao = dados.plano && dados.plano.toUpperCase().includes("AESCON") ? "AESCON-SP" : "SESCON-SP";
ย ย const contribuicao = dados.plano === "Plano Ouro Premium" ? "(Inclui Contribuiรงรฃo Representativa) [cite: 30]" : "";


ย ย // =========================================================================
ย ย // CABEรALHO E LOGO
ย ย // =========================================================================
ย ย try {
ย ย ย ย pdf.addImage(SESCON_LOGO_BASE64, 'PNG', 150, 10, 50, 15);
ย ย ย ย y = 30;
ย ย } catch (e) { y = 20; }

ย ย pdf.setFontSize(14);
ย ย pdf.text("FICHA DE INSCRIรรO - ASSOCIAรรO SESCON-SP / AESCON-SP", padding, y);
ย ย y += 15;
ย ยย
ย ย // =========================================================================
ย ย // DADOS DA EMPRESA
ย ย // =========================================================================
ย ย pdf.setFontSize(12);
ย ย pdf.setFont('helvetica', 'bold'); 
ย ย pdf.text("DADOS DA EMPRESA", padding, y);
ย ย pdf.setFont('helvetica', 'normal'); 
ย ย y += 8;
ย ยย
ย ย pdf.setFontSize(10);
ย ย pdf.text(`RAZรO SOCIAL: ${dados.razao ? dados.razao.toUpperCase() : ''}`, padding, y); y += 5;
ย ย pdf.text(`CNPJ: ${dados.cnpj || ''}`, padding, y); y += 5;
ย ย pdf.text(`ENDEREรO COMPLETO: ${dados.endereco ? dados.endereco.toUpperCase() : ''}`, padding, y); y += 5;
ย ย pdf.text(`E-MAIL: ${dados.email ? dados.email.toUpperCase() : ''}`, padding, y); y += 5;
ย ย // Campo Telefone/WhatsApp [cite: 19]
ย ย pdf.text(`TELEFONE/WHATSAPP PRINCIPAL: ${dados.telefone || ''}`, padding, y); y += 5;
ย ย // Campo Contato Preferencial 
ย ย pdf.text(`CONTATO PREFERENCIAL: ${dados.contato_preferencial.toUpperCase()}`, padding, y); y += 5;
ย ย // Campo Segmento 
ย ย pdf.text(`SEGMENTO DE ATUAรรO: ${dados.segmento.toUpperCase()}`, padding, y); y += 5;
ย ย pdf.text(`RAMO DE ATIVIDADE (CNAE): ${cnae_fiscal || 'N/A'}`, padding, y); y += 5;
ย ย // Campo CRC Empresa [cite: 23]
ย ย pdf.text(`EMPRESA POSSUI REGISTRO NO CRC? ${dados.crc_empresa.toUpperCase()}`, padding, y); y += 8;


ย ย // =========================================================================
ย ย // PLANO SUGERIDO E PAGAMENTO - DESTAQUE
ย ย // =========================================================================
ย ย pdf.setFontSize(12);
ย ย pdf.setFont('helvetica', 'bold'); 
ย ย pdf.text("PLANO E VALORES (ANUIDADE PROPORCIONAL)", padding, y);
ย ย pdf.setFont('helvetica', 'normal'); 
ย ย y += 8;
ย ยย
ย ย pdf.setFontSize(10);
ย ย pdf.text(`PLANO: ${dados.plano ? dados.plano.toUpperCase() : ''} ${contribuicao}`, padding, y); y += 5;
ย ย pdf.text(`ASSOCIAรรO: ${associacao}`, padding, y); y += 5;
ย ย pdf.text(`VALOR TOTAL (ANUIDADE PROPORCIONAL): ${valorAnuidade}`, padding, y); y += 5;
ย ย pdf.text(`CONDIรรO DE PAGAMENTO: ${detalhesPagamento}`, padding, y); y += 8;

ย ย // OBSERVAรรES DE ANUIDADE
ย ย pdf.setFontSize(8);
ย ย pdf.text("A anuidade informada refere-se ao valor PROPORCIONAL aos meses restantes do ano corrente.", padding, y); y += 4;
ย ย pdf.text("No prรณximo ciclo de renovaรงรฃo, o valor serรก referente ร anuidade integral.", padding, y); y += 10;
ย ยย
ย ย // =========================================================================
ย ย // SERVIรOS DE INTERESSE
ย ย // =========================================================================
ย ย pdf.setFontSize(12);
ย ย pdf.setFont('helvetica', 'bold'); 
ย ย pdf.text("SERVIรOS DE INTERESSE (PRIORIZAรรO):", padding, y);
ย ย pdf.setFont('helvetica', 'normal'); 
ย ย y += 5;
ย ย pdf.setFontSize(10);
ย ย // Exibe a lista priorizada digitada pelo usuรกrio 
    const servicosPriorizados = dados.servicos_interesse_lista.toUpperCase();
ย ย const splitText = pdf.splitTextToSize(servicosPriorizados, 180); 
ย ย pdf.text(splitText, padding + 5, y); 
ย ย y += splitText.length * 5 + 5; 

ย ยย
ย ย // =========================================================================
ย ย // DADOS DO SรCIO/RODAPร
ย ย // =========================================================================
ย ย pdf.setFontSize(12);
ย ย pdf.setFont('helvetica', 'bold'); 
ย ย pdf.text("DADOS DO SรCIO/RESPONSรVEL PELO PREENCHIMENTO", padding, y);
ย ย pdf.setFont('helvetica', 'normal'); 
ย ย y += 8;
ย ยย
ย ย pdf.setFontSize(10);
ย ย pdf.text(`NOME COMPLETO DO SรCIO: ${dados.nome_socio ? dados.nome_socio.toUpperCase() : ''}`, padding, y); y += 5;
ย ย pdf.text(`CPF DO SรCIO: ${dados.cpf_socio || ''}`, padding, y); y += 5; // CPF agora รฉ obrigatรณrio [cite: 35]
ย ย // Campo CRC Sรณcio [cite: 36]
ย ย pdf.text(`SรCIO POSSUI REGISTRO NO CRC? ${dados.crc_socio.toUpperCase()}`, padding, y); y += 10;

ย ย // Rodapรฉ de Dados
ย ย pdf.text(`EMPRESA: ${dados.razao ? dados.razao.toUpperCase() : ''}`, padding, y); y += 4;
ย ย const dataHora = new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
ย ย pdf.text(`DATA DO PREENCHIMENTO: ${dataHora}`, padding, y); y += 6;
ย ย 
ย ย // OBSERVAรรO DE RESPONSABILIDADE [cite: 37]
ย ย pdf.setFontSize(8);
ย ย pdf.text(`OBSERVAรรO DE RESPONSABILIDADE: Declaro que todas as informaรงรตes prestadas sรฃo de responsabilidade do associado/sรณcio responsรกvel pelo preenchimento, nos termos do estatuto.`, padding, y); 
ย ย y += 10;

ย ย // ASSINATURA
ย ย const signatureImage = canvas.toDataURL("image/png");
ย ย if (signatureImage && signatureImage.length > "data:,".length) {
ย ย ย ย pdf.addImage(signatureImage, 'PNG', padding, y + 5, 100, 30);
ย ย }
ย ย y += 45;
ย ย pdf.text("________________________________", padding, y); y += 6;
ย ย pdf.text("ASSINATURA DO SรCIO DA EMPRESA", padding, y);

ย ย // Geraรงรฃo do arquivo
ย ย const nomeArquivo = `Ficha_Inscricao_${(dados.razao || '').replace(/[^a-zA-Z0-9]/g, '_')}_${dados.cnpj.replace(/\D/g, '')}.pdf`;
ย ย const blob = new Blob([pdf.output('arraybuffer')], { type: 'application/pdf' });
ย ย const url = URL.createObjectURL(blob);
ย ย const link = document.getElementById("downloadLink");
ย ย link.href = url;
ย ย link.download = nomeArquivo;
ย ย link.style.display = "inline-block";
ย ย 
ย ย // Mensagem de sucesso atualizada [cite: 42]
ย ย resultDiv.innerHTML = `
ย ย ย <h3>โ PDF Gerado com Sucesso!</h3>
ย ย ย <p>Obrigado por sua inscriรงรฃo. Emita o PDF e, em breve, vocรช receberรก um e-mail ou WhatsApp com o boleto para pagamento e as credenciais de acesso.</p>
ย ย `;
ย ย link.textContent = `๐ฅ Baixar PDF: ${nomeArquivo}`;ย
ย });

</script>
</body>
</html>
