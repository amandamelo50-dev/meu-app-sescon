<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Ficha de Associa√ß√£o - SESCON</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Ficha de Associa√ß√£o - SESCON</h1>

    <form id="fichaForm">
      <label>CNPJ</label>
      <input type="text" name="cnpj" placeholder="Somente n√∫meros" maxlength="14">

      <label>Raz√£o Social</label>
      <input type="text" name="razao" required disabled>

      <label>Endere√ßo</label>
      <input type="text" name="endereco" disabled>

      <label>E-mail</label>
      <input type="email" name="email" placeholder="contato@empresa.com" required>

      <label>Telefone</label>
      <input type="text" name="telefone" placeholder="(11) 9XXXX-XXXX" required>

      <label>Servi√ßos de Interesse</label>
      <div id="servicos-interesse-container">
      </div>

      <label>Plano Sugerido</label>
      <input type="text" name="plano" disabled>
      <p id="plano-info"></p>

      <label>S√≥cio/Respons√°vel</label>
      <select id="socios-select" name="nome_socio" required>
        <option value="">Selecione o s√≥cio respons√°vel</option>
      </select>

      <label>CPF do S√≥cio</label>
      <input type="text" name="cpf_socio" placeholder="Opcional.">

      <label>Forma de Pagamento</label>
      <select name="forma_pagamento">
        <option value="Parcelado">Parcelado</option>
        <option value="√Ä vista">√Ä vista</option>
      </select>

      <label><input type="checkbox" name="termo_aceite" value="1" required> Declaro estar ciente e de acordo com os termos de associa√ß√£o.</label>

      <h3>Assinatura (use mouse ou touch)</h3>
      <canvas id="signature-pad" width=600 height=200 style="border:1px solid #ccc;"></canvas>
      <div class="sig-buttons">
        <button type="button" id="clearBtn">Limpar Assinatura</button>
      </div>

      <button type="submit" id="sendBtn" disabled>Gerar PDF</button>
    </form>

    <div id="result" style="margin-top:20px;"></div>
    <a id="downloadLink" style="display:none">üì• Baixar PDF</a>
  </div>

<script>
  window.jsPDF = window.jspdf.jsPDF;

  // --------------------------------------------------------------------------------
  // 1. LISTA DE SERVI√áOS (Corrigida e Ordenada Alfabeticamente)
  // --------------------------------------------------------------------------------
  const listaServicos = [
    { id: '343', nome: 'CENTRAL DE SERVI√áOS' },
    { id: '155', nome: 'CERTIFICA√á√ÉO DIGITAL' },
    { id: '347', nome: 'CERTIFICADO DIGITAL GRATUITO' },
    { id: '150', nome: 'BOLSA DE TALENTOS' },
    { id: '156', nome: 'CONT√ÅBIL STORE' },
    { id: '348', nome: 'CONTRIBUI√á√ÉO REPRESENTATIVA' },
    { id: '153', nome: 'CONSULTORIA JUR√çDICA - IOB TELEFONE' },
    { id: '358', nome: 'CONSULTORIA JUR√çDICA - IOB EXPLICA' },
    { id: '151', nome: 'CONVEN√á√ÉO COLETIVA' },
    { id: '166', nome: 'COWORKING' },
    { id: '152', nome: 'CURSOS UNISESCON' },
    { id: '165', nome: 'ENDERE√áO FISCAL' },
    { id: '154', nome: 'ER JUCESP - FATURADO' },
    { id: '161', nome: 'EVENTOS' },
    { id: '149', nome: 'INSTITUCIONAL' },
    { id: '306', nome: 'LOCA√á√ÉO DE AUDIT√ìRIO' },
    { id: '315', nome: 'N√ÉO INFORMADO AINDA' },
    { id: '317', nome: 'PARCERIAS' },
    { id: '157', nome: 'PESQUISAS' },
    { id: '160', nome: 'PQEC' },
    { id: '159', nome: 'PROJETO LGPD' },
    { id: '342', nome: 'RECEITA FEDERAL' },
    { id: '158', nome: 'SOCIET√ÅRIO E LEGAL' },
  ];
  // A ordena√ß√£o √© garantida aqui se a lista n√£o estiver em ordem. Mas a lista j√° foi organizada manualmente acima.

  // --------------------------------------------------------------------------------
  // 2. FUN√á√ÉO PARA GERAR O HTML DA LISTA DE SERVI√áOS
  // --------------------------------------------------------------------------------
  function renderizarServicos() {
    const container = document.getElementById('servicos-interesse-container');
    let htmlContent = '';
    
    listaServicos.forEach(servico => {
      // O valor (value) do checkbox √© padronizado como "IDSERVICO DE INTERESSE - NOME" em MAI√öSCULAS
      const value = `${servico.id}SERVICO DE INTERESSE - ${servico.nome}`;
      
      htmlContent += `<label>
                        <input type="checkbox" name="servicos_interesse" value="${value.toUpperCase()}"> 
                        ${servico.nome}
                      </label>`;
    });

    container.innerHTML = htmlContent;
  }
  // Chamada da fun√ß√£o para exibir a lista assim que o script carregar
  document.addEventListener('DOMContentLoaded', renderizarServicos);


  // --------------------------------------------------------------------------------
  // 3. L√ìGICA DE NEG√ìCIO E FUN√á√ïES
  // --------------------------------------------------------------------------------

  // Fun√ß√£o para remover acentos e caracteres especiais
  function sanitizeCity(city) {
      if (!city) return "";
      return city
          .toLowerCase() // Converte para min√∫sculas
          .normalize("NFD") // Decomp√µe caracteres acentuados
          .replace(/[\u0300-\u036f]/g, "") // Remove os acentos
          .replace(/[^a-z0-9\s]/g, "") // Remove caracteres que n√£o s√£o letras/n√∫meros/espa√ßo
          .trim(); // Remove espa√ßos em branco
  }

  // Listas de CNAEs Eleg√≠veis (Ouro e Prata)
  const cnaes_ouro = new Set(["6920601", "6920602"]);
  const cnaes_prata = new Set([
      "0230600", "5229002", "5229099", "5240101", "5250804", "5250805", "6461100", "6462000", "6463800",
      "6611801", "6611802", "6611803", "6611804", "6612605", "6613400", "6619302", "6619303", "6619399",
      "6621501", "6621502", "6629100", "6630400", "6911702", "6911703", "7020400", "7119701", "7119702",
      "7119703", "7119704", "7120100", "7210000", "7220700", "7319004", "7319002", "7420002", "7420005",
      "7490101", "7490103", "7490104", "7490105", "7490199", "8020000", "8211300", "8219999", "8550302",
      "8599604", "8660700", "9411100", "9412000", "9430800", "9491000", "9499500" ,"8299799","7320300"
  ]);

  // Listas de Cidades com Exclus√£o/Encaminhamento Regional (TODAS SEM ACENTOS)
  const cidades_tupa = new Set(["tupa", "arcoiris", "bastao", "herculandia", "ikanji", "marilia", "pompeia", "queiroz"]);
  const cidades_campinas = new Set(["campinas", "hortolandia", "sumare", "valinhos", "vinhedo", "jaguariuna", "paulinia", "itatiba", "indaiatuba", "amparo", "pedreira", "socorro", "aguas de lindoia", "monte alegre do sul", "serra negra", "holambra", "mogimirim", "mogiguacu", "artur nogueira", "nova odessa", "santa barbara doeste", "americana", "piracicaba", "limeira", "rio claro", "araras", "lemes"]);
  const cidades_santos = new Set(["santos", "sao vicente", "praia grande", "guaruja", "cubatao", "bertioga", "mongagua", "itanhaem", "peruibe", "cananeia", "ilhabela", "caraguatatuba", "ubatuba", "sao sebastiao"]);

  // Pre√ßos (tabelas de valores)
  const prata_pricing = { 1: { total: 720.00, parcelas: 12, valor_parcela: 60.00, a_vista: 660.00 }, 2: { total: 660.00, parcelas: 11, valor_parcela: 60.00, a_vista: 607.00 }, 3: { total: 600.00, parcelas: 10, valor_parcela: 60.00, a_vista: 552.00 }, 4: { total: 540.00, parcelas: 9, valor_parcela: 60.00, a_vista: 497.00 }, 5: { total: 480.00, parcelas: 8, valor_parcela: 60.00, a_vista: 442.00 }, 6: { total: 420.00, parcelas: 7, valor_parcela: 60.00, a_vista: 386.00 }, 7: { total: 360.00, parcelas: 6, valor_parcela: 60.00, a_vista: 331.00 }, 8: { total: 300.00, parcelas: 5, valor_parcela: 60.00, a_vista: 276.00 }, 9: { total: 240.00, parcelas: 4, valor_parcela: 60.00, a_vista: 221.00 }, 10: { total: 180.00, parcelas: 3, valor_parcela: 60.00, a_vista: 166.00 }, 11: { total: 120.00, parcelas: 2, valor_parcela: 60.00, a_vista: 110.00 }, 12: { total: 60.00, parcelas: 1, valor_parcela: 60.00, a_vista: 60.00 } };
  const ouro_premium_pricing = { 1: { total: 1140.00, parcelas: 12, valor_parcela: 95.00, a_vista: 1046.00 }, 2: { total: 1045.00, parcelas: 11, valor_parcela: 95.00, a_vista: 961.00 }, 3: { total: 950.00, parcelas: 10, valor_parcela: 95.00, a_vista: 874.00 }, 4: { total: 855.00, parcelas: 9, valor_parcela: 95.00, a_vista: 787.00 }, 5: { total: 760.00, parcelas: 8, valor_parcela: 95.00, a_vista: 700.00 }, 6: { total: 665.00, parcelas: 7, valor_parcela: 95.00, a_vista: 611.00 }, 7: { total: 570.00, parcelas: 6, valor_parcela: 95.00, a_vista: 524.00 }, 8: { total: 475.00, parcelas: 5, valor_parcela: 95.00, a_vista: 437.00 }, 9: { total: 380.00, parcelas: 4, valor_parcela: 95.00, a_vista: 350.00 }, 10: { total: 285.00, parcelas: 3, valor_parcela: 95.00, a_vista: 263.00 }, 11: { total: 190.00, parcelas: 2, valor_parcela: 95.00, a_vista: 175.00 }, 12: { total: 95.00, parcelas: 1, valor_parcela: 95.00, a_vista: 95.00 } };
  const prata_aescon_pricing = { 1: { total: 420.00, parcelas: 12, valor_parcela: 35.00, a_vista: 386.00 }, 2: { total: 385.00, parcelas: 11, valor_parcela: 35.00, a_vista: 354.00 }, 3: { total: 350.00, parcelas: 10, valor_parcela: 35.00, a_vista: 322.00 }, 4: { total: 315.00, parcelas: 9, valor_parcela: 35.00, a_vista: 290.00 }, 5: { total: 280.00, parcelas: 8, valor_parcela: 35.00, a_vista: 258.00 }, 6: { total: 245.00, parcelas: 7, valor_parcela: 35.00, a_vista: 225.00 }, 7: { total: 210.00, parcelas: 6, valor_parcela: 35.00, a_vista: 193.00 }, 8: { total: 175.00, parcelas: 5, valor_parcela: 35.00, a_vista: 161.00 }, 9: { total: 140.00, parcelas: 4, valor_parcela: 35.00, a_vista: 129.00 }, 10: { total: 105.00, parcelas: 3, valor_parcela: 35.00, a_vista: 97.00 }, 11: { total: 70.00, parcelas: 2, valor_parcela: 35.00, a_vista: 65.00 }, 12: { total: 35.00, parcelas: 1, valor_parcela: 35.00, a_vista: 35.00 } };

  // Fun√ß√µes de Segmenta√ß√£o
  function segmentar(cnae, cidade, uf) {
      // *** CORRE√á√ÉO: Garante que cnae √© uma string (usando String(cnae || '')) antes de tentar .trim() ***
      const cnae_str = String(cnae || '').trim();
      const cidade_limpa = cidade.trim();

      console.log(`[DEBUG] CNAE Recebido: ${cnae_str}`);
      console.log(`[DEBUG] Cidade Recebida Sanitizada: ${cidade_limpa}`);

      // Regra 0: Fora do Estado de SP
      if (uf.toUpperCase() !== "SP") {
          return "Fora de SP ‚Äì N√£o podemos associar.";
      }
      
      // 1. VERIFICA√á√ÉO PRINCIPAL DE CNAE (Ouro, Prata ou Fora de Escopo)
      let planoBase = null;
      if (cnaes_ouro.has(cnae_str)) { 
          planoBase = "Plano Ouro Premium";
      } else if (cnaes_prata.has(cnae_str)) { 
          planoBase = "Plano Prata";
      } else {
          // Se o CNAE n√£o estiver em NENHUMA lista, ele √© fora de escopo.
          return "CNAE fora do escopo. Contate Fecom√©rcio: (11) 3254-1700";
      }

      // 2. EXCE√á√ÉO: CNAE Ouro em cidades regionais vira Prata Aescon
      if (planoBase === "Plano Ouro Premium" && (cidades_tupa.has(cidade_limpa) || cidades_campinas.has(cidade_limpa) || cidades_santos.has(cidade_limpa))) {
          return "Prata Aescon";
      }
      
      // 3. EXCLUS√ÉO REGIONAL: Se a empresa √© eleg√≠vel (Ouro/Prata), mas est√° em uma cidade com conv√™nio local, retorna o contato.
      if (cidades_tupa.has(cidade_limpa)) {
          return "Fora da regi√£o (Tup√£). E-mail: sescontupan@unisite.com.br";
      }
      if (cidades_campinas.has(cidade_limpa)) {
          return "Fora da regi√£o (Campinas). E-mail: sesconcampinas@sesconcampinas.org.br";
      }
      if (cidades_santos.has(cidade_limpa)) {
          return "Fora da regi√£o (Santos). E-mail: sheron@sesconbs.org.br";
      }
      
      // 4. Retorna o plano base se n√£o houver restri√ß√µes regionais (caso da capital 'sao paulo' e outras cidades sem conv√™nio local)
      return planoBase;
  }

  function getPlanoInfo(plano) {
    const mesAtual = new Date().getMonth() + 1;
    let tabela = {};
    if (plano === "Plano Prata") {
        tabela = prata_pricing;
    } else if (plano === "Plano Ouro Premium") {
        tabela = ouro_premium_pricing;
    } else if (plano === "Prata Aescon") {
        tabela = prata_aescon_pricing;
    } else {
        return { valor_a_vista: "N/A", valor_parcelado: "N/A" };
    }
    const valores = tabela[mesAtual] || {};
    const aVista = valores.a_vista ? `R$ ${valores.a_vista.toFixed(2).replace('.', ',')}` : "N/A";
    const parcelas = valores.parcelas;
    const valorParcela = valores.valor_parcela ? `R$ ${valores.valor_parcela.toFixed(2).replace('.', ',')}` : "N/A";
    const valorParcelado = parcelas && valorParcela ? `R$ ${valores.total.toFixed(2).replace('.', ',')} em ${parcelas}x de ${valorParcela}` : "N/A";

    return {
        valor_a_vista: aVista,
        valor_parcelado: valorParcelado,
    };
  }

  // Elementos do DOM
  const cnpjInput = document.querySelector('input[name="cnpj"]');
  const razaoInput = document.querySelector('input[name="razao"]');
  const enderecoInput = document.querySelector('input[name="endereco"]');
  const planoInput = document.querySelector('input[name="plano"]');
  const planoInfo = document.getElementById("plano-info");
  const sociosSelect = document.getElementById("socios-select");
  const sendBtn = document.getElementById("sendBtn");
  const resultDiv = document.getElementById("result");
  const form = document.getElementById("fichaForm");

  // --------------------------------------------------------------------------------
  // 4. L√ìGICA DE ASSINATURA E EVENTOS
  // --------------------------------------------------------------------------------
  const canvas = document.getElementById("signature-pad");
  const ctx = canvas.getContext("2d");
  let drawing = false;
  let lastX = 0, lastY = 0;

  function drawLine(x1, y1, x2, y2) {
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    ctx.closePath();
  }
  canvas.addEventListener("mousedown", (e) => {
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = e.clientX - rect.left;
    lastY = e.clientY - rect.top;
  });
  canvas.addEventListener("mousemove", (e) => {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    drawLine(lastX, lastY, x, y);
    lastX = x;
    lastY = y;
  });
  canvas.addEventListener("mouseup", () => drawing = false);
  canvas.addEventListener("mouseout", () => drawing = false);
  canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    const t = e.touches[0];
    lastX = t.clientX - rect.left;
    lastY = t.clientY - rect.top;
  }, { passive: false });
  canvas.addEventListener("touchmove", (e) => {
    e.preventDefault();
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const t = e.touches[0];
    const x = t.clientX - rect.left;
    const y = t.clientY - rect.top;
    drawLine(lastX, lastY, x, y);
    lastX = x;
    lastY = y;
  }, { passive: false });
  canvas.addEventListener("touchend", () => drawing = false);
  document.getElementById("clearBtn").addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  // Evento de CNPJ
  cnpjInput.addEventListener('input', async () => {
    const cnpj = cnpjInput.value.replace(/\D/g, '');
    if (cnpj.length === 14) {
      resultDiv.textContent = 'Buscando dados do CNPJ...';
      sendBtn.disabled = true; 
      
      // Limpar campos de plano e info para nova busca
      planoInput.value = '';
      planoInfo.textContent = '';
      sociosSelect.innerHTML = '<option value="">Selecione o s√≥cio respons√°vel</option>';

      try {
        const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
        const data = await response.json();
        
        if (response.ok) {
          razaoInput.value = data.razao_social || '';
          enderecoInput.value = `${data.logradouro || ''}, ${data.numero || ''}, ${data.bairro || ''} - ${data.municipio || ''}/${data.uf || ''}`;
          
          const municipioSanitizado = sanitizeCity(data.municipio);
          
          // O cnae_fiscal √© passado para a fun√ß√£o segmentar, onde a corre√ß√£o foi aplicada
          const planoSugerido = segmentar(data.cnae_fiscal, municipioSanitizado, data.uf);
          planoInput.value = planoSugerido || '';
          
          if (planoSugerido && (planoSugerido.includes('Fora') || planoSugerido.includes('CNAE fora'))) {
            planoInfo.innerHTML = `<span style="color:red;font-weight:bold;">${planoSugerido}</span>`;
            sendBtn.disabled = true;
          } else {
            const planoInfoData = getPlanoInfo(planoSugerido);
            planoInfo.textContent = `√Ä vista: ${planoInfoData.valor_a_vista}. Parcelado: ${planoInfoData.valor_parcelado}.`;
            sendBtn.disabled = false; // HABILITA AQUI
          }

          // Carrega os s√≥cios
          if (data.qsa && data.qsa.length > 0) {
            data.qsa.forEach(socio => {
              const option = document.createElement('option');
              option.value = socio.nome_socio;
              option.textContent = socio.nome_socio;
              sociosSelect.appendChild(option);
            });
          }
          resultDiv.textContent = 'Dados carregados com sucesso.';
        } else {
          resultDiv.textContent = `‚ùå Erro: CNPJ n√£o encontrado ou inv√°lido.`;
          sendBtn.disabled = true;
          razaoInput.value = '';
          enderecoInput.value = '';
        }
      } catch (error) {
        resultDiv.textContent = `‚ùå Erro na requisi√ß√£o: ${error.message}. Verifique sua conex√£o.`;
        sendBtn.disabled = true;
      }
    } else {
      resultDiv.textContent = 'Digite 14 d√≠gitos do CNPJ para buscar os dados.';
      sendBtn.disabled = true;
    }
  });

  // Gera√ß√£o do PDF
  form.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    resultDiv.textContent = 'Gerando PDF...';

    if (sendBtn.disabled) {
        resultDiv.textContent = 'Preencha todos os campos obrigat√≥rios e verifique a elegibilidade do CNPJ.';
        return;
    }

    const dados = {};
    const formData = new FormData(form);
    for (let [key, value] of formData.entries()) {
        if (key === 'servicos_interesse') {
            if (!dados[key]) dados[key] = [];
            dados[key].push(value);
        } else {
            dados[key] = value;
        }
    }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    let y = 20;

    // Cabe√ßalho
    pdf.setFontSize(16);
    pdf.text("FICHA DE INSCRI√á√ÉO - ASSOCIA√á√ÉO SESCON-SP / AESCON-SP", 10, y);
    y += 15;

    // Dados da Empresa
    pdf.setFontSize(12);
    pdf.text("DADOS DA EMPRESA", 10, y);
    y += 10;
    pdf.setFontSize(10);
    pdf.text(`RAZ√ÉO SOCIAL: ${dados.razao ? dados.razao.toUpperCase() : ''}`, 10, y); y += 6;
    pdf.text(`CNPJ: ${dados.cnpj || ''}`, 10, y); y += 6;
    pdf.text(`ENDERE√áO: ${dados.endereco ? dados.endereco.toUpperCase() : ''}`, 10, y); y += 6;
    pdf.text(`E-MAIL: ${dados.email ? dados.email.toUpperCase() : ''}`, 10, y); y += 6;
    pdf.text(`TELEFONE: ${dados.telefone || ''}`, 10, y); y += 6;
    // Servi√ßos de Interesse √© um array de strings j√° em MAI√öSCULAS
    pdf.text(`SERVI√áOS DE INTERESSE: ${(dados.servicos_interesse || []).join(', ') || ''}`, 10, y); y += 10;

    // Dados do S√≥cio
    pdf.setFontSize(12);
    pdf.text("DADOS DO S√ìCIO/RESPONS√ÅVEL PELO PREENCHIMENTO", 10, y);
    y += 10;
    pdf.setFontSize(10);
    pdf.text(`NOME COMPLETO: ${dados.nome_socio ? dados.nome_socio.toUpperCase() : ''}`, 10, y); y += 6;
    pdf.text(`CPF DO S√ìCIO: ${dados.cpf_socio || ''}`, 10, y); y += 10;

    // Plano Sugerido
    pdf.setFontSize(12);
    pdf.text("PLANO SUGERIDO", 10, y);
    y += 10;
    pdf.setFontSize(10);
    pdf.text(`PLANO SUGERIDO: ${dados.plano ? dados.plano.toUpperCase() : ''}`, 10, y); y += 6;
    const planoInfoData = getPlanoInfo(dados.plano);
    pdf.text(`VALOR √Ä VISTA: ${planoInfoData.valor_a_vista}`, 10, y); y += 6;
    pdf.text(`VALOR PARCELADO: ${planoInfoData.valor_parcelado}`, 10, y); y += 10;

    // Assinatura
    const signatureImage = canvas.toDataURL("image/png");
    if (signatureImage && signatureImage.length > "data:,".length) {
        pdf.addImage(signatureImage, 'PNG', 10, y, 100, 30);
    }
    y += 40;
    pdf.text("________________________________", 10, y); y += 6;
    pdf.text("ASSINATURA DO S√ìCIO DA EMPRESA", 10, y);

    const blob = new Blob([pdf.output('arraybuffer')], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const link = document.getElementById("downloadLink");
    link.href = url;
    link.download = "ficha_associacao.pdf";
    link.style.display = "inline-block";
    link.textContent = "üì• Baixar PDF gerado";
    resultDiv.textContent = "‚úÖ PDF gerado com sucesso.";
  });

</script>
</body>
</html>
