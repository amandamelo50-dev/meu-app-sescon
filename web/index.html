<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Ficha de Associação - SESCON</title>
  
  <link rel="icon" type="image/png" href="sescon_sp_logo.png.png">

  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Ficha de Associação - SESCON</h1>
    <p style="color:red; font-weight:bold;">ATENÇÃO: Este formulário não está salvo. Utilize a função "Gerar PDF" ao finalizar.</p>

    <form id="fichaForm">
      <label>CNPJ</label>
      <input type="text" name="cnpj" placeholder="Somente números" maxlength="14" required>

      <label>Razão Social</label>
      <input type="text" name="razao" required readonly>

      <label>Endereço Completo</label>
      <input type="text" name="endereco" readonly>

      <label>E-mail</label>
      <input type="email" name="email" placeholder="contato@empresa.com" required>

      <label>Telefone/WhatsApp Principal</label>
      <input type="text" name="telefone" placeholder="(11) 9XXXX-XXXX" required>
      
            <label>Forma de Contato Preferencial</label>
      <select name="contato_preferencial" required>
        <option value="">Selecione</option>
        <option value="WhatsApp">WhatsApp (Telefone Principal)</option>
        <option value="Email">E-mail</option>
      </select>

            <label>Segmento de Atuação da Empresa (Ex: Serviços Contábeis, Jurídicos, etc.)</label>
      <input type="text" name="segmento" placeholder="Ex: Serviços Contábeis" required>

      <label>Plano Sugerido</label>
            <input type="text" name="plano" required>
      <p id="plano-info" style="font-size: 0.9em;"></p>

            <label>A empresa possui registro ativo no CRC?</label>
      <select name="crc_empresa" required>
        <option value="">Selecione</option>
        <option value="Sim">Sim</option>
        <option value="Não">Não</option>
      </select>


      <label>Lista de Serviços (Prioridade)</label>
      <p style="font-size: 0.8em; margin-bottom: 5px;">Digite a prioridade de interesse (1 - 3, por exemplo) para os serviços abaixo, separando por vírgula. Pelo menos um é obrigatório.</p>
      <textarea id="servicos-interesse-lista" name="servicos_interesse_lista" rows="4" placeholder="Exemplo: 1 - CERTIFICAÇÃO DIGITAL, 2 - CURSOS UNISESCON, 3 - PQEC" required></textarea>
      <div id="servicos-interesse-container" style="font-size: 0.8em; border: 1px solid #ccc; padding: 10px; max-height: 150px; overflow-y: scroll;">
              </div>

      <label>Sócio/Responsável</label>
      <select id="socios-select" name="nome_socio" required>
        <option value="">Selecione o sócio responsável</option>
      </select>

      <label>CPF do Sócio</label>
            <input type="text" name="cpf_socio" placeholder="Somente 11 dígitos" required>

            <label>O sócio possui registro ativo no CRC?</label>
      <select name="crc_socio" required>
        <option value="">Selecione</option>
        <option value="Sim">Sim</option>
        <option value="Não">Não</option>
      </select>

      <label>Forma de Pagamento</label>
      <select name="forma_pagamento">
        <option value="Parcelado">Parcelado</option>
        <option value="À vista">À vista</option>
      </select>

      <label>
        <input type="checkbox" name="termo_aceite" value="1" required> 
        Declaro estar ciente e de acordo com os termos de associação. (Link para Termos pendente) 
      </label>
      
      <p style="font-size: 0.8em; color: gray;">
        OBSERVAÇÃO DE RESPONSABILIDADE: Declaro que todas as informações prestadas são de responsabilidade do associado/sócio responsável pelo preenchimento, nos termos do estatuto. [cite: 37]
      </p>

      <h3>Assinatura (use mouse ou touch)</h3>
      <canvas id="signature-pad" width=600 height=200 style="border:1px solid #ccc;"></canvas>
      <div class="sig-buttons">
        <button type="button" id="clearBtn">Limpar Assinatura</button>
      </div>

      <button type="submit" id="sendBtn" disabled>Gerar PDF</button>
    </form>

    <div id="result" style="margin-top:20px;"></div>
    <a id="downloadLink" style="display:none">📥 Baixar PDF</a>
  </div>

<script>
  window.jsPDF = window.jspdf.jsPDF;

  // Dados da imagem do logo em Base64
  const SESCON_LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUsAAABjCAYAAAB2b44XAAAAAXNSR0IArs4c6QAAAK9JREFUeJzt3EEKgDAQRcGrw3Y8vP+5hE2Q2zS6+oD715x/nL9o8Wz9FwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAt+V878E4Jz3nOcfF551mX7XqW93uT/k4Jz9K+dM+Xv92AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIC35Zz1pZ73pXy6L3e7v5Tf8vB/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIBf9vP9h1L5U8qfUt73UfI7zvsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAID3/R16vQMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsG936w5vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADg26f6OwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAd3/vXwMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgt1t5+wMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIB3/fXvAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHC3W3n7AwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgHf99e8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcLdbefsDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP+E1/8HAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC4W3z+EwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAd4l/17sAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADA1/y/Q27xPw/Y7QkAAAAASUVORK5CYII=';

  // --------------------------------------------------------------------------------
  // 1. LISTA DE SERVIÇOS (Ordenada Alfabeticamente, sem "NÃO INFORMADO AINDA" )
  // --------------------------------------------------------------------------------
  const listaServicos = [
    { id: '343', nome: 'CENTRAL DE SERVIÇOS' },
    { id: '155', nome: 'CERTIFICAÇÃO DIGITAL' },
    { id: '347', nome: 'CERTIFICADO DIGITAL GRATUITO' },
    { id: '150', nome: 'BOLSA DE TALENTOS' },
    { id: '156', nome: 'CONTÁBIL STORE' },
    { id: '348', nome: 'CONTRIBUIÇÃO REPRESENTATIVA' },
    { id: '153', nome: 'CONSULTORIA JURÍDICA - IOB TELEFONE' },
    { id: '358', nome: 'CONSULTORIA JURÍDICA - IOB EXPLICA' },
    { id: '151', nome: 'CONVENÇÃO COLETIVA' },
    { id: '166', nome: 'COWORKING' },
    { id: '152', nome: 'CURSOS UNISESCON' },
    { id: '165', nome: 'ENDEREÇO FISCAL' },
    { id: '154', nome: 'ER JUCESP - FATURADO' },
    { id: '161', nome: 'EVENTOS' },
    { id: '149', nome: 'INSTITUCIONAL' },
    { id: '306', nome: 'LOCAÇÃO DE AUDITÓRIO' },
    { id: '317', nome: 'PARCERIAS' },
    { id: '157', nome: 'PESQUISAS' },
    { id: '160', nome: 'PQEC' },
    { id: '159', nome: 'PROJETO LGPD' },
    { id: '342', nome: 'RECEITA FEDERAL' },
    { id: '158', nome: 'SOCIETÁRIO E LEGAL' },
  ];
  
  function renderizarServicosParaReferencia() {
    const container = document.getElementById('servicos-interesse-container');
    let htmlContent = '<strong>Lista de Serviços Disponíveis (para referência e priorização):</strong><br>';
    
    listaServicos.forEach((servico, index) => {
      htmlContent += `${index + 1}. ${servico.nome}<br>`;
    });

    container.innerHTML = htmlContent;
  }
  document.addEventListener('DOMContentLoaded', renderizarServicosParaReferencia);


  // Variáveis para guardar dados do CNPJ para uso no PDF (evita re-busca no submit)
  let cnaeGlobal = '';
  let municipioGlobal = '';
  let ufGlobal = '';


  // --------------------------------------------------------------------------------
  // 2. LÓGICA DE NEGÓCIO (CNAEs, Cidades e Segmentação)
  // --------------------------------------------------------------------------------

  function sanitizeCity(city) {
      if (!city) return "";
      return city
          .toLowerCase() 
          .normalize("NFD") 
          .replace(/[\u0300-\u036f]/g, "") 
          .replace(/[^a-z0-9\s]/g, "") 
          .trim(); 
  }

  // Listas de CNAEs Elegíveis (Ouro e Prata)
  const cnaes_ouro = new Set(["6920601", "6920602"]);
  const cnaes_prata = new Set([
      "0230600", "5229002", "5229099", "5240101", "5250804", "5250805", "6461100", "6462000", "6463800",
      "6611801", "6611802", "6611803", "6611804", "6612605", "6613400", "6619302", "6619303", "6619399",
      "6621501", "6621502", "6629100", "6630400", "6911702", "6911703", "7020400", "7119701", "7119702",
      "7119703", "7119704", "7120100", "7210000", "7220700", "7319004", "7319002", "7420002", "7420005",
      "7490101", "7490103", "7490104", "7490105", "7490199", "8020000", "8211300", "8219999", "8550302",
      "8599604", "8660700", "9411100", "9412000", "9430800", "9491000", "9499500" ,"8299799","7320300"
  ]);

  // Listas de Cidades com Exclusão/Encaminhamento Regional (TODAS SEM ACENTOS)
  const cidades_tupa = new Set(["tupa", "arcoiris", "bastao", "herculandia", "ikanji", "marilia", "pompeia", "queiroz"]);
  const cidades_campinas = new Set(["campinas", "hortolandia", "sumare", "valinhos", "vinhedo", "jaguariuna", "paulinia", "itatiba", "indaiatuba", "amparo", "pedreira", "socorro", "aguas de lindoia", "monte alegre do sul", "serra negra", "holambra", "mogimirim", "mogiguacu", "artur nogueira", "nova odessa", "santa barbara doeste", "americana", "piracicaba", "limeira", "rio claro", "araras", "lemes"]);
  const cidades_santos = new Set(["santos", "sao vicente", "praia grande", "guaruja", "cubatao", "bertioga", "mongagua", "itanhaem", "peruibe", "cananeia", "ilhabela", "caraguatatuba", "ubatuba", "sao sebastiao"]);

  // Preços (tabelas de valores)
  const prata_pricing = { 1: { total: 720.00, parcelas: 12, valor_parcela: 60.00, a_vista: 660.00 }, 2: { total: 660.00, parcelas: 11, valor_parcela: 60.00, a_vista: 607.00 }, 3: { total: 600.00, parcelas: 10, valor_parcela: 60.00, a_vista: 552.00 }, 4: { total: 540.00, parcelas: 9, valor_parcela: 60.00, a_vista: 497.00 }, 5: { total: 480.00, parcelas: 8, valor_parcela: 60.00, a_vista: 442.00 }, 6: { total: 420.00, parcelas: 7, valor_parcela: 60.00, a_vista: 386.00 }, 7: { total: 360.00, parcelas: 6, valor_parcela: 60.00, a_vista: 331.00 }, 8: { total: 300.00, parcelas: 5, valor_parcela: 60.00, a_vista: 276.00 }, 9: { total: 240.00, parcelas: 4, valor_parcela: 60.00, a_vista: 221.00 }, 10: { total: 180.00, parcelas: 3, valor_parcela: 60.00, a_vista: 166.00 }, 11: { total: 120.00, parcelas: 2, valor_parcela: 60.00, a_vista: 110.00 }, 12: { total: 60.00, parcelas: 1, valor_parcela: 60.00, a_vista: 60.00 } };
  const ouro_premium_pricing = { 1: { total: 1140.00, parcelas: 12, valor_parcela: 95.00, a_vista: 1046.00 }, 2: { total: 1045.00, parcelas: 11, valor_parcela: 95.00, a_vista: 961.00 }, 3: { total: 950.00, parcelas: 10, valor_parcela: 95.00, a_vista: 874.00 }, 4: { total: 855.00, parcelas: 9, valor_parcela: 95.00, a_vista: 787.00 }, 5: { total: 760.00, parcelas: 8, valor_parcela: 95.00, a_vista: 700.00 }, 6: { total: 665.00, parcelas: 7, valor_parcela: 95.00, a_vista: 611.00 }, 7: { total: 570.00, parcelas: 6, valor_parcela: 95.00, a_vista: 524.00 }, 8: { total: 475.00, parcelas: 5, valor_parcela: 95.00, a_vista: 437.00 }, 9: { total: 380.00, parcelas: 4, valor_parcela: 95.00, a_vista: 350.00 }, 10: { total: 285.00, parcelas: 3, valor_parcela: 95.00, a_vista: 263.00 }, 11: { total: 190.00, parcelas: 2, valor_parcela: 95.00, a_vista: 175.00 }, 12: { total: 95.00, parcelas: 1, valor_parcela: 95.00, a_vista: 95.00 } };
  const prata_aescon_pricing = { 1: { total: 420.00, parcelas: 12, valor_parcela: 35.00, a_vista: 386.00 }, 2: { total: 385.00, parcelas: 11, valor_parcela: 35.00, a_vista: 354.00 }, 3: { total: 350.00, parcelas: 10, valor_parcela: 35.00, a_vista: 322.00 }, 4: { total: 315.00, parcelas: 9, valor_parcela: 35.00, a_vista: 290.00 }, 5: { total: 280.00, parcelas: 8, valor_parcela: 35.00, a_vista: 258.00 }, 6: { total: 245.00, parcelas: 7, valor_parcela: 35.00, a_vista: 225.00 }, 7: { total: 210.00, parcelas: 6, valor_parcela: 35.00, a_vista: 193.00 }, 8: { total: 175.00, parcelas: 5, valor_parcela: 35.00, a_vista: 161.00 }, 9: { total: 140.00, parcelas: 4, valor_parcela: 35.00, a_vista: 129.00 }, 10: { total: 105.00, parcelas: 3, valor_parcela: 35.00, a_vista: 97.00 }, 11: { total: 70.00, parcelas: 2, valor_parcela: 35.00, a_vista: 65.00 }, 12: { total: 35.00, parcelas: 1, valor_parcela: 35.00, a_vista: 35.00 } };

  // Funções de Segmentação
  function segmentar(cnae, cidade, uf) {
      const cnae_str = String(cnae || '').trim();
      const cidade_limpa = sanitizeCity(cidade); 
      
      if (uf.toUpperCase() !== "SP") {
          return "Fora de SP – Não podemos associar.";
      }
      
      let planoBase = null;
      if (cnaes_ouro.has(cnae_str)) { 
          planoBase = "Plano Ouro Premium";
      } else if (cnaes_prata.has(cnae_str)) { 
          planoBase = "Plano Prata";
      } else {
          return "CNAE fora do escopo. Contate Fecomércio: (11) 3254-1700";
      }

      if (planoBase === "Plano Ouro Premium" && (cidades_tupa.has(cidade_limpa) || cidades_campinas.has(cidade_limpa) || cidades_santos.has(cidade_limpa))) {
          return "Prata Aescon";
      }
      
      if (cidades_tupa.has(cidade_limpa)) {
          return "Fora da região (Tupã). E-mail: sescontupan@unisite.com.br";
      }
      if (cidades_campinas.has(cidade_limpa)) {
          return "Fora da região (Campinas). E-mail: sesconcampinas@sesconcampinas.org.br";
      }
      if (cidades_santos.has(cidade_limpa)) {
          return "Fora da região (Santos). E-mail: sheron@sesconbs.org.br";
      }
      
      return planoBase;
  }

  function getPlanoInfo(plano) {
    const mesAtual = new Date().getMonth() + 1;
    let tabela = {};
    if (plano.includes("Prata")) { // Usa includes para pegar "Plano Prata" e "Prata Aescon"
        tabela = (plano === "Prata Aescon") ? prata_aescon_pricing : prata_pricing;
    } else if (plano.includes("Ouro")) {
        tabela = ouro_premium_pricing;
    } else {
        return { valor_a_vista: "N/A", valor_parcelado: "N/A", total: "N/A", valor_parcela: "N/A", parcelas: "N/A" };
    }

    const valores = tabela[mesAtual] || {};
    
    // Formata para exibição
    const aVista = valores.a_vista ? `R$ ${valores.a_vista.toFixed(2).replace('.', ',')}` : "N/A";
    const valorParcela = valores.valor_parcela ? `R$ ${valores.valor_parcela.toFixed(2).replace('.', ',')}` : "N/A";
    const valorTotalParcelado = valores.total ? `R$ ${valores.total.toFixed(2).replace('.', ',')}` : "N/A";
    const parcelas = valores.parcelas;

    const valorParceladoDisplay = parcelas && valorParcela ? `${parcelas}x de ${valorParcela} (Total: ${valorTotalParcelado})` : "N/A";

    return {
        valor_a_vista: aVista,
        valor_parcelado: valorParceladoDisplay,
        total: valorTotalParcelado, 
        valor_parcela: valorParcela,
        parcelas: parcelas
    };
  }

  // --------------------------------------------------------------------------------
  // 3. EVENTOS (CNPJ e Assinatura)
  // --------------------------------------------------------------------------------

  // Elementos do DOM
  const cnpjInput = document.querySelector('input[name="cnpj"]');
  const razaoInput = document.querySelector('input[name="razao"]');
  const enderecoInput = document.querySelector('input[name="endereco"]');
  const planoInput = document.querySelector('input[name="plano"]');
  const planoInfo = document.getElementById("plano-info");
  const sociosSelect = document.getElementById("socios-select");
  const sendBtn = document.getElementById("sendBtn");
  const resultDiv = document.getElementById("result");
  const form = document.getElementById("fichaForm");
  const canvas = document.getElementById("signature-pad");
  const ctx = canvas.getContext("2d");
  let drawing = false;
  let lastX = 0, lastY = 0;

  // Lógica da Assinatura
  function drawLine(x1, y1, x2, y2) {
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    ctx.closePath();
  }
  canvas.addEventListener("mousedown", (e) => {
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = e.clientX - rect.left;
    lastY = e.clientY - rect.top;
  });
  canvas.addEventListener("mousemove", (e) => {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    drawLine(lastX, lastY, x, y);
    lastX = x;
    lastY = y;
  });
  canvas.addEventListener("mouseup", () => drawing = false);
  canvas.addEventListener("mouseout", () => drawing = false);
  canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    const t = e.touches[0];
    lastX = t.clientX - rect.left;
    lastY = t.clientY - rect.top;
  }, { passive: false });
  canvas.addEventListener("touchmove", (e) => {
    e.preventDefault();
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const t = e.touches[0];
    const x = t.clientX - rect.left;
    const y = t.clientY - rect.top;
    drawLine(lastX, lastY, x, y);
    lastX = x;
    lastY = y;
  }, { passive: false });
  canvas.addEventListener("touchend", () => drawing = false);
  document.getElementById("clearBtn").addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  // Função auxiliar para atualizar a info do plano
  function atualizarPlanoInfo() {
    const planoSugerido = planoInput.value;
    if (!planoSugerido || planoSugerido.includes('Fora') || planoSugerido.includes('CNAE fora')) {
      planoInfo.innerHTML = `<span style="color:red;font-weight:bold;">${planoSugerido || 'N/A'}</span>`;
      sendBtn.disabled = true;
    } else {
      const planoInfoData = getPlanoInfo(planoSugerido);
      planoInfo.textContent = `À vista: ${planoInfoData.valor_a_vista}. Parcelado: ${planoInfoData.valor_parcelado}.`;
      sendBtn.disabled = !form.checkValidity(); // Habilita se o resto do formulário for válido
    }
  }

  // Monitora alterações no campo do Plano (agora editável)
  planoInput.addEventListener('input', atualizarPlanoInfo);

  // Evento de CNPJ
  cnpjInput.addEventListener('input', async () => {
    const cnpj = cnpjInput.value.replace(/\D/g, '');
    if (cnpj.length === 14) {
      resultDiv.textContent = 'Buscando dados do CNPJ...';
      sendBtn.disabled = true; 
      
      planoInput.value = '';
      planoInfo.textContent = '';
      sociosSelect.innerHTML = '<option value="">Selecione o sócio responsável</option>';

      // Limpa dados globais
      cnaeGlobal = '';
      municipioGlobal = '';
      ufGlobal = '';

      try {
        const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
        const data = await response.json();
        
        if (response.ok) {
          razaoInput.value = data.razao_social || '';
          // Inclui o complemento no endereço 
          const complemento = data.complemento ? ` (${data.complemento})` : '';
          enderecoInput.value = `${data.logradouro || ''}, ${data.numero || ''}${complemento}, ${data.bairro || ''} - ${data.municipio || ''}/${data.uf || ''} - CEP: ${data.cep || ''}`;
          
          // Armazena dados globais
          cnaeGlobal = data.cnae_fiscal;
          municipioGlobal = data.municipio;
          ufGlobal = data.uf;

          const municipioSanitizado = sanitizeCity(municipioGlobal);
          
          const planoSugerido = segmentar(cnaeGlobal, municipioSanitizado, ufGlobal);
          planoInput.value = planoSugerido || '';
          
          atualizarPlanoInfo();

          // Carrega os sócios
          if (data.qsa && data.qsa.length > 0) {
            data.qsa.forEach(socio => {
              const option = document.createElement('option');
              option.value = socio.nome_socio;
              option.textContent = socio.nome_socio;
              sociosSelect.appendChild(option);
            });
          }
          resultDiv.textContent = 'Dados carregados com sucesso.';
        } else {
          resultDiv.textContent = `❌ Erro: CNPJ não encontrado ou inválido.`;
          sendBtn.disabled = true;
          razaoInput.value = '';
          enderecoInput.value = '';
        }
      } catch (error) {
        resultDiv.textContent = `❌ Erro na requisição: ${error.message}. Verifique sua conexão.`;
        sendBtn.disabled = true;
      }
    } else {
      resultDiv.textContent = 'Digite 14 dígitos do CNPJ para buscar os dados.';
      sendBtn.disabled = true;
    }
  });
  
  // Garante que o botão só habilita se o formulário for válido (incluindo o plano)
  form.addEventListener('change', () => {
    if (form.checkValidity() && !planoInput.value.includes('Fora') && !planoInput.value.includes('CNAE fora')) {
      sendBtn.disabled = false;
    } else {
      sendBtn.disabled = true;
    }
  });


  // --------------------------------------------------------------------------------
  // 4. GERAÇÃO DO PDF (COMPLETO E ORGANIZADO)
  // --------------------------------------------------------------------------------

  form.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    resultDiv.textContent = 'Gerando PDF...';

    if (sendBtn.disabled || !form.checkValidity()) {
        resultDiv.textContent = '❌ Preencha todos os campos obrigatórios corretamente e verifique a elegibilidade do CNPJ.';
        return;
    }

    const dados = {};
    const formData = new FormData(form);
    for (let [key, value] of formData.entries()) {
        dados[key] = value;
    }

    // Usa os dados globais obtidos na busca do CNPJ
    const cnae_fiscal = cnaeGlobal;
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    let y = 20;
    const padding = 10;
    
    // Obter dados de preço e plano formatados
    const planoInfoData = getPlanoInfo(dados.plano);

    let valorAnuidade;
    let detalhesPagamento;

    if (dados.forma_pagamento === "À vista") {
        valorAnuidade = planoInfoData.valor_a_vista;
        detalhesPagamento = `Modalidade: À VISTA`;
    } else {
        valorAnuidade = planoInfoData.total;
        detalhesPagamento = `Modalidade: PARCELADO em ${planoInfoData.parcelas}x de ${planoInfoData.valor_parcela}`;
    }

    const associacao = dados.plano && dados.plano.toUpperCase().includes("AESCON") ? "AESCON-SP" : "SESCON-SP";
    const contribuicao = dados.plano === "Plano Ouro Premium" ? "(Inclui Contribuição Representativa) [cite: 30]" : "";


    // =========================================================================
    // CABEÇALHO E LOGO
    // =========================================================================
    try {
        pdf.addImage(SESCON_LOGO_BASE64, 'PNG', 150, 10, 50, 15);
        y = 30;
    } catch (e) { y = 20; }

    pdf.setFontSize(14);
    pdf.text("FICHA DE INSCRIÇÃO - ASSOCIAÇÃO SESCON-SP / AESCON-SP", padding, y);
    y += 15;
    
    // =========================================================================
    // DADOS DA EMPRESA
    // =========================================================================
    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'bold'); 
    pdf.text("DADOS DA EMPRESA", padding, y);
    pdf.setFont('helvetica', 'normal'); 
    y += 8;
    
    pdf.setFontSize(10);
    pdf.text(`RAZÃO SOCIAL: ${dados.razao ? dados.razao.toUpperCase() : ''}`, padding, y); y += 5;
    pdf.text(`CNPJ: ${dados.cnpj || ''}`, padding, y); y += 5;
    pdf.text(`ENDEREÇO COMPLETO: ${dados.endereco ? dados.endereco.toUpperCase() : ''}`, padding, y); y += 5;
    pdf.text(`E-MAIL: ${dados.email ? dados.email.toUpperCase() : ''}`, padding, y); y += 5;
    // Campo Telefone/WhatsApp [cite: 19]
    pdf.text(`TELEFONE/WHATSAPP PRINCIPAL: ${dados.telefone || ''}`, padding, y); y += 5;
    // Campo Contato Preferencial 
    pdf.text(`CONTATO PREFERENCIAL: ${dados.contato_preferencial.toUpperCase()}`, padding, y); y += 5;
    // Campo Segmento 
    pdf.text(`SEGMENTO DE ATUAÇÃO: ${dados.segmento.toUpperCase()}`, padding, y); y += 5;
    pdf.text(`RAMO DE ATIVIDADE (CNAE): ${cnae_fiscal || 'N/A'}`, padding, y); y += 5;
    // Campo CRC Empresa [cite: 23]
    pdf.text(`EMPRESA POSSUI REGISTRO NO CRC? ${dados.crc_empresa.toUpperCase()}`, padding, y); y += 8;


    // =========================================================================
    // PLANO SUGERIDO E PAGAMENTO - DESTAQUE
    // =========================================================================
    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'bold'); 
    pdf.text("PLANO E VALORES (ANUIDADE PROPORCIONAL)", padding, y);
    pdf.setFont('helvetica', 'normal'); 
    y += 8;
    
    pdf.setFontSize(10);
    pdf.text(`PLANO: ${dados.plano ? dados.plano.toUpperCase() : ''} ${contribuicao}`, padding, y); y += 5;
    pdf.text(`ASSOCIAÇÃO: ${associacao}`, padding, y); y += 5;
    pdf.text(`VALOR TOTAL (ANUIDADE PROPORCIONAL): ${valorAnuidade}`, padding, y); y += 5;
    pdf.text(`CONDIÇÃO DE PAGAMENTO: ${detalhesPagamento}`, padding, y); y += 8;

    // OBSERVAÇÕES DE ANUIDADE
    pdf.setFontSize(8);
    pdf.text("A anuidade informada refere-se ao valor PROPORCIONAL aos meses restantes do ano corrente.", padding, y); y += 4;
    pdf.text("No próximo ciclo de renovação, o valor será referente à anuidade integral.", padding, y); y += 10;
    
    // =========================================================================
    // SERVIÇOS DE INTERESSE
    // =========================================================================
    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'bold'); 
    pdf.text("SERVIÇOS DE INTERESSE (PRIORIZAÇÃO):", padding, y);
    pdf.setFont('helvetica', 'normal'); 
    y += 5;
    pdf.setFontSize(10);
    // Exibe a lista priorizada digitada pelo usuário 
    const servicosPriorizados = dados.servicos_interesse_lista.toUpperCase();
    const splitText = pdf.splitTextToSize(servicosPriorizados, 180); 
    pdf.text(splitText, padding + 5, y); 
    y += splitText.length * 5 + 5; 

    
    // =========================================================================
    // DADOS DO SÓCIO/RODAPÉ
    // =========================================================================
    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'bold'); 
    pdf.text("DADOS DO SÓCIO/RESPONSÁVEL PELO PREENCHIMENTO", padding, y);
    pdf.setFont('helvetica', 'normal'); 
    y += 8;
    
    pdf.setFontSize(10);
    pdf.text(`NOME COMPLETO DO SÓCIO: ${dados.nome_socio ? dados.nome_socio.toUpperCase() : ''}`, padding, y); y += 5;
    pdf.text(`CPF DO SÓCIO: ${dados.cpf_socio || ''}`, padding, y); y += 5; // CPF agora é obrigatório [cite: 35]
    // Campo CRC Sócio [cite: 36]
    pdf.text(`SÓCIO POSSUI REGISTRO NO CRC? ${dados.crc_socio.toUpperCase()}`, padding, y); y += 10;

    // Rodapé de Dados
    pdf.text(`EMPRESA: ${dados.razao ? dados.razao.toUpperCase() : ''}`, padding, y); y += 4;
    const dataHora = new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    pdf.text(`DATA DO PREENCHIMENTO: ${dataHora}`, padding, y); y += 6;
    
    // OBSERVAÇÃO DE RESPONSABILIDADE [cite: 37]
    pdf.setFontSize(8);
    pdf.text(`OBSERVAÇÃO DE RESPONSABILIDADE: Declaro que todas as informações prestadas são de responsabilidade do associado/sócio responsável pelo preenchimento, nos termos do estatuto.`, padding, y); 
    y += 10;

    // ASSINATURA
    const signatureImage = canvas.toDataURL("image/png");
    if (signatureImage && signatureImage.length > "data:,".length) {
        pdf.addImage(signatureImage, 'PNG', padding, y + 5, 100, 30);
    }
    y += 45;
    pdf.text("________________________________", padding, y); y += 6;
    pdf.text("ASSINATURA DO SÓCIO DA EMPRESA", padding, y);

    // Geração do arquivo
    const nomeArquivo = `Ficha_Inscricao_${(dados.razao || '').replace(/[^a-zA-Z0-9]/g, '_')}_${dados.cnpj.replace(/\D/g, '')}.pdf`;
    const blob = new Blob([pdf.output('arraybuffer')], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const link = document.getElementById("downloadLink");
    link.href = url;
    link.download = nomeArquivo;
    link.style.display = "inline-block";
    
    // Mensagem de sucesso atualizada [cite: 42]
    resultDiv.innerHTML = `
      <h3>✅ PDF Gerado com Sucesso!</h3>
      <p>Obrigado por sua inscrição. Emita o PDF e, em breve, você receberá um e-mail ou WhatsApp com o boleto para pagamento e as credenciais de acesso.</p>
    `;
    link.textContent = `📥 Baixar PDF: ${nomeArquivo}`; 
  });

</script>
</body>
</html>
