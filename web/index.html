<!DOCTYPE html>
<html lang="pt-BR">
<head>
Â  <meta charset="utf-8" />
Â  <title>Ficha de AssociaÃ§Ã£o - SESCON</title>
Â Â 
Â  <link rel="icon" type="image/png" href="sescon_sp_logo.png.png">

Â  <link rel="stylesheet" href="style.css" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
Â  <div class="container">
Â  Â  <h1>Ficha de AssociaÃ§Ã£o - SESCON</h1>

Â  Â  <form id="fichaForm">
Â  Â  Â  <label>CNPJ</label>
Â  Â  Â  <input type="text" name="cnpj" placeholder="Somente nÃºmeros" maxlength="14">

Â  Â  Â  <label>RazÃ£o Social</label>
Â  Â  Â  Â  Â  Â  <input type="text" name="razao" required readonly>

Â  Â  Â  <label>EndereÃ§o</label>
Â  Â  Â  Â  Â  Â  <input type="text" name="endereco" readonly>

Â  Â  Â  <label>E-mail</label>
Â  Â  Â  <input type="email" name="email" placeholder="contato@empresa.com" required>

Â  Â  Â  <label>Telefone</label>
Â  Â  Â  <input type="text" name="telefone" placeholder="(11) 9XXXX-XXXX" required>

Â  Â  Â  <label>ServiÃ§os de Interesse</label>
Â  Â  Â  <div id="servicos-interesse-container">
Â  Â  Â  </div>

Â  Â  Â  <label>Plano Sugerido</label>
Â  Â  Â  Â  Â  Â  <input type="text" name="plano" readonly>
Â  Â  Â  <p id="plano-info"></p>

Â  Â  Â  <label>SÃ³cio/ResponsÃ¡vel</label>
Â  Â  Â  <select id="socios-select" name="nome_socio" required>
Â  Â  Â  Â  <option value="">Selecione o sÃ³cio responsÃ¡vel</option>
Â  Â  Â  </select>

Â  Â  Â  <label>CPF do SÃ³cio</label>
Â  Â  Â  <input type="text" name="cpf_socio" placeholder="Opcional.">

Â  Â  Â  <label>Forma de Pagamento</label>
Â  Â  Â  <select name="forma_pagamento">
Â  Â  Â  Â  <option value="Parcelado">Parcelado</option>
Â  Â  Â  Â  <option value="Ã€ vista">Ã€ vista</option>
Â  Â  Â  </select>

Â  Â  Â  <label><input type="checkbox" name="termo_aceite" value="1" required> Declaro estar ciente e de acordo com os termos de associaÃ§Ã£o.</label>

Â  Â  Â  <h3>Assinatura (use mouse ou touch)</h3>
Â  Â  Â  <canvas id="signature-pad" width=600 height=200 style="border:1px solid #ccc;"></canvas>
Â  Â  Â  <div class="sig-buttons">
Â  Â  Â  Â  <button type="button" id="clearBtn">Limpar Assinatura</button>
Â  Â  Â  </div>

Â  Â  Â  <button type="submit" id="sendBtn" disabled>Gerar PDF</button>
Â  Â  </form>

Â  Â  <div id="result" style="margin-top:20px;"></div>
Â  Â  <a id="downloadLink" style="display:none">ðŸ“¥ Baixar PDF</a>
Â  </div>

<script>
Â  window.jsPDF = window.jspdf.jsPDF;

Â  // Dados da imagem do logo em Base64 (para evitar erros 404/corrompido)
Â  const SESCON_LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUsAAABjCAYAAAB2b44XAAAAAXNSR0IArs4c6QAAAK9JREFUeJzt3EEKgDAQRcGrw3Y8vP+5hE2Q2zS6+oD715x/nL9o8Wz9FwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAt+V878E4Jz3nOcfF551mX7XqW93uT/k4Jz9K+dM+Xv92AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIC35Zz1pZ73pXy6L3e7v5Tf8vB/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIBf9vP9h1L5U8qfUt73UfI7zvsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAID3/R16vQMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsG936w5vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADg26f6OwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAd3/vXwMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgt1t5+wMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIB3/fXvAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHC3W3n7AwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgHf99e8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcLdbefsDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP+E1/8HAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC4W3z+EwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAd4l/17sAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADA1/y/Q27xPw/Y7QkAAAAASUVORK5CYII=';

Â  // --------------------------------------------------------------------------------
Â  // 1. LISTA DE SERVIÃ‡OS (Ordenada Alfabeticamente)
Â  // --------------------------------------------------------------------------------
Â  const listaServicos = [
Â  Â  { id: '343', nome: 'CENTRAL DE SERVIÃ‡OS' },
Â  Â  { id: '155', nome: 'CERTIFICAÃ‡ÃƒO DIGITAL' },
Â  Â  { id: '347', nome: 'CERTIFICADO DIGITAL GRATUITO' },
Â  Â  { id: '150', nome: 'BOLSA DE TALENTOS' },
Â  Â  { id: '156', nome: 'CONTÃBIL STORE' },
Â  Â  { id: '348', nome: 'CONTRIBUIÃ‡ÃƒO REPRESENTATIVA' },
Â  Â  { id: '153', nome: 'CONSULTORIA JURÃDICA - IOB TELEFONE' },
Â  Â  { id: '358', nome: 'CONSULTORIA JURÃDICA - IOB EXPLICA' },
Â  Â  { id: '151', nome: 'CONVENÃ‡ÃƒO COLETIVA' },
Â  Â  { id: '166', nome: 'COWORKING' },
Â  Â  { id: '152', nome: 'CURSOS UNISESCON' },
Â  Â  { id: '165', nome: 'ENDEREÃ‡O FISCAL' },
Â  Â  { id: '154', nome: 'ER JUCESP - FATURADO' },
Â  Â  { id: '161', nome: 'EVENTOS' },
Â  Â  { id: '149', nome: 'INSTITUCIONAL' },
Â  Â  { id: '306', nome: 'LOCAÃ‡ÃƒO DE AUDITÃ“RIO' },
Â  Â  { id: '315', nome: 'NÃƒO INFORMADO AINDA' },
Â  Â  { id: '317', nome: 'PARCERIAS' },
Â  Â  { id: '157', nome: 'PESQUISAS' },
Â  Â  { id: '160', nome: 'PQEC' },
Â  Â  { id: '159', nome: 'PROJETO LGPD' },
Â  Â  { id: '342', nome: 'RECEITA FEDERAL' },
Â  Â  { id: '158', nome: 'SOCIETÃRIO E LEGAL' },
Â  ];
Â Â 
Â  function renderizarServicos() {
Â  Â  const container = document.getElementById('servicos-interesse-container');
Â  Â  let htmlContent = '';
Â  Â Â 
Â  Â  listaServicos.forEach(servico => {
Â  Â  Â  // O valor (value) do checkbox Ã© padronizado como "IDSERVICO DE INTERESSE - NOME" em MAIÃšSCULAS
Â  Â  Â  const value = `${servico.id}SERVICO DE INTERESSE - ${servico.nome}`;
Â  Â  Â Â 
Â  Â  Â  htmlContent += `<label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" name="servicos_interesse" value="${value.toUpperCase()}">Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${servico.nome}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>`;
Â  Â  });

Â  Â  container.innerHTML = htmlContent;
Â  }
Â  document.addEventListener('DOMContentLoaded', renderizarServicos);


Â  // VariÃ¡veis para guardar dados do CNPJ para uso no PDF (evita re-busca no submit)
Â  let cnaeGlobal = '';
Â  let municipioGlobal = '';
Â  let ufGlobal = '';


Â  // --------------------------------------------------------------------------------
Â  // 2. LÃ“GICA DE NEGÃ“CIO (CNAEs, Cidades e SegmentaÃ§Ã£o)
Â  // --------------------------------------------------------------------------------

Â  function sanitizeCity(city) {
Â  Â  Â  if (!city) return "";
Â  Â  Â  return city
Â  Â  Â  Â  Â  .toLowerCase()Â 
Â  Â  Â  Â  Â  .normalize("NFD")Â 
Â  Â  Â  Â  Â  .replace(/[\u0300-\u036f]/g, "")Â 
Â  Â  Â  Â  Â  .replace(/[^a-z0-9\s]/g, "")Â 
Â  Â  Â  Â  Â  .trim();Â 
Â  }

Â  // Listas de CNAEs ElegÃ­veis (Ouro e Prata)
Â  const cnaes_ouro = new Set(["6920601", "6920602"]);
Â  const cnaes_prata = new Set([
Â  Â  Â  "0230600", "5229002", "5229099", "5240101", "5250804", "5250805", "6461100", "6462000", "6463800",
Â  Â  Â  "6611801", "6611802", "6611803", "6611804", "6612605", "6613400", "6619302", "6619303", "6619399",
Â  Â  Â  "6621501", "6621502", "6629100", "6630400", "6911702", "6911703", "7020400", "7119701", "7119702",
Â  Â  Â  "7119703", "7119704", "7120100", "7210000", "7220700", "7319004", "7319002", "7420002", "7420005",
Â  Â  Â  "7490101", "7490103", "7490104", "7490105", "7490199", "8020000", "8211300", "8219999", "8550302",
Â  Â  Â  "8599604", "8660700", "9411100", "9412000", "9430800", "9491000", "9499500" ,"8299799","7320300"
Â  ]);

Â  // Listas de Cidades com ExclusÃ£o/Encaminhamento Regional (TODAS SEM ACENTOS)
Â  const cidades_tupa = new Set(["tupa", "arcoiris", "bastao", "herculandia", "ikanji", "marilia", "pompeia", "queiroz"]);
Â  const cidades_campinas = new Set(["campinas", "hortolandia", "sumare", "valinhos", "vinhedo", "jaguariuna", "paulinia", "itatiba", "indaiatuba", "amparo", "pedreira", "socorro", "aguas de lindoia", "monte alegre do sul", "serra negra", "holambra", "mogimirim", "mogiguacu", "artur nogueira", "nova odessa", "santa barbara doeste", "americana", "piracicaba", "limeira", "rio claro", "araras", "lemes"]);
Â  const cidades_santos = new Set(["santos", "sao vicente", "praia grande", "guaruja", "cubatao", "bertioga", "mongagua", "itanhaem", "peruibe", "cananeia", "ilhabela", "caraguatatuba", "ubatuba", "sao sebastiao"]);

Â  // PreÃ§os (tabelas de valores)
Â  const prata_pricing = { 1: { total: 720.00, parcelas: 12, valor_parcela: 60.00, a_vista: 660.00 }, 2: { total: 660.00, parcelas: 11, valor_parcela: 60.00, a_vista: 607.00 }, 3: { total: 600.00, parcelas: 10, valor_parcela: 60.00, a_vista: 552.00 }, 4: { total: 540.00, parcelas: 9, valor_parcela: 60.00, a_vista: 497.00 }, 5: { total: 480.00, parcelas: 8, valor_parcela: 60.00, a_vista: 442.00 }, 6: { total: 420.00, parcelas: 7, valor_parcela: 60.00, a_vista: 386.00 }, 7: { total: 360.00, parcelas: 6, valor_parcela: 60.00, a_vista: 331.00 }, 8: { total: 300.00, parcelas: 5, valor_parcela: 60.00, a_vista: 276.00 }, 9: { total: 240.00, parcelas: 4, valor_parcela: 60.00, a_vista: 221.00 }, 10: { total: 180.00, parcelas: 3, valor_parcela: 60.00, a_vista: 166.00 }, 11: { total: 120.00, parcelas: 2, valor_parcela: 60.00, a_vista: 110.00 }, 12: { total: 60.00, parcelas: 1, valor_parcela: 60.00, a_vista: 60.00 } };
Â  const ouro_premium_pricing = { 1: { total: 1140.00, parcelas: 12, valor_parcela: 95.00, a_vista: 1046.00 }, 2: { total: 1045.00, parcelas: 11, valor_parcela: 95.00, a_vista: 961.00 }, 3: { total: 950.00, parcelas: 10, valor_parcela: 95.00, a_vista: 874.00 }, 4: { total: 855.00, parcelas: 9, valor_parcela: 95.00, a_vista: 787.00 }, 5: { total: 760.00, parcelas: 8, valor_parcela: 95.00, a_vista: 700.00 }, 6: { total: 665.00, parcelas: 7, valor_parcela: 95.00, a_vista: 611.00 }, 7: { total: 570.00, parcelas: 6, valor_parcela: 95.00, a_vista: 524.00 }, 8: { total: 475.00, parcelas: 5, valor_parcela: 95.00, a_vista: 437.00 }, 9: { total: 380.00, parcelas: 4, valor_parcela: 95.00, a_vista: 350.00 }, 10: { total: 285.00, parcelas: 3, valor_parcela: 95.00, a_vista: 263.00 }, 11: { total: 190.00, parcelas: 2, valor_parcela: 95.00, a_vista: 175.00 }, 12: { total: 95.00, parcelas: 1, valor_parcela: 95.00, a_vista: 95.00 } };
Â  const prata_aescon_pricing = { 1: { total: 420.00, parcelas: 12, valor_parcela: 35.00, a_vista: 386.00 }, 2: { total: 385.00, parcelas: 11, valor_parcela: 35.00, a_vista: 354.00 }, 3: { total: 350.00, parcelas: 10, valor_parcela: 35.00, a_vista: 322.00 }, 4: { total: 315.00, parcelas: 9, valor_parcela: 35.00, a_vista: 290.00 }, 5: { total: 280.00, parcelas: 8, valor_parcela: 35.00, a_vista: 258.00 }, 6: { total: 245.00, parcelas: 7, valor_parcela: 35.00, a_vista: 225.00 }, 7: { total: 210.00, parcelas: 6, valor_parcela: 35.00, a_vista: 193.00 }, 8: { total: 175.00, parcelas: 5, valor_parcela: 35.00, a_vista: 161.00 }, 9: { total: 140.00, parcelas: 4, valor_parcela: 35.00, a_vista: 129.00 }, 10: { total: 105.00, parcelas: 3, valor_parcela: 35.00, a_vista: 97.00 }, 11: { total: 70.00, parcelas: 2, valor_parcela: 35.00, a_vista: 65.00 }, 12: { total: 35.00, parcelas: 1, valor_parcela: 35.00, a_vista: 35.00 } };

Â  // FunÃ§Ãµes de SegmentaÃ§Ã£o
Â  function segmentar(cnae, cidade, uf) {
Â  Â  Â  // Garante que cnae Ã© uma string
Â  Â  Â  const cnae_str = String(cnae || '').trim();
Â  Â  Â  const cidade_limpa = sanitizeCity(cidade); 
Â  Â  Â Â 
Â  Â  Â  // Regra 0: Fora do Estado de SP
Â  Â  Â  if (uf.toUpperCase() !== "SP") {
Â  Â  Â  Â  Â  return "Fora de SP â€“ NÃ£o podemos associar.";
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // 1. VERIFICAÃ‡ÃƒO PRINCIPAL DE CNAE (Ouro, Prata ou Fora de Escopo)
Â  Â  Â  let planoBase = null;
Â  Â  Â  if (cnaes_ouro.has(cnae_str)) {Â 
Â  Â  Â  Â  Â  planoBase = "Plano Ouro Premium";
Â  Â  Â  } else if (cnaes_prata.has(cnae_str)) {Â 
Â  Â  Â  Â  Â  planoBase = "Plano Prata";
Â  Â  Â  } else {
Â  Â  Â  Â  Â  return "CNAE fora do escopo. Contate FecomÃ©rcio: (11) 3254-1700";
Â  Â  Â  }

Â  Â  Â  // 2. EXCEÃ‡ÃƒO: CNAE Ouro em cidades regionais vira Prata Aescon
Â  Â  Â  if (planoBase === "Plano Ouro Premium" && (cidades_tupa.has(cidade_limpa) || cidades_campinas.has(cidade_limpa) || cidades_santos.has(cidade_limpa))) {
Â  Â  Â  Â  Â  return "Prata Aescon";
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // 3. EXCLUSÃƒO REGIONAL
Â  Â  Â  if (cidades_tupa.has(cidade_limpa)) {
Â  Â  Â  Â  Â  return "Fora da regiÃ£o (TupÃ£). E-mail: sescontupan@unisite.com.br";
Â  Â  Â  }
Â  Â  Â  if (cidades_campinas.has(cidade_limpa)) {
Â  Â  Â  Â  Â  return "Fora da regiÃ£o (Campinas). E-mail: sesconcampinas@sesconcampinas.org.br";
Â  Â  Â  }
Â  Â  Â  if (cidades_santos.has(cidade_limpa)) {
Â  Â  Â  Â  Â  return "Fora da regiÃ£o (Santos). E-mail: sheron@sesconbs.org.br";
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // 4. Retorna o plano base
Â  Â  Â  return planoBase;
Â  }

Â  function getPlanoInfo(plano) {
Â  Â  const mesAtual = new Date().getMonth() + 1;
Â  Â  let tabela = {};
Â  Â  if (plano === "Plano Prata") {
Â  Â  Â  Â  tabela = prata_pricing;
Â  Â  } else if (plano === "Plano Ouro Premium") {
Â  Â  Â  Â  tabela = ouro_premium_pricing;
Â  Â  } else if (plano === "Prata Aescon") {
Â  Â  Â  Â  tabela = prata_aescon_pricing;
Â  Â  } else {
Â  Â  Â  Â  return { valor_a_vista: "N/A", valor_parcelado: "N/A", valor_a_vista_raw: "N/A", parcelas: "N/A", valor_parcela: "N/A", total: "N/A" };
Â  Â  }

Â  Â  const valores = tabela[mesAtual] || {};
Â  Â  
Â  Â  // Formata para exibiÃ§Ã£o
Â  Â  const aVista = valores.a_vista ? `R$ ${valores.a_vista.toFixed(2).replace('.', ',')}` : "N/A";
Â  Â  const valorParcela = valores.valor_parcela ? `R$ ${valores.valor_parcela.toFixed(2).replace('.', ',')}` : "N/A";
Â  Â  const valorTotalParcelado = valores.total ? `R$ ${valores.total.toFixed(2).replace('.', ',')}` : "N/A";
Â  Â  const parcelas = valores.parcelas;

Â  Â  const valorParceladoDisplay = parcelas && valorParcela ? `${parcelas}x de ${valorParcela} (Total: ${valorTotalParcelado})` : "N/A";

Â  Â  return {
Â  Â  Â  Â  valor_a_vista: aVista,
Â  Â  Â  Â  valor_parcelado: valorParceladoDisplay,
Â  Â  Â  Â  valor_a_vista_raw: valores.a_vista,
        total: valorTotalParcelado, // Novo campo para facilitar a lÃ³gica do PDF
        valor_parcela: valorParcela,
        parcelas: parcelas
Â  Â  };
Â  }

Â  // --------------------------------------------------------------------------------
Â  // 3. EVENTOS (CNPJ e Assinatura)
Â  // --------------------------------------------------------------------------------

Â  // Elementos do DOM
Â  const cnpjInput = document.querySelector('input[name="cnpj"]');
Â  const razaoInput = document.querySelector('input[name="razao"]');
Â  const enderecoInput = document.querySelector('input[name="endereco"]');
Â  const planoInput = document.querySelector('input[name="plano"]');
Â  const planoInfo = document.getElementById("plano-info");
Â  const sociosSelect = document.getElementById("socios-select");
Â  const sendBtn = document.getElementById("sendBtn");
Â  const resultDiv = document.getElementById("result");
Â  const form = document.getElementById("fichaForm");
Â  const canvas = document.getElementById("signature-pad");
Â  const ctx = canvas.getContext("2d");
Â  let drawing = false;
Â  let lastX = 0, lastY = 0;

Â  function drawLine(x1, y1, x2, y2) {
Â  Â  ctx.strokeStyle = "#000";
Â  Â  ctx.lineWidth = 2;
Â  Â  ctx.lineCap = "round";
Â  Â  ctx.beginPath();
Â  Â  ctx.moveTo(x1, y1);
Â  Â  ctx.lineTo(x2, y2);
Â  Â  ctx.stroke();
Â  Â  ctx.closePath();
Â  }
Â  canvas.addEventListener("mousedown", (e) => {
Â  Â  drawing = true;
Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  lastX = e.clientX - rect.left;
Â  Â  lastY = e.clientY - rect.top;
Â  });
Â  canvas.addEventListener("mousemove", (e) => {
Â  Â  if (!drawing) return;
Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  const x = e.clientX - rect.left;
Â  Â  const y = e.clientY - rect.top;
Â  Â  drawLine(lastX, lastY, x, y);
Â  Â  lastX = x;
Â  Â  lastY = y;
Â  });
Â  canvas.addEventListener("mouseup", () => drawing = false);
Â  canvas.addEventListener("mouseout", () => drawing = false);
Â  canvas.addEventListener("touchstart", (e) => {
Â  Â  e.preventDefault();
Â  Â  drawing = true;
Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  const t = e.touches[0];
Â  Â  lastX = t.clientX - rect.left;
Â  Â  lastY = t.clientY - rect.top;
Â  }, { passive: false });
Â  canvas.addEventListener("touchmove", (e) => {
Â  Â  e.preventDefault();
Â  Â  if (!drawing) return;
Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  const t = e.touches[0];
Â  Â  const x = t.clientX - rect.left;
Â  Â  const y = t.clientY - rect.top;
Â  Â  drawLine(lastX, lastY, x, y);
Â  Â  lastX = x;
Â  Â  lastY = y;
Â  }, { passive: false });
Â  canvas.addEventListener("touchend", () => drawing = false);
Â  document.getElementById("clearBtn").addEventListener("click", () => {
Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);
Â  });

Â  // Evento de CNPJ
Â  cnpjInput.addEventListener('input', async () => {
Â  Â  const cnpj = cnpjInput.value.replace(/\D/g, '');
Â  Â  if (cnpj.length === 14) {
Â  Â  Â  resultDiv.textContent = 'Buscando dados do CNPJ...';
Â  Â  Â  sendBtn.disabled = true;Â 
Â  Â  Â Â 
Â  Â  Â  planoInput.value = '';
Â  Â  Â  planoInfo.textContent = '';
Â  Â  Â  sociosSelect.innerHTML = '<option value="">Selecione o sÃ³cio responsÃ¡vel</option>';

Â  Â  Â  // Limpa dados globais
Â  Â  Â  cnaeGlobal = '';
Â  Â  Â  municipioGlobal = '';
Â  Â  Â  ufGlobal = '';

Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  razaoInput.value = data.razao_social || '';
Â  Â  Â  Â  Â  enderecoInput.value = `${data.logradouro || ''}, ${data.numero || ''}, ${data.bairro || ''} - ${data.municipio || ''}/${data.uf || ''}`;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Armazena dados globais
Â  Â  Â  Â  Â  cnaeGlobal = data.cnae_fiscal;
Â  Â  Â  Â  Â  municipioGlobal = data.municipio;
Â  Â  Â  Â  Â  ufGlobal = data.uf;

Â  Â  Â  Â  Â  const municipioSanitizado = sanitizeCity(municipioGlobal);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const planoSugerido = segmentar(cnaeGlobal, municipioSanitizado, ufGlobal);
Â  Â  Â  Â  Â  planoInput.value = planoSugerido || '';
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (planoSugerido && (planoSugerido.includes('Fora') || planoSugerido.includes('CNAE fora'))) {
Â  Â  Â  Â  Â  Â  planoInfo.innerHTML = `<span style="color:red;font-weight:bold;">${planoSugerido}</span>`;
Â  Â  Â  Â  Â  Â  sendBtn.disabled = true;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const planoInfoData = getPlanoInfo(planoSugerido);
Â  Â  Â  Â  Â  Â  planoInfo.textContent = `Ã€ vista: ${planoInfoData.valor_a_vista}. Parcelado: ${planoInfoData.valor_parcelado}.`;
Â  Â  Â  Â  Â  Â  sendBtn.disabled = false;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // Carrega os sÃ³cios
Â  Â  Â  Â  Â  if (data.qsa && data.qsa.length > 0) {
Â  Â  Â  Â  Â  Â  data.qsa.forEach(socio => {
Â  Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  option.value = socio.nome_socio;
Â  Â  Â  Â  Â  Â  Â  option.textContent = socio.nome_socio;
Â  Â  Â  Â  Â  Â  Â  sociosSelect.appendChild(option);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  resultDiv.textContent = 'Dados carregados com sucesso.';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  resultDiv.textContent = `âŒ Erro: CNPJ nÃ£o encontrado ou invÃ¡lido.`;
Â  Â  Â  Â  Â  sendBtn.disabled = true;
Â  Â  Â  Â  Â  razaoInput.value = '';
Â  Â  Â  Â  Â  enderecoInput.value = '';
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  resultDiv.textContent = `âŒ Erro na requisiÃ§Ã£o: ${error.message}. Verifique sua conexÃ£o.`;
Â  Â  Â  Â  sendBtn.disabled = true;
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  resultDiv.textContent = 'Digite 14 dÃ­gitos do CNPJ para buscar os dados.';
Â  Â  Â  sendBtn.disabled = true;
Â  Â  }
Â  });

Â  // --------------------------------------------------------------------------------
Â  // 4. GERAÃ‡ÃƒO DO PDF (COMPLETO E ORGANIZADO)
Â  // --------------------------------------------------------------------------------

Â  form.addEventListener("submit", async (ev) => {
Â  Â  ev.preventDefault();
Â  Â  resultDiv.textContent = 'Gerando PDF...';

Â  Â  if (sendBtn.disabled) {
Â  Â  Â  Â  resultDiv.textContent = 'Preencha todos os campos obrigatÃ³rios e verifique a elegibilidade do CNPJ.';
Â  Â  Â  Â  return;
Â  Â  }

    // Campos com 'readonly' serÃ£o incluÃ­dos no FormData, solucionando o problema.
Â  Â  const dados = {};
Â  Â  const formData = new FormData(form);
Â  Â  for (let [key, value] of formData.entries()) {
Â  Â  Â  Â  if (key === 'servicos_interesse') {
Â  Â  Â  Â  Â  Â  if (!dados[key]) dados[key] = [];
Â  Â  Â  Â  Â  Â  dados[key].push(value);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  dados[key] = value;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Usa os dados globais obtidos na busca do CNPJ
Â  Â  const cnae_fiscal = cnaeGlobal;
Â  Â Â 
Â  Â  const { jsPDF } = window.jspdf;
Â  Â  const pdf = new jsPDF();
Â  Â  let y = 20;
Â  Â  const padding = 10;
Â  Â Â 
Â  Â  // Obter dados de preÃ§o e plano formatados
Â  Â  const planoInfoData = getPlanoInfo(dados.plano);

Â  Â  let valorAnuidade;
Â  Â  let detalhesPagamento;

Â  Â  if (dados.forma_pagamento === "Ã€ vista") {
Â  Â  Â  Â  valorAnuidade = planoInfoData.valor_a_vista;
Â  Â  Â  Â  detalhesPagamento = `Modalidade: Ã€ VISTA`;
Â  Â  } else {
Â  Â  Â  Â  valorAnuidade = planoInfoData.total;
Â  Â  Â  Â  detalhesPagamento = `Modalidade: PARCELADO em ${planoInfoData.parcelas}x de ${planoInfoData.valor_parcela}`;
Â  Â  }

Â  Â  const associacao = dados.plano && dados.plano.toUpperCase().includes("AESCON") ? "AESCON-SP" : "SESCON-SP";


Â  Â  // =========================================================================
Â  Â  // CABEÃ‡ALHO E LOGO
Â  Â  // =========================================================================
Â  Â  try {
Â  Â  Â  Â  pdf.addImage(SESCON_LOGO_BASE64, 'PNG', 150, 10, 50, 15);
Â  Â  Â  Â  y = 30; // Ajusta o ponto de partida do texto
Â  Â  } catch (e) {
Â  Â  Â  Â  console.warn("Erro ao adicionar imagem ao PDF:", e);
Â  Â  Â  Â  y = 20;
Â  Â  }

Â  Â  pdf.setFontSize(14);
Â  Â  pdf.text("FICHA DE INSCRIÃ‡ÃƒO - ASSOCIAÃ‡ÃƒO SESCON-SP / AESCON-SP", padding, y);
Â  Â  y += 15;
Â  Â Â 
Â  Â  // =========================================================================
Â  Â  // DADOS DA EMPRESA
Â  Â  // =========================================================================
Â  Â  pdf.setFontSize(12);
Â  Â  pdf.setFont('helvetica', 'bold'); 
Â  Â  pdf.text("DADOS DA EMPRESA", padding, y);
Â  Â  pdf.setFont('helvetica', 'normal'); 
Â  Â  y += 8;
Â  Â Â 
Â  Â  pdf.setFontSize(10);
Â  Â  pdf.text(`RAZÃƒO SOCIAL: ${dados.razao ? dados.razao.toUpperCase() : ''}`, padding, y); y += 5;
Â  Â  pdf.text(`CNPJ: ${dados.cnpj || ''}`, padding, y); y += 5;
Â  Â  pdf.text(`ENDEREÃ‡O: ${dados.endereco ? dados.endereco.toUpperCase() : ''}`, padding, y); y += 5;
Â  Â  pdf.text(`E-MAIL: ${dados.email ? dados.email.toUpperCase() : ''}`, padding, y); y += 5;
Â  Â  pdf.text(`TELEFONE: ${dados.telefone || ''}`, padding, y); y += 5;
Â  Â  pdf.text(`RAMO DE ATIVIDADE (CNAE): ${cnae_fiscal || 'N/A'}`, padding, y); y += 8;

Â  Â  // =========================================================================
Â  Â  // PLANO SUGERIDO E PAGAMENTO - DESTAQUE
Â  Â  // =========================================================================
Â  Â  pdf.setFontSize(12);
Â  Â  pdf.setFont('helvetica', 'bold'); 
Â  Â  pdf.text("PLANO E VALORES (ANUIDADE PROPORCIONAL)", padding, y);
Â  Â  pdf.setFont('helvetica', 'normal'); 
Â  Â  y += 8;
Â  Â Â 
Â  Â  pdf.setFontSize(10);
Â  Â  pdf.text(`PLANO: ${dados.plano ? dados.plano.toUpperCase() : ''}`, padding, y); y += 5;
Â  Â  pdf.text(`ASSOCIAÃ‡ÃƒO: ${associacao}`, padding, y); y += 5;
Â  Â  pdf.text(`VALOR TOTAL (ANUIDADE PROPORCIONAL): ${valorAnuidade}`, padding, y); y += 5;
Â  Â  pdf.text(`CONDIÃ‡ÃƒO DE PAGAMENTO: ${detalhesPagamento}`, padding, y); y += 8;

Â  Â  // OBSERVAÃ‡Ã•ES DE ANUIDADE
Â  Â  pdf.setFontSize(8);
Â  Â  pdf.text("A anuidade informada refere-se ao valor PROPORCIONAL aos meses restantes do ano corrente.", padding, y); y += 4;
Â  Â  pdf.text("No prÃ³ximo ciclo de renovaÃ§Ã£o, o valor serÃ¡ referente Ã  anuidade integral.", padding, y); y += 10;
Â  Â Â 
Â  Â  // =========================================================================
Â  Â  // SERVIÃ‡OS DE INTERESSE
Â  Â  // =========================================================================
Â  Â  pdf.setFontSize(12);
Â  Â  pdf.setFont('helvetica', 'bold'); 
Â  Â  pdf.text("SERVIÃ‡OS DE INTERESSE:", padding, y);
Â  Â  pdf.setFont('helvetica', 'normal'); 
Â  Â  y += 5;
Â  Â  pdf.setFontSize(10);
Â  Â  const servicosText = (dados.servicos_interesse || []).map(s => s.split(' - ')[1] || s).join(', ');
Â  Â  // Usamos o text() com quebra de linha automÃ¡tica (maximo 180mm de largura)
    const splitText = pdf.splitTextToSize(servicosText, 180); 
Â  Â  pdf.text(splitText, padding + 5, y); 
    y += splitText.length * 5 + 5; // Ajusta 'y' com base no nÃºmero de linhas

Â  Â Â 
Â  Â  // =========================================================================
Â  Â  // DADOS DO SÃ“CIO/RODAPÃ‰
Â  Â  // =========================================================================
Â  Â  pdf.setFontSize(12);
Â  Â  pdf.setFont('helvetica', 'bold'); 
Â  Â  pdf.text("DADOS DO SÃ“CIO/RESPONSÃVEL PELO PREENCHIMENTO", padding, y);
Â  Â  pdf.setFont('helvetica', 'normal'); 
Â  Â  y += 8;
Â  Â Â 
Â  Â  pdf.setFontSize(10);
Â  Â  pdf.text(`NOME COMPLETO DO SÃ“CIO: ${dados.nome_socio ? dados.nome_socio.toUpperCase() : ''}`, padding, y); y += 5;
Â  Â  pdf.text(`CPF DO SÃ“CIO: ${dados.cpf_socio || ''}`, padding, y); y += 10;

Â  Â  // RodapÃ© de Dados
Â  Â  pdf.text(`EMPRESA: ${dados.razao ? dados.razao.toUpperCase() : ''}`, padding, y); y += 4;
Â  Â  const dataHora = new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
Â  Â  pdf.text(`DATA DO PREENCHIMENTO: ${dataHora}`, padding, y); y += 6;

Â  Â  // ASSINATURA
Â  Â  const signatureImage = canvas.toDataURL("image/png");
Â  Â  if (signatureImage && signatureImage.length > "data:,".length) {
Â  Â  Â  Â  pdf.addImage(signatureImage, 'PNG', padding, y + 5, 100, 30);
Â  Â  }
Â  Â  y += 45;
Â  Â  pdf.text("________________________________", padding, y); y += 6;
Â  Â  pdf.text("ASSINATURA DO SÃ“CIO DA EMPRESA", padding, y);

Â  Â  // GeraÃ§Ã£o do arquivo
Â  Â  const nomeArquivo = `Ficha_Inscricao_${(dados.razao || '').replace(/[^a-zA-Z0-9]/g, '_')}_${dados.cnpj.replace(/\D/g, '')}.pdf`;
Â  Â  const blob = new Blob([pdf.output('arraybuffer')], { type: 'application/pdf' });
Â  Â  const url = URL.createObjectURL(blob);
Â  Â  const link = document.getElementById("downloadLink");
Â  Â  link.href = url;
Â  Â  link.download = nomeArquivo;
Â  Â  link.style.display = "inline-block";
Â  Â  resultDiv.textContent = "âœ… PDF gerado com sucesso.";
Â  Â  link.textContent = `ðŸ“¥ Baixar PDF gerado`;Â 
Â  });

</script>
</body>
</html>
