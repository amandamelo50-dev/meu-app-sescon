<script>
    // Simple signature pad (mouse & touch)
    const canvas = document.getElementById("signature-pad");
    const ctx = canvas.getContext("2d");
    let drawing = false;
    let lastX = 0, lastY = 0;

    // Configura√ß√£o do canvas
    ctx.strokeStyle = "#8B0000";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";

    function drawLine(x1,y1,x2,y2){
        ctx.beginPath();
        ctx.moveTo(x1,y1);
        ctx.lineTo(x2,y2);
        ctx.stroke();
        ctx.closePath();
    }

    // Eventos do mouse
    canvas.addEventListener("mousedown", (e) => {
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    });

    canvas.addEventListener("mousemove", (e) => {
        if(!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        drawLine(lastX,lastY,x,y);
        lastX = x; lastY = y;
    });

    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mouseout", () => drawing = false);

    // Eventos touch para mobile
    canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];
        lastX = t.clientX - rect.left;
        lastY = t.clientY - rect.top;
    }, {passive:false});

    canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        if(!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];
        const x = t.clientX - rect.left;
        const y = t.clientY - rect.top;
        drawLine(lastX,lastY,x,y);
        lastX = x; lastY = y;
    }, {passive:false});

    canvas.addEventListener("touchend", () => drawing = false);

    // Limpar assinatura
    document.getElementById("clearBtn").addEventListener("click", () => {
        ctx.clearRect(0,0,canvas.width,canvas.height);
    });

    // ========== CONSULTA AUTOM√ÅTICA DE CNPJ ==========
    async function consultarCNPJ(cnpj) {
        try {
            const response = await fetch(`https://meu-app-sescon.onrender.com/consultar-cnpj/${cnpj}`);
            if (response.ok) {
                const dados = await response.json();
                
                // Preencher campos automaticamente
                if (dados.razao_social) {
                    document.querySelector('input[name="razao"]').value = dados.razao_social;
                }
                if (dados.endereco) {
                    document.querySelector('input[name="endereco"]').value = dados.endereco;
                }
                
                // Sugerir plano baseado no CNPJ
                await sugerirPlano(cnpj);
                
                console.log('Dados autom√°ticos preenchidos:', dados);
                mostrarMensagem('‚úÖ Dados da empresa preenchidos automaticamente!', 'success');
            }
        } catch (error) {
            console.log('CNPJ n√£o encontrado ou erro na consulta');
            mostrarMensagem('‚ö†Ô∏è CNPJ n√£o encontrado. Preencha os dados manualmente.', 'warning');
        }
    }

    // ========== SUGERIR PLANO AUTOMATICAMENTE ==========
    async function sugerirPlano(cnpj) {
        try {
            const response = await fetch(`https://meu-app-sescon.onrender.com/sugerir-plano/${cnpj}`);
            if (response.ok) {
                const dados = await response.json();
                
                if (dados.plano && !dados.error) {
                    // Selecionar automaticamente o plano sugerido
                    const selectPlano = document.querySelector('select[name="plano"]');
                    const opcoes = Array.from(selectPlano.options);
                    const opcaoSugerida = opcoes.find(opcao => opcao.text.includes(dados.plano));
                    
                    if (opcaoSugerida) {
                        selectPlano.value = opcaoSugerida.value;
                        mostrarMensagem(`üìä Plano sugerido: ${dados.plano}`, 'info');
                        
                        // Calcular valores do plano selecionado
                        await calcularValores(dados.plano);
                    }
                }
            }
        } catch (error) {
            console.log('Erro ao sugerir plano:', error);
        }
    }

    // ========== CALCULAR E EXIBIR VALORES ==========
    async function calcularValores(plano) {
        try {
            const response = await fetch(`https://meu-app-sescon.onrender.com/calcular-valores/${plano}`);
            if (response.ok) {
                const valores = await response.json();
                
                // Criar ou atualizar a se√ß√£o de valores
                let valoresSection = document.getElementById('valores-section');
                if (!valoresSection) {
                    valoresSection = document.createElement('div');
                    valoresSection.id = 'valores-section';
                    valoresSection.innerHTML = `
                        <h2>üí≥ Valores do Plano</h2>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <strong>√Ä Vista:</strong><br>
                                    <span id="valor-a-vista" style="font-size: 1.2em; color: #28a745;"></span>
                                </div>
                                <div>
                                    <strong>Parcelado:</strong><br>
                                    <span id="valor-parcelado" style="font-size: 1.1em; color: #007bff;"></span>
                                </div>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                üí° Valores proporcionais ao m√™s atual
                            </div>
                        </div>
                    `;
                    
                    // Inserir ap√≥s a se√ß√£o de plano
                    const planoSection = document.querySelector('select[name="plano"]').closest('div');
                    planoSection.parentNode.insertBefore(valoresSection, planoSection.nextSibling);
                }
                
                // Atualizar valores
                document.getElementById('valor-a-vista').textContent = valores.a_vista;
                document.getElementById('valor-parcelado').textContent = valores.parcelado;
                
            }
        } catch (error) {
            console.log('Erro ao calcular valores:', error);
        }
    }

    // ========== FUN√á√ÉO PARA MOSTRAR MENSAGENS ==========
    function mostrarMensagem(mensagem, tipo = 'info') {
        // Remover mensagem anterior
        const mensagemAnterior = document.getElementById('mensagem-flutuante');
        if (mensagemAnterior) {
            mensagemAnterior.remove();
        }
        
        const cores = {
            'success': '#28a745',
            'warning': '#ffc107', 
            'error': '#dc3545',
            'info': '#17a2b8'
        };
        
        const mensagemDiv = document.createElement('div');
        mensagemDiv.id = 'mensagem-flutuante';
        mensagemDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${cores[tipo]};
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
        `;
        
        mensagemDiv.textContent = mensagem;
        document.body.appendChild(mensagemDiv);
        
        // Remover ap√≥s 5 segundos
        setTimeout(() => {
            if (mensagemDiv.parentNode) {
                mensagemDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => mensagemDiv.remove(), 300);
            }
        }, 5000);
    }

    // ========== EVENTOS ==========
    
    // Consulta autom√°tica ao sair do campo CNPJ
    document.querySelector('input[name="cnpj"]').addEventListener('blur', function() {
        const cnpj = this.value.replace(/\D/g, '');
        if (cnpj.length === 14) {
            consultarCNPJ(cnpj);
        }
    });

    // Calcular valores quando mudar o plano
    document.querySelector('select[name="plano"]').addEventListener('change', function() {
        calcularValores(this.value);
    });

    // Valida√ß√£o de CNPJ em tempo real
    document.querySelector('input[name="cnpj"]').addEventListener('input', function() {
        let cnpj = this.value.replace(/\D/g, '');
        this.value = cnpj;
    });

    // Valida√ß√£o de CPF em tempo real
    document.querySelector('input[name="cpf_socio"]').addEventListener('input', function() {
        let cpf = this.value.replace(/\D/g, '');
        this.value = cpf;
    });

    // ========== ENVIO DO FORMUL√ÅRIO ==========
    document.getElementById("fichaForm").addEventListener("submit", async (ev) => {
        ev.preventDefault();
        const form = ev.target;
        const sendBtn = document.getElementById("sendBtn");
        const resultDiv = document.getElementById("result");

        // Validar campos obrigat√≥rios
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.style.borderColor = 'red';
                isValid = false;
            } else {
                field.style.borderColor = '';
            }
        });

        if (!isValid) {
            resultDiv.textContent = "‚ùå Preencha todos os campos obrigat√≥rios (*)";
            resultDiv.style.color = "red";
            resultDiv.style.backgroundColor = "#ffe6e6";
            return;
        }

        // Validar assinatura
        const signatureData = canvas.toDataURL();
        if (signatureData === canvas.constructor.prototype.toDataURL.call(canvas)) {
            resultDiv.textContent = "‚ùå Por favor, fa√ßa sua assinatura no campo indicado";
            resultDiv.style.color = "red";
            resultDiv.style.backgroundColor = "#ffe6e6";
            return;
        }

        // Mostrar loading
        sendBtn.textContent = "Gerando PDF...";
        sendBtn.disabled = true;
        resultDiv.textContent = "‚è≥ Gerando sua ficha de associa√ß√£o...";

        const formData = new FormData(form);
        const json = {};
        formData.forEach((v,k) => {
            if(k === "termo_aceite") json[k] = true;
            else json[k] = v;
        });

        // signature as dataURL
        json.signature = signatureData;

        try {
            const resp = await fetch("https://meu-app-sescon.onrender.com/gerar-pdf", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(json)
            });

            if(resp.ok){
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const link = document.getElementById("downloadLink");
                link.href = url;
                link.download = `ficha_associacao_${json.razao.replace(/\s+/g, '_')}.pdf`;
                link.style.display = "block";
                
                resultDiv.textContent = "‚úÖ PDF gerado com sucesso! Clique no link acima para baixar.";
                resultDiv.style.color = "green";
                resultDiv.style.backgroundColor = "#e6ffe6";
                
                mostrarMensagem('‚úÖ Ficha gerada com sucesso!', 'success');
            } else {
                const errorText = await resp.text();
                resultDiv.textContent = "‚ùå Erro ao gerar PDF: " + errorText;
                resultDiv.style.color = "red";
                resultDiv.style.backgroundColor = "#ffe6e6";
                mostrarMensagem('‚ùå Erro ao gerar PDF', 'error');
            }
        } catch (error) {
            resultDiv.textContent = "‚ùå Erro de conex√£o: " + error.message;
            resultDiv.style.color = "red";
            resultDiv.style.backgroundColor = "#ffe6e6";
            mostrarMensagem('‚ùå Erro de conex√£o', 'error');
        } finally {
            sendBtn.textContent = "Gerar PDF da Ficha";
            sendBtn.disabled = false;
        }
    });

    // ========== ANIMA√á√ïES CSS ==========
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
</script>
